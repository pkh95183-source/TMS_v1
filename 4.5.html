<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PM Workbench ¬∑ Í¥ÄÎ¶¨ÎπÑ</title>
<style>
/* base */
.nav-list{list-style:none;margin:8px 0 0 0;padding:0;}
.nav-list li{margin:4px 0;}
.nav-list a{display:block;padding:6px 10px;border-radius:8px;text-decoration:none;line-height:1.3;}

/* --- AMI click affordances (safe) --- */
#ui-pm-work .kpi { cursor: pointer; }
#ui-pm-work .ami-table tbody tr { cursor: pointer; }


#MTR-102 #m102-tb.flash tr { animation: m102row .5s ease-in-out; }
@keyframes m102row { from { background:#fff8e1; } to { background:transparent; } }


/* global fallback to ensure modal always visible even if appended to body */
.overlay{position:fixed;inset:0;background:rgba(15,23,42,.42);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal{width:min(720px,92vw);max-height:78vh;overflow:auto;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.25);border:1px solid #e8edf4}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #e8edf4}
.modal .body{padding:12px 14px}
.modal .foot{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid #e8edf4}


/* Button text visibility & sizing fix (scoped) */
#MTR-102 .toolbar .btn,
#MTR-102 .btn:not(.primary){
  display:inline-flex !important;
  align-items:center !important;
  justify-content:center !important;
  min-width:110px !important;
  color:#111 !important;
  text-indent:0 !important;
  letter-spacing:0 !important;
  background:#fff !important;
  border:1px solid #e8edf4 !important;
  box-shadow:none !important;
}
#MTR-102 .btn.primary{ color:#fff !important; }


#MTR-102 .panel-logs{border:1px solid #e8edf4;border-radius:14px;background:#fff;box-shadow:0 1px 2px rgba(12,17,29,.06);overflow:hidden}
#MTR-102 .panel-logs header{padding:10px 12px;border-bottom:1px solid #e8edf4;font-weight:700;font-size:13px;background:#f8fafc}
#MTR-102 .panel-logs .logbox{max-height:220px;overflow:auto;padding:8px}


/* Strong button visibility overrides */
#MTR-102 .toolbar .btn,
#MTR-102 .btn:not(.primary){
  display:inline-flex !important;
  align-items:center !important;
  justify-content:center !important;
  min-width:112px !important;
  height:32px !important;
  color:#111 !important;
  background:#fff !important;
  border:1px solid #e8edf4 !important;
  text-indent:0 !important;
  letter-spacing:0 !important;
  visibility:visible !important;
  opacity:1 !important;
}
#MTR-102 .toolbar .btn::before{ content:none !important; }
#MTR-102 .in{ color:#111 !important; }


#MTR-102 .panel-logs{border:1px solid #e8edf4;border-radius:14px;background:#fff;box-shadow:0 1px 2px rgba(12,17,29,.06);overflow:hidden;margin-top:12px}
#MTR-102 .panel-logs header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #e8edf4;font-weight:700;font-size:13px;line-height:1.2;color:#111;background:#f8fafc}
#MTR-102 .panel-logs .logbox{max-height:220px;overflow:auto;padding:8px}


/* Centered large modal */
#MTR-102 .overlay{position:fixed;inset:0;background:rgba(15,23,42,.42);display:flex;align-items:center;justify-content:center;z-index:9999}
#MTR-102 .overlay .modal{width:min(900px,92vw);max-height:80vh}
.overlay .modal{width:min(900px,92vw);max-height:80vh} /* global fallback */


/* === PATCH v1.6: Align MTR-102 layout to AMI-style === */
.widget#MTR-102{ background:linear-gradient(180deg, var(--card), rgba(255,255,255,.98)); }
#ui-pm-work .mtr-toolbar{
  display:flex;gap:8px;align-items:center;background:linear-gradient(180deg,#fff,#fbfdff);
  padding:10px;border-radius:14px 14px 0 0;border-bottom:1px solid var(--border);
}
#ui-pm-work .mtr-toolbar .in{height:34px;padding:0 12px;border:1px solid var(--border);border-radius:10px;background:#fff;box-shadow:inset 0 1px 0 rgba(255,255,255,.6);font-size:var(--fs-13)}
#ui-pm-work .mtr-toolbar .select{appearance:none;padding-right:28px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%23828ba5' d='M2.3 5.5L8 11.2l5.7-5.7.9.9L8 13 1.4 6.4l.9-.9z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center}

#ui-pm-work .mtr-grid{display:grid;grid-template-columns:1fr;gap:12px;padding:12px}
#ui-pm-work .mtr-logs{display:grid;gap:12px;grid-template-columns:1fr;grid-column:1/-1}
#ui-pm-work .logbox{border:1px solid var(--border);border-radius:12px;background:#fff;min-height:120px;max-height:260px;overflow:auto;padding:8px}
#ui-pm-work .logbox .item{display:flex;gap:8px;align-items:center;padding:6px 4px;border-bottom:1px dashed #eef2f7}
#ui-pm-work .logbox .item:last-child{border-bottom:0}

/* inner spacing alignment */
.widget#MTR-102 .panel{ margin:12px 16px !important; }
.widget#MTR-102 .table-wrap{ padding:0 16px 12px !important; }
.widget#MTR-102 .panel-kpis{ border:0 !important; box-shadow:none !important; background:transparent !important; }
.widget#MTR-102 .panel-kpis .kpi-grid{ padding:12px 16px !important; }

/* PATCH v1.8: MTR-001 calendar right overflow & grid containment */
#ui-pm-work .widget#MTR-001 .mtr-grid{box-sizing:border-box; max-width:100%; overflow:hidden;}
#ui-pm-work .widget#MTR-001 .calendar{box-sizing:border-box; max-width:100%; overflow:hidden;}
#ui-pm-work .widget#MTR-001 .cal-grid{max-width:100%; overflow:hidden;}

/* PATCH v1.8: AMI logs unify with 'Ïù¥Î≤§Ìä∏/Î°úÍ∑∏' */
#ui-pm-work .widget#MTR-101 .event-logs{ display:grid; gap:12px; grid-template-columns:1fr 1fr; grid-column:1/-1; }
@media(max-width:1200px){ #ui-pm-work .widget#MTR-101 .event-logs{ grid-template-columns:1fr; } }
#ui-pm-work .widget#MTR-101 .event-logs .pill-mini{ display:inline-block; background:#f8fafc; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-weight:700; }
#ui-pm-work .widget#MTR-101 .event-logs .logbox{ border:1px solid var(--border); border-radius:12px; background:#fff; min-height:140px; max-height:260px; overflow:auto; padding:8px }
#ui-pm-work .widget#MTR-101 .event-logs .logbox .item{ display:flex; gap:8px; align-items:center; padding:6px 4px; border-bottom:1px dashed #eef2f7 }
#ui-pm-work .widget#MTR-101 .event-logs .logbox .item:last-child{ border-bottom:0 }

/* PATCH v1.8: MTR-102 logs unify with 'Ïù¥Î≤§Ìä∏/Î°úÍ∑∏' */
#ui-pm-work .widget#MTR-102 .event-logs .pill-mini{ display:inline-block; background:#f8fafc; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-weight:700; }
#ui-pm-work .widget#MTR-102 .event-logs .logbox{ border:1px solid var(--border); border-radius:12px; background:#fff; min-height:140px; max-height:260px; overflow:auto; padding:8px }
#ui-pm-work .widget#MTR-102 .event-logs .logbox .item{ display:flex; gap:8px; align-items:center; padding:6px 4px; border-bottom:1px dashed #eef2f7 }
#ui-pm-work .widget#MTR-102 .event-logs .logbox .item:last-child{ border-bottom:0 }

/* PATCH v1.8: MTR-102 toolbar ‚Äì one row responsive, background removed */
#ui-pm-work .widget#MTR-102 .mtr-toolbar{
  display:flex; flex-wrap:wrap; gap:8px 10px; align-items:center;
  background:transparent !important; border-bottom:1px solid var(--border); border-radius:0; padding:10px 16px;
}
#ui-pm-work .widget#MTR-102 .mtr-toolbar .in{ flex:0 1 220px; min-width:140px; height:34px; }
#ui-pm-work .widget#MTR-102 .mtr-toolbar #q.search{ flex:1 1 260px; min-width:200px; }
@media(max-width:1100px){ #ui-pm-work .widget#MTR-102 .mtr-toolbar .in{ flex:1 1 160px; } }
@media(max-width:760px){ #ui-pm-work .widget#MTR-102 .mtr-toolbar .in{ flex:1 1 140px; } }
/* Align paddings like AMI */
#ui-pm-work .widget#MTR-102 header{ padding:14px 16px; border-bottom:1px solid var(--border); }
#ui-pm-work .widget#MTR-102 .kpi-grid{ padding:12px 16px; }
#ui-pm-work .widget#MTR-102 .mtr-grid{ padding:12px; }

/* v1.9: Assign summary overlay under legend (map top-left) */
.widget#MTR-002 .assign-summary-overlay{ margin:8px 0 0 0; display:grid; grid-auto-flow:column; gap:10px; align-items:center; }
@media(max-width:1200px){ .widget#MTR-002 .assign-summary-overlay{ grid-auto-flow:row; gap:6px; } }
.widget#MTR-002 .assign-summary-abs{ position:absolute; left:12px; top:54px; z-index:5; 
  display:grid; grid-auto-flow:column; gap:10px; align-items:center;
  background:rgba(255,255,255,.86); backdrop-filter:saturate(1.2) blur(2px);
  border:1px solid var(--border); border-radius:10px; padding:6px 10px; }

/* v1.9: Event/Logs card container (AMI & Manual) */
.eventlogs-card{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 1px 0 rgba(10,37,64,.04), 0 1px 2px rgba(10,37,64,.08); margin:12px 16px; }
.eventlogs-card .ev-title{ margin:0 0 8px 0; font:800 13px/1 var(--font); }
.event-logs{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media(max-width:1200px){ .event-logs{ grid-template-columns:1fr; } }
.event-logs .logbox{ background:#fbfdff; border:1px solid var(--border); border-radius:12px; min-height:140px; max-height:260px; overflow:auto; padding:8px; }

/* v1.9: MTR-102 toolbar one-line responsive re-assert */
.widget#MTR-102 .mtr-toolbar{
  display:flex; flex-wrap:wrap; gap:8px 10px; align-items:center;
  background:transparent !important; border-bottom:1px solid var(--border); border-radius:0; padding:10px 16px;
}
.widget#MTR-102 .mtr-toolbar .in{ flex:0 1 220px; min-width:140px; height:34px; }
.widget#MTR-102 .mtr-toolbar #q{ flex:1 1 260px; min-width:200px; }
@media(max-width:1100px){ .widget#MTR-102 .mtr-toolbar .in{ flex:1 1 160px; } }
@media(max-width:760px){ .widget#MTR-102 .mtr-toolbar .in{ flex:1 1 140px; } }

/* v1.9: MTR-001 overflow hardening */
.widget#MTR-001 *{ max-width:100%; box-sizing:border-box; }

/* v2.0: Align event/logs card width & gutters with top UI */
.widget#MTR-101 .eventlogs-card,
.widget#MTR-102 .eventlogs-card{ margin:0; grid-column:1/-1; padding:12px; }
</style>

<!-- ===== MAIN THEME / LAYOUT ===== -->
<style>
  /* ==================== DESIGN SYSTEM TOKENS ==================== */
  #ui-pm-work{
    /* Brand */
    --brand-50:#eef7ff; --brand-100:#d9ecff; --brand-200:#bedeff; --brand-300:#95c7ff;
    --brand-400:#67a9ff; --brand-500:#3b82f6; --brand-600:#2563eb; --brand-700:#1d4ed8;
    --brand-800:#1e40af; --brand-900:#162c7a;

    /* Ink */
    --ink-900:#0b1220; --ink-800:#111827; --ink-700:#1f2937; --ink-600:#374151;
    --ink-500:#64748b; --ink-400:#94a3b8; --ink-300:#cbd5e1; --ink-200:#e2e8f0;

    /* Surfaces */
    --bg:#f6f8fb; --card:#ffffff; --muted:#f9fafb; --border:#e8edf4;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --bad:#e11d48;

    /* Effects */
    --glass: rgba(255,255,255,.6);
    --r-2:10px; --r-3:14px; --r-4:18px; --r-pill:999px;
    --sh-1:0 1px 2px rgba(12,17,29,.06), 0 1px 1px rgba(12,17,29,.04);
    --sh-2:0 10px 30px rgba(16,24,40,.10), 0 2px 6px rgba(16,24,40,.06);
    --sh-3:0 24px 60px rgba(13,23,42,.14), inset 0 1px 0 rgba(255,255,255,.25);

    /* Typography */
    --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
    --fs-12: clamp(11.5px, .8vw, 12px);
    --fs-13: clamp(12px, .85vw, 13px);
    --fs-14: clamp(12.5px, .9vw, 14px);
    --fs-15: clamp(13px, 1vw, 15px);
    --fs-16: clamp(14px, 1.05vw, 16px);
    --fs-18: clamp(15px, 1.2vw, 18px);
    --fs-20: clamp(16px, 1.35vw, 20px);

    /* Motion */
    --ease: cubic-bezier(.2,.7,.2,1);
    --dur-1:140ms; --dur-2:220ms; --dur-3:360ms;

    /* NEW: safety overflow guard */
    overflow-x: clip;
  }

  /* ==================== DARK MODE ==================== */
  @media (prefers-color-scheme: dark){
    #ui-pm-work{
      --bg:#0c1220; --card:#0f172a; --muted:#0b152a; --border:#1e293b;
      --ink-900:#f8fafc; --ink-800:#e2e8f0; --ink-700:#cbd5e1; --ink-600:#94a3b8;
      --ink-500:#94a3b8; --ink-400:#a8b3c3; --ink-300:#223047; --ink-200:#1b293f;
      --glass: rgba(13,23,42,.45);
      --sh-1:0 1px 2px rgba(2,6,23,.55), 0 1px 1px rgba(2,6,23,.35);
      --sh-2:0 14px 40px rgba(2,6,23,.55), 0 2px 6px rgba(2,6,23,.45);
      --sh-3:0 26px 70px rgba(2,6,23,.65), inset 0 1px 0 rgba(255,255,255,.05);
    }
  }

  /* ==================== APP LAYOUT ==================== */
  #ui-pm-work.work-wrap{
    max-width:1280px; margin:0 auto; padding:16px 16px 28px; box-sizing:border-box;
    font-family:var(--font); color:var(--ink-900);
    background:
      radial-gradient(900px 280px at 10% -10%, rgba(99,102,241,.05), transparent 60%),
      radial-gradient(1000px 340px at 120% -20%, rgba(56,189,248,.05), transparent 58%),
      var(--bg);
  }
  #ui-pm-work *::-webkit-scrollbar{height:10px;width:10px}
  #ui-pm-work *::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#cbd5e1,#94a3b8);border-radius:10px}
  #ui-pm-work *{scrollbar-color:#94a3b8 transparent}

  /* ==================== HEADBARS ==================== */
  #ui-pm-work .headbars{position:sticky; top:8px; z-index:30; margin:8px 0 12px}
  #ui-pm-work .headbar{
    --top-h:221;
    --top-50:  hsl(var(--top-h),100%,96%);
    --top-100: hsl(var(--top-h),95%,92%);
    --top-600: hsl(var(--top-h),80%,45%);
    --top-700: hsl(var(--top-h),78%,40%);
    display:none; align-items:center; gap:12px; padding:12px 14px; border-radius:var(--r-3);
    background:
      linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.5)),
      radial-gradient(1200px 280px at 10% -20%, var(--top-100), transparent 60%);
    -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
    box-shadow: var(--sh-1); border:1px solid var(--border);
    animation: fadeIn var(--dur-3) var(--ease) both;
  }
  #ui-pm-work .headbar.show{display:flex}
  #ui-pm-work .headbar .logo{
    width:36px; height:36px; border-radius:12px;
    background: conic-gradient(from 220deg, var(--top-700), var(--top-600) 40%, var(--top-100) 85%, var(--top-700));
    box-shadow: 0 8px 18px rgba(29,78,216,.28), inset 0 0 0 1px rgba(255,255,255,.6);
    flex:none;
  }
  #ui-pm-work .headbar h3{margin:0;font:700 var(--fs-16)/1.2 var(--font);letter-spacing:.2px;color:var(--ink-900)}
  #ui-pm-work .headbar .hint{margin-left:auto;font-size:var(--fs-12);color:var(--ink-500)}
  #ui-pm-work .headbar .hint b{color:var(--top-700)}
  #ui-pm-work .headbar .ico{font-size:18px;margin-right:6px}

  /* ==================== KPI GRID ==================== */
  #ui-pm-work .kpi-grid{display:grid; gap:12px; margin:12px 0 16px; grid-template-columns:repeat(2,1fr)}
  @media (min-width:768px){ #ui-pm-work .kpi-grid{grid-template-columns:repeat(6,1fr)} }
  #ui-pm-work .kpi{
    position:relative; padding:14px 14px 12px; border-radius:16px; border:1px solid var(--border);
    background:
      radial-gradient(160px 120px at 92% 10%, rgba(99,102,241,.12), transparent 60%),
      linear-gradient(180deg, var(--card), rgba(255,255,255,.96));
    box-shadow: var(--sh-1); transition: transform var(--dur-2) var(--ease), box-shadow var(--dur-2) var(--ease), border-color var(--dur-2) var(--ease);
    overflow:hidden; isolation:isolate;
  }
  #ui-pm-work .kpi::after{
    content:""; position:absolute; right:-30px; bottom:-38px; width:120px; height:120px; border-radius:30px;
    background: radial-gradient(100% 100% at 100% 0, rgba(99,102,241,.10), transparent 55%);
    filter: blur(0.3px);
  }
  #ui-pm-work .kpi:hover{ transform:translateY(-3px); box-shadow: var(--sh-2); border-color: var(--brand-200); cursor:pointer; }
  #ui-pm-work .kpi:focus-within{outline:3px solid rgba(59,130,246,.35)}
  #ui-pm-work .kpi h5{margin:0 0 8px;color:var(--ink-600);font-size:var(--fs-12);letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  #ui-pm-work .kpi .main{font-weight:800;font-size:clamp(18px,1.45vw,22px);line-height:1.1;color:var(--ink-900);white-space:nowrap;overflow:hidden}
  #ui-pm-work .kpi .main.good{color:var(--ok)} .kpi .main.bad{color:var(--bad)}
  #ui-pm-work .kpi .sub{display:flex;align-items:center;gap:8px;font-size:var(--fs-12)}
  #ui-pm-work .delta{
    display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:var(--r-pill);
    border:1px solid var(--border); background:linear-gradient(180deg,#fff, #f8fafc);
  }
  #ui-pm-work .delta.good{color:var(--ok);border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.07)}
  #ui-pm-work .delta.bad{color:var(--bad);border-color:rgba(225,29,72,.35);background:rgba(225,29,72,.08)}
  #ui-pm-work .delta.neutral{color:var(--ink-500);background:#f8fafc}

  /* ==================== SHELL ==================== */
  #ui-pm-work .pm-shell{display:grid;grid-template-columns:270px 1fr;gap:14px;overflow:visible}
  #ui-pm-work .pm-shell > .vcontent{min-width:0; overflow-x:hidden}
  @media (max-width:1024px){#ui-pm-work .pm-shell{grid-template-columns:1fr}}

  /* ==================== LEFT: 3-LEVEL NAV ==================== */
  #ui-pm-work .side{
    background:
      linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,.72)),
      radial-gradient(800px 380px at -10% -10%, rgba(59,130,246,.06), transparent 60%);
    border:1px solid var(--border); border-radius:16px; box-shadow: var(--sh-1);
    padding:12px; position:sticky; top:10px; align-self:start; max-height:calc(100vh - 28px); overflow:auto;
    transition: box-shadow var(--dur-2) var(--ease);
  }
  #ui-pm-work .side:hover{ box-shadow: var(--sh-2) }
  #ui-pm-work .side .title{font:800 var(--fs-12)/1 var(--font);color:var(--ink-600);margin:6px 2px 10px;letter-spacing:.5px;text-transform:uppercase}

  #ui-pm-work #top-acc{ display:block }
  #ui-pm-work .top-acc{ margin:8px 0 }
  #ui-pm-work .top-acc .top-btn{ margin:6px 0 }
  #ui-pm-work .top-acc .top-group{ margin:6px 0 8px 0; padding-left:4px }

  /* Top buttons */
  #ui-pm-work .top-btn{
    --top-h:221;
    --top-50:  hsl(var(--top-h),100%,96%);
    --top-150: hsl(var(--top-h),92%,88%);
    --top-600: hsl(var(--top-h),80%,45%);
    --top-700: hsl(var(--top-h),78%,40%);
    width:100%; height:48px; padding:0 14px; border-radius:14px; position:relative; overflow:hidden;
    border:1px solid var(--top-150);
    background:linear-gradient(180deg,#fff, var(--top-50));
    color:#0f172a; display:flex; align-items:center; justify-content:space-between; cursor:pointer;
    font-weight:800; font-size:var(--fs-16); letter-spacing:.2px;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.7);
    transition: transform var(--dur-2) var(--ease), border-color var(--dur-2) var(--ease), box-shadow var(--dur-2) var(--ease), background var(--dur-2) var(--ease);
  }
  #ui-pm-work .top-btn .lbl{display:flex;align-items:center;gap:10px}
  #ui-pm-work .top-btn .ico{width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center}
  #ui-pm-work .top-btn:not(.active):hover{
    border-color:hsl(var(--top-h),68%,50%);
    background:linear-gradient(180deg,#fff,hsl(var(--top-h),96%,96%));
    transform:translateY(-1px)
  }
  #ui-pm-work .top-btn.active{
    color:#fff; border-color:var(--top-600);
    background:linear-gradient(180deg,var(--top-600),var(--top-700));
    box-shadow:0 10px 24px hsla(var(--top-h),70%,40%,.32), inset 0 -1px 0 rgba(255,255,255,.22);
  }

  /* Cat / Mid */
  #ui-pm-work .top-group{display:none; animation: fadeSlide var(--dur-3) var(--ease)}
  #ui-pm-work .top-group.show{display:block}
  #ui-pm-work .cat{margin:12px 2px 0}
  #ui-pm-work .cat-btn{
    width:100%; height:36px; padding:0 12px; border-radius:12px; position:relative; overflow:hidden;
    border:1px solid var(--brand-200);
    background:linear-gradient(180deg,#fff,var(--brand-50));
    color:#0f172a; display:flex; align-items:center; justify-content:space-between; cursor:pointer; font-size:var(--fs-13); font-weight:800;
    transition: transform var(--dur-2) var(--ease), border-color var(--dur-2) var(--ease), background var(--dur-2) var(--ease);
  }
  #ui-pm-work .cat-btn:hover{transform:translateX(1px)}
  #ui-pm-work .cat-btn.active{
    background:linear-gradient(180deg,var(--brand-600),var(--brand-700)); color:#fff; border-color:var(--brand-600);
    box-shadow:0 8px 20px rgba(37,99,235,.28), inset 0 -1px 0 rgba(255,255,255,.18)
  }
  #ui-pm-work .mid-group{
    margin:8px 0 6px; padding:6px 0 6px 8px; border-left:2px solid var(--brand-200); display:none;
    animation: fadeSlide var(--dur-3) var(--ease);
  }
  #ui-pm-work .mid-group.show{display:block}
  #ui-pm-work .mid{
    width:100%; text-align:left; height:32px; padding:0 10px; margin:6px 0; border-radius:10px; border:1px solid transparent;
    background:transparent; color:#0f172a; cursor:pointer; font-size:var(--fs-13); position:relative;
    transition: background var(--dur-2) var(--ease), transform var(--dur-2) var(--ease), color var(--dur-2);
  }
  #ui-pm-work .mid:hover{background:#f8fafc; transform:translateX(1px)}
  #ui-pm-work .mid.active{background:linear-gradient(180deg,var(--brand-600),var(--brand-700));color:#fff;border-color:var(--brand-600)}

  /* ==================== CONTENT ==================== */
  #ui-pm-work .vcontent{min-height:440px; overflow-x:hidden}
  #ui-pm-work .vpage{display:none; animation: fadeIn var(--dur-3) var(--ease)}
  #ui-pm-work .vpage.active{display:block}

  /* ==================== WIDGETS / TOOLBARS / TABLES ==================== */
  #ui-pm-work .widget{
    background:linear-gradient(180deg, var(--card), rgba(255,255,255,.98));
    border:1px solid var(--border); border-radius:18px; box-shadow: var(--sh-1); margin-bottom:14px; overflow:hidden;
    max-width:100%;
  }
  #ui-pm-work .widget header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:14px 16px; border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.8), rgba(255,255,255,.65));
    backdrop-filter: blur(4px);
  }
  #ui-pm-work .widget header h4{margin:0;font-size:var(--fs-14);color:var(--ink-900);white-space:nowrap;letter-spacing:.2px}

  /* Ï§ëÎ∂ÑÎ•ò Ìôà Ìó§Îçî */
  #ui-pm-work .cat-home header h4{font-size:clamp(18px,1.6vw,22px); font-weight:800}

  #ui-pm-work .btn{
    height:34px; padding:0 14px; border-radius:12px; position:relative; overflow:hidden; border:1px solid var(--brand-600); cursor:pointer;
    background:linear-gradient(180deg,var(--brand-500),var(--brand-700)); color:#fff; font-weight:700; letter-spacing:.2px;
    box-shadow:0 6px 18px rgba(37,99,235,.28), inset 0 -1px 0 rgba(255,255,255,.2); white-space:nowrap; line-height:32px; font-size:var(--fs-13);
    transition: transform var(--dur-2) var(--ease), box-shadow var(--dur-2) var(--ease), filter var(--dur-2) var(--ease);
  }
  #ui-pm-work .btn.lg{height:40px; line-height:38px; padding:0 18px; font-size:var(--fs-14); border-radius:14px}
  #ui-pm-work .btn:hover{transform:translateY(-1px)}
  #ui-pm-work .btn.gray{border-color:var(--ink-300);background:linear-gradient(180deg,#fff,#f3f6fb);color:var(--ink-700);box-shadow:var(--sh-1)}
  #ui-pm-work .btn.danger{border-color:#dc2626;background:linear-gradient(180deg,#ef4444,#dc2626)}
  #ui-pm-work .btn.stats{border-color:#334155;background:linear-gradient(180deg,#475569,#334155)}

  /* Table */
  #ui-pm-work .table-wrap{max-height:340px;overflow:auto;border-top:1px solid var(--border)}
  #ui-pm-work table{width:100%;border-collapse:separate;border-spacing:0}
  #ui-pm-work thead th{
    position:sticky;top:0;background:linear-gradient(180deg,#fff,#f8fbff);
    border-bottom:1px solid var(--border);font-size:var(--fs-12);text-align:left;padding:10px;z-index:1;white-space:nowrap; color:var(--ink-600)
  }
  #ui-pm-work tbody td{border-bottom:1px solid #eef2f7;font-size:var(--fs-13);padding:10px}
  #ui-pm-work tbody tr:nth-child(2n){background:linear-gradient(180deg,transparent,#fafcff)}
  #ui-pm-work tbody tr:hover{background:linear-gradient(180deg,#fff,#f2f7ff)}
  #ui-pm-work .row-actions{display:flex;gap:6px;flex-wrap:wrap}

  /* Pills */
  #ui-pm-work .pill-mini{
    display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);
    background:linear-gradient(180deg,#fff, #f7fafc);font-size:var(--fs-12);white-space:nowrap
  }
  #ui-pm-work .pill-mini.ok{color:var(--ok);border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.07)}
  #ui-pm-work .pill-mini.warn{color:var(--warn);border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.08)}
  #ui-pm-work .pill-mini.err{color:var(--err);border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08)}
  #ui-pm-work .pill-mini.risk{color:#ef4444;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08)}

  /* ==================== MODALS / CHARTS ==================== */
  #ui-pm-work .stat-modal[hidden]{display:none}
  #ui-pm-work .stat-modal{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(2,6,23,.35); backdrop-filter: blur(3px); z-index:9999;
    animation: fadeIn var(--dur-3) var(--ease);
  }
  #ui-pm-work .stat-card{
    width:min(980px, calc(100vw - 44px)); max-height:82vh; overflow:auto;
    background:linear-gradient(180deg, var(--card), rgba(255,255,255,.98));
    border:1px solid var(--border); border-radius:18px; box-shadow: var(--sh-3);
    transform-origin: 50% 48%; animation: pop var(--dur-3) var(--ease);
  }
  #ui-pm-work .stat-card header{display:flex; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid var(--border)}
  #ui-pm-work .stat-card header h4{margin:0; font-size:var(--fs-15); color:var(--ink-900)}
  #ui-pm-work .stat-card header .hint{margin-left:auto; color:var(--ink-500); font-size:var(--fs-12)}
  #ui-pm-work .stat-close{width:30px; height:30px; border-radius:10px; border:1px solid var(--ink-300); background:#fff; cursor:pointer}
  #ui-pm-work .stat-body{padding:14px}
  #ui-pm-work .chart-wrap{
    width:100%; max-width:380px; margin:0 auto; border:1px solid var(--border); border-radius:14px; padding:10px;
    background:linear-gradient(180deg,#fff,#f9fbff); overflow:hidden
  }
  #ui-pm-work .chart-legend{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; color:var(--ink-500); font-size:var(--fs-12)}
  #ui-pm-work .legend-dot{display:inline-block; width:10px; height:10px; border-radius:999px; margin-right:6px}
  #ui-pm-work .stat-grid{display:grid; grid-template-columns:1fr 400px; gap:14px}
  @media(max-width:940px){#ui-pm-work .stat-grid{grid-template-columns:1fr}}
  #ui-pm-work .stat-aside{border:1px solid var(--border); border-radius:14px; padding:12px; background:linear-gradient(180deg,#fff,#fbfdff)}
  #ui-pm-work .stat-aside h5{margin:0 0 8px; font-size:clamp(18px,1.4vw,20px); color:var(--ink-900)}
  #ui-pm-work .stat-aside .kv{display:flex; justify-content:space-between; font-size:var(--fs-13); padding:9px 0; border-bottom:1px dashed #edf2f8}
  #ui-pm-work .stat-aside .kv:last-child{border-bottom:0}
  #ui-pm-work .stat-aside .kv b{font-size:160%; line-height:1.2}
  .chart-svg{width:100%; height:auto; display:block}

  /* ==================== DASHBOARDS ==================== */
  #ui-pm-work .dash-grid{display:grid; grid-template-columns:2fr 1fr; gap:12px; padding:12px; max-width:100%; overflow:hidden}
  @media(max-width:1000px){#ui-pm-work .dash-grid{grid-template-columns:1fr}}
  #ui-pm-work .cards{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; max-width:100%}
  @media(max-width:1000px){#ui-pm-work .cards{grid-template-columns:repeat(2,1fr)}}

  /* Ï§ëÎ∂ÑÎ•ò Ìôà */
  #ui-pm-work .cat-home .dash-grid{grid-template-columns:1fr}
  #ui-pm-work .cat-home header{padding-bottom:10px;border-bottom:1px solid var(--border)}
  #ui-pm-work .cat-sticky-top{position:sticky; top:12px; z-index:15; padding:4px 0 8px}
  #ui-pm-work .cat-sticky-grid{display:grid; grid-template-columns:1fr; gap:12px; margin:0 12px}
  @media(min-width:860px){#ui-pm-work .cat-sticky-grid{grid-template-columns:1fr 1fr}}
  #ui-pm-work .sticky-card{box-shadow:var(--sh-2)}
  #ui-pm-work .cat-home .cards{grid-template-columns:repeat(2,1fr)}
  @media(min-width:1200px){#ui-pm-work .cat-home .cards{grid-template-columns:repeat(3,1fr)}}

  #ui-pm-work .mini{
    padding:12px;border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#fff,#fbfdff); box-shadow:var(--sh-1);
    transition:box-shadow var(--dur-2) var(--ease), transform var(--dur-2) var(--ease);
    overflow:hidden;
  }
  #ui-pm-work .mini:hover{box-shadow:var(--sh-2); transform:translateY(-1px)}
  #ui-pm-work .mini h6{
    margin:0 0 6px;color:#0f172a;font:700 var(--fs-13)/1 var(--font); letter-spacing:.2px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  #ui-pm-work .list{margin:0;padding:0;list-style:none}
  #ui-pm-work .list li{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eef2f7;font-size:var(--fs-13)}
  #ui-pm-work .list li:last-child{border-bottom:0}

  /* Micro charts */
  #ui-pm-work .micro{height:56px; margin:6px 0 8px; border:1px solid var(--border); border-radius:10px; background:linear-gradient(180deg,#fff,#f9fbff); overflow:hidden}
  #ui-pm-work .micro svg{width:100%; height:100%; display:block}

  /* ===== Ìà¥Î∞î / ÏûÖÎ†• ===== */
  #ui-pm-work .toolbar{
    display:flex; gap:8px; align-items:center; padding:10px 12px;
    background:linear-gradient(180deg,var(--muted),#fff); border-bottom:1px solid var(--border);
    position:sticky; top:0; z-index:5;
  }
  #ui-pm-work .toolbar .in{
    height:34px; padding:0 12px; border-radius:12px; border:1px solid var(--border);
    background:linear-gradient(180deg,#fff,#f8fafc); box-shadow:inset 0 1px 0 rgba(255,255,255,.6);
    font-size:var(--fs-13);
  }
  #ui-pm-work .toolbar .in:focus{
    outline:none; border-color:var(--brand-300);
    box-shadow:0 0 0 3px rgba(59,130,246,.18);
  }
  #ui-pm-work .toolbar .search{flex:1 1 260px; min-width:160px}
  #ui-pm-work .toolbar .date{width:160px}
  #ui-pm-work .toolbar .select{width:120px; appearance:none; padding-right:28px;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M3.2 5.5L8 10.3l4.8-4.8.9.9L8 12 2.3 6.4l.9-.9z'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:right 8px center;
  }

  /* ===== Î©îÏã†Ï†Ä UI ===== */
  #ui-pm-work .messenger{border:1px solid var(--border); border-radius:12px; padding:10px; background:linear-gradient(180deg,#fff,#fbfdff); font-size:var(--fs-12)}
  #ui-pm-work .messenger .msgs{max-height:150px; overflow:auto; margin-bottom:8px; font-size:var(--fs-12)}
  #ui-pm-work .messenger .msg{display:flex; gap:8px; align-items:flex-start; padding:6px 4px; border-bottom:1px dashed #eef2f7; font-size:var(--fs-12)}
  #ui-pm-work .messenger .msg:last-child{border-bottom:0}
  #ui-pm-work .messenger .msg b{font-weight:800; font-size:var(--fs-12)}
  #ui-pm-work .messenger .msg time{margin-left:auto; font-size:var(--fs-12); color:var(--ink-500)}
  #ui-pm-work .messenger .msg-form{display:flex; gap:8px}
  #ui-pm-work .messenger .msg-input{flex:1; height:32px; border-radius:12px; border:1px solid var(--border); padding:0 10px; font-size:var(--fs-12); background:linear-gradient(180deg,#fff,#f8fafc)}
  #ui-pm-work .mini.messenger-card .msgs{max-height:200px}

  /* ==================== ANIMATIONS ==================== */
  @keyframes fadeIn{from{opacity:0} to{opacity:1}}
  @keyframes fadeSlide{from{opacity:0; transform:translateY(-6px)} to{opacity:1; transform:none}}
  @keyframes pop{from{transform:scale(.98); opacity:.0} to{transform:scale(1); opacity:1}}

  /* ==================== ACCESSIBILITY ==================== */
  #ui-pm-work :focus-visible{outline:3px solid rgba(59,130,246,.35); outline-offset:2px; border-radius:10px}

  /* ==================== PRINT ==================== */
  @media print{
    #ui-pm-work .side, #ui-pm-work .headbars, #ui-pm-work .toolbar, #ui-pm-work .btn, #ui-pm-work .micro{display:none !important}
    #ui-pm-work .widget{box-shadow:none;border-color:#ccc}
  }

/* ===== MTR-001 (ÏõîÍ∞Ñ Í≤ÄÏπ®ÏùºÏ†ï) specific ===== */
#ui-pm-work .mtr-head-actions .btn + .btn{margin-left:8px}
#ui-pm-work .mtr-toolbar{
  display:flex; gap:8px; align-items:center; padding:10px 12px;
  background:linear-gradient(180deg,var(--muted),#fff); border-bottom:1px solid var(--border);
  position:sticky; top:0; z-index:6;
}
#ui-pm-work .mtr-toolbar .in{height:34px; padding:0 12px; border-radius:12px; border:1px solid var(--border);
  background:linear-gradient(180deg,#fff,#f8fafc); box-shadow:inset 0 1px 0 rgba(255,255,255,.6);
  font-size:var(--fs-13);
}
#ui-pm-work .mtr-toolbar .select{width:130px; appearance:none; padding-right:28px;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M3.2 5.5L8 10.3l4.8-4.8.9.9L8 12 2.3 6.4l.9-.9z'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:right 8px center;
}
#ui-pm-work .mtr-grid{display:grid; grid-template-columns: 360px 1fr; gap:12px; padding:12px}
@media(max-width:1100px){#ui-pm-work .mtr-grid{grid-template-columns:1fr}}
#ui-pm-work .calendar{
  border:1px solid var(--border); border-radius:14px; background:linear-gradient(180deg,#fff,#fbfdff);
  padding:10px; box-shadow:var(--sh-1);
}
#ui-pm-work .cal-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
#ui-pm-work .cal-head h6{margin:0; font:800 var(--fs-14)/1 var(--font)}
#ui-pm-work .cal-nav .btn{height:28px; line-height:26px; padding:0 10px; border-radius:10px; font-size:var(--fs-12)}
#ui-pm-work .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
#ui-pm-work .cal-dow{font-size:var(--fs-12); color:var(--ink-500); text-align:center; padding:4px 0}
#ui-pm-work .cal-day{
  min-height:64px; border:1px solid var(--border); border-radius:10px; padding:6px; background:linear-gradient(180deg,#fff,#f9fbff);
  position:relative; cursor:pointer; transition:transform var(--dur-2) var(--ease), box-shadow var(--dur-2) var(--ease);
}
#ui-pm-work .cal-day:hover{transform:translateY(-1px); box-shadow:var(--sh-2)}
#ui-pm-work .cal-day .d{font-weight:800; font-size:var(--fs-14); color:var(--ink-700)}
#ui-pm-work .cal-day .badges{position:absolute; bottom:6px; left:6px; display:flex; gap:6px; flex-wrap:wrap}
#ui-pm-work .cal-day .badge{font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); background:#fff}
#ui-pm-work .cal-day.selected{outline:3px solid rgba(59,130,246,.35)}
#ui-pm-work .kpi-inline{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
#ui-pm-work .kpi-mini{
  border:1px solid var(--border); border-radius:12px; padding:10px; background:linear-gradient(180deg,#fff,#fbfdff);
  display:flex; align-items:center; justify-content:space-between; box-shadow:var(--sh-1);
}
#ui-pm-work .kpi-mini h6{margin:0; font:800 var(--fs-13)/1 var(--font); color:var(--ink-600)}
#ui-pm-work .kpi-mini b{font-size:clamp(16px,1.2vw,18px); color:var(--ink-900)}
#ui-pm-work .mtr-table .row-actions .btn{height:28px; line-height:26px; font-size:var(--fs-12); padding:0 10px; border-radius:10px}
#ui-pm-work .logbox{border:1px solid var(--border); border-radius:12px; background:linear-gradient(180deg,#fff,#fbfdff); padding:10px; max-height:220px; overflow:auto}
#ui-pm-work .logbox .log{font-size:var(--fs-12); padding:6px 0; border-bottom:1px dashed #eef2f7; display:flex; gap:10px}
#ui-pm-work .logbox .log:last-child{border-bottom:0}
#ui-pm-work .logbox .ts{color:var(--ink-500)}

</style>

<style id="mid-ellipsis-style">
  /* ÏÜåÎ∂ÑÎ•ò(mid) Î≤ÑÌäºÏù¥ Îëê Ï§ÑÎ°ú Ï§ÑÎ∞îÍøàÎêòÏßÄ ÏïäÎèÑÎ°ù Ìïú Ï§Ñ + ÎßêÏ§ÑÏûÑ Ï≤òÎ¶¨ */
  #ui-pm-work .mid-group .mid{
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    display: inline-flex;
    align-items: center;
  }
</style>

<script id="mid-ellipsis-script">
(function(){
  if (window.__MID_ELLIPSIS_APPLIED__) return; 
  window.__MID_ELLIPSIS_APPLIED__ = true;
  function apply(root){
    (root||document).querySelectorAll('#ui-pm-work .mid-group .mid').forEach(function(el){
      var label = (el.getAttribute('aria-label') || el.textContent || '').trim();
      // Í∏¥ ÎùºÎ≤®ÏùÄ Ìà¥ÌåÅÏúºÎ°ú Ï†ÑÏ≤¥ ÎÖ∏Ï∂ú
      try{ el.setAttribute('title', label); el.setAttribute('aria-label', label); }catch(e){}
    });
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ apply(document); });
  } else { apply(document); }
  try{
    new MutationObserver(function(muts){
      for (var i=0;i<muts.length;i++){
        var m = muts[i];
        if (m.addedNodes && m.addedNodes.length){
          for (var j=0;j<m.addedNodes.length;j++){
            var n = m.addedNodes[j];
            if (n.nodeType === 1) apply(n);
          }
        }
      }
    }).observe(document.body, {childList:true, subtree:true});
  }catch(e){}
})();
</script>
</head>
<body>

<!-- ========================= PM Workbench ¬∑ Vertical 3-Level Nav ========================= -->
<div id="ui-pm-work" class="work-wrap" data-theme="auto">

  <!-- ===== Per-Top Headers container ===== -->
  <div class="headbars" id="headbars"></div>

  <!-- ===== KPI Snapshot ===== -->
  <div class="kpi-grid" id="kpis"></div>

  <!-- ===== 3-Level + Content ===== -->
  <div class="pm-shell">
    <aside class="side" id="pm-side" aria-label="ÏóÖÎ¨¥ Î©îÎâ¥">
      <div class="title">ÏóÖÎ¨¥ Î©îÎâ¥</div>
      <div id="top-acc"></div>
    </aside>
    <section class="vcontent" id="vcontent" aria-live="polite"></section>
  </div>

  <!-- ===== KPI Statistics Modal ===== -->
  <div id="kpi-modal" class="stat-modal" hidden aria-modal="true" role="dialog">
    <div class="stat-card" role="document">
      <header>
        <h4 id="km-title">KPI ÌÜµÍ≥Ñ</h4>
        <span class="hint">Alt+P Ïó¥Í∏∞ ¬∑ Esc Îã´Í∏∞</span>
        <button id="km-close" class="stat-close" type="button" aria-label="Îã´Í∏∞">‚úï</button>
      </header>
      <div class="stat-body">
        <div class="stat-grid">
          <div>
            <div id="km-chart" class="chart-wrap" aria-hidden="false"></div>
            <div id="km-legend" class="chart-legend"></div>
          </div>
          <aside class="stat-aside" aria-label="KPI ÏöîÏïΩ">
            <h5>ÏöîÏïΩ</h5>
            <div class="kv"><span>ÌòÑÏû¨Í∞í</span><b id="km-now">-</b></div>
            <div class="kv"><span>ÏµúÍ≥†/ÏµúÏ†Ä</span><b id="km-maxmin">-</b></div>
            <div class="kv"><span>ÏµúÍ∑º 12Íµ¨Í∞Ñ ÌèâÍ∑†</span><b id="km-avg">-</b></div>
            <div class="kv"><span>Îã®ÏúÑ</span><b id="km-unit">-</b></div>
          </aside>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Generic Statistics Modal ===== -->
  <div id="gen-modal" class="stat-modal" hidden aria-modal="true" role="dialog">
    <div class="stat-card" role="document">
      <header>
        <h4 id="gm-title">ÌÜµÍ≥Ñ</h4>
        <span class="hint">Alt+G Ïó¥Í∏∞ ¬∑ Esc Îã´Í∏∞</span>
        <button id="gm-close" class="stat-close" type="button" aria-label="Îã´Í∏∞">‚úï</button>
      </header>
      <div class="stat-body">
        <div class="stat-grid">
          <div>
            <div id="gm-chart" class="chart-wrap"></div>
            <div id="gm-legend" class="chart-legend"></div>
          </div>
          <aside class="stat-aside" aria-label="ÏöîÏïΩ">
            <h5>ÏöîÏïΩ</h5>
            <div class="kv"><span>ÌòÑÏû¨Í∞í</span><b id="gm-now">-</b></div>
            <div class="kv"><span>ÏµúÍ≥†/ÏµúÏ†Ä</span><b id="gm-maxmin">-</b></div>
            <div class="kv"><span>ÏµúÍ∑º ÌèâÍ∑†</span><b id="gm-avg">-</b></div>
            <div class="kv"><span>Îã®ÏúÑ</span><b id="gm-unit">-</b></div>
          </aside>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const root = document.getElementById('ui-pm-work');
  if(!root) return;
  const vcontent = root.querySelector('#vcontent');
  const $  = (s,p=root)=>p.querySelector(s);
  const $$ = (s,p=root)=>Array.from(p.querySelectorAll(s));

  /* ========= FIXED TOP LIST + Color mapping ========= */

/* ÏàúÏÑú Í≥†Ï†ï: General(ÏµúÏÉÅÎã®), PM, LM, CM, CPF, FM, WM, Ï§ëÍ∞úÎ≤ïÏù∏(ÏµúÌïòÎã®) */
const FIXED_TOPS = [  { id:'fee', label:'Í¥ÄÎ¶¨ÎπÑ' } ];

/* Í≥†Ïú† ÏÉâÏÉÅ Îßµ ‚Äî Í∞Å ÎåÄÎ∂ÑÎ•òÎäî ÏÑúÎ°ú Îã§Î•∏ HUE ÏÇ¨Ïö©(ÏÇ¨Ïö©Ïûê ÏÑ†Ìò∏ Î∞òÏòÅ) */
const TOP_HUE_MAP = { fee:24 };

/* ÏïÑÏù¥ÏΩò Îßµ */
const ICON_MAP = { fee:'üí≥' };

const hue = id => TOP_HUE_MAP[id] ?? 221;

   /* ========= Per-Top Headers ========= */
  const HEADERS = { fee:{ title:'Í¥ÄÎ¶¨ÎπÑ ÏΩòÏÜî', hint:'Î∂ÄÍ≥º¬∑Í≤ÄÏπ®¬∑ÏàòÎÇ©¬∑Ïó∞Ï≤¥' } };

  function buildHeaders(){
    const hb = $('#headbars');
    hb.innerHTML = FIXED_TOPS.map(t=>`
      <div class="headbar" data-head="${t.id}" style="--top-h:${hue(t.id)}" role="region" aria-label="${HEADERS[t.id].title}">
        <div class="logo" aria-hidden="true"></div>
        <h3><span class="ico">${ICON_MAP[t.id]||'‚Ä¢'}</span>${HEADERS[t.id].title}</h3>
        <span class="hint">${HEADERS[t.id].hint}</span>
      </div>`).join('');
  }
  function showHeadFor(topId){
    $$('.headbar').forEach(h=> h.classList.toggle('show', h.dataset.head===topId));
  }

  /* ========= WORK TREE ========= */
  const WORK_TREE = {
  fee: {
    cats: [
  { key:'·ÑÄ·Ö•·Ü∑·Ñé·Öµ·Ü∑·ÑÄ·Ö™·Ü´·ÑÖ·Öµ', label:'Í≤ÄÏπ®Í¥ÄÎ¶¨', subs:[{ id:'MTR-001', label:'ÏõîÍ∞Ñ Í≤ÄÏπ®ÏùºÏ†ï' }, { id:'MTR-002', label:'Î∞∞Ï†ï' }, { id:'MTR-101', label:'ÏûêÎèôÍ≤ÄÏπ®(AMI)ÌòÑÌô©' }, { id:'MTR-102', label:'ÏàòÎèôÍ≤ÄÏπ® ÏûÖÎ†•(ÏÇ¨ÏßÑ¬∑GPS¬∑Ïò§ÌîÑÎùºÏù∏)' }, { id:'MTR-103', label:'Í≤ÄÏπ® ÏùºÍ¥ÑÏóÖÎ°úÎìú(CSV)' }, { id:'MTR-201', label:'Ïù¥ÏÉÅÏπò¬∑Ïó≠Ï†Ñ¬∑Î°§Ïò§Î≤Ñ Í≤ÄÏ¶ù' }, { id:'MTR-202', label:'ÌöåÏã†' }, { id:'MTR-203', label:'Ï∂îÏ†ïÏπò Í∑úÏπô Í¥ÄÎ¶¨' }, { id:'MTR-301', label:'Î∞∞Î∂Ñ Í∏∞Ï§Ä ÏÑ§Ï†ï' }, { id:'MTR-302', label:'Î∞∞Î∂Ñ Í≤∞Í≥ºÌëú' }, { id:'MTR-401', label:'ÏûêÎ¶øÏàò¬∑Îã®ÏúÑ' }, { id:'MTR-402', label:'ÍµêÏ≤¥¬∑Í≤ÄÏ†ï¬∑Î¥âÏù∏ Ïù¥Î†•' }, { id:'MTR-403', label:'Í≥ÑÎüâÍ∏∞ ÍµêÏ≤¥ Î≥¥Ï†ï ÎßàÎ≤ïÏÇ¨' }, { id:'MTR-501', label:'Í≤ÄÏπ® Í∞êÏÇ¨Î°úÍ∑∏' }] }
]
  }
};

  /* ========= KPI DATA ========= */
  const KPIS = {
    gen: [['Í≥µÏßÄ','3Í±¥','‚Äì','neutral'],['ÏïåÎ¶º Î∞úÏÜ°','12Í±¥','‚ñ≤ 2','good'],['CS ÎØ∏Î∂ÑÎ•ò','1Í±¥','‚ñº 1','good'],['ÏûÖÏ£ºÏûê Î≥ÄÍ≤Ω','2Í±¥','‚Äì','neutral'],['ÏÜåÏú†Ïûê Î≥ÄÍ≤Ω','0Í±¥','‚Äì','neutral'],['Í≥ÑÏïΩ ÏóÖÎç∞Ïù¥Ìä∏','1Í±¥','‚Äì','neutral'],['ÏãúÏä§ÌÖú Í∞ÄÎèôÎ•†','99.9%','‚Äì','neutral'],['Î≥¥Ïïà ÏïåÎ¶º','0Í±¥','‚Äì','neutral'],['Î¨∏ÏÑú ÏóÖÎç∞Ïù¥Ìä∏','4','‚ñ≤ 1','good'],['Í≥µÏßÄ Ïó¥ÎûåÎ•†','87%','‚ñ≤ 2%','good'],['ÎåÄÏãúÎ≥¥Îìú ÏÇ¨Ïö©Ïûê','124','‚ñ≤ 6','good'],['API ÏÉÅÌÉú','Ï†ïÏÉÅ','‚Äì','neutral']],    pm:  [['Ïö¥ÏòÅ ÏßÑÏ≤ôÎèÑ','92%','‚ñ≤ 3.1%','good'],['ÏõîÍ∞Ñ Í≥ÑÌöç ÏôÑÎ£å','10/12','‚Äì','neutral'],['Í¥ÄÎ¶¨ÎπÑ ÏàòÎÇ©Î•†','99.2%','‚ñ≤ 0.3%','good'],['ÏòàÏÇ∞ ÏßëÌñâÎ•†','78%','‚ñº 1.4%','bad'],['ÏïàÏ†Ñ ÍµêÏú° Ïù¥Ìñâ','100%','‚Äì','neutral'],['ÌïòÏûê ÎØ∏Ìï¥Í≤∞','3','‚ñº 1','good'],['TMS Ïù¥ÏÉÅ','2','‚ñ≤ 1','bad'],['CS ÌèâÍ∑† TAT','5.2h','‚ñº 0.3h','good'],['Ï†ïÍ∏∞Ï†êÍ≤Ä Ïù¥Ìñâ','88%','‚ñ≤ 4%','good'],['ÏÜåÎ™®Ìíà Î∂ÄÏ°±','1','‚Äì','neutral'],['Î¶¨Ìè¨Ìä∏ Î∞úÏÜ°','1','‚Äì','neutral'],['ÏúÑÌóòÎèÑ ÏßÄÏàò','Low','‚Äì','neutral']],
    lm:  [['Î¶¨Îìú Ïàò','28','‚ñ≤ 6','good'],['Ï∫†ÌéòÏù∏ ÏßÑÌñâ','3','‚Äì','neutral'],['Ï†ÑÌôòÏú®','12%','‚ñ≤ 1.2%','good'],['ÌòëÏùòÏ§ë Îîú','4','‚Äì','neutral'],['Í≥ÑÏïΩ Î∞úÏÜ°','2','‚Äì','neutral'],['Í≥µÏã§Î•†','5%','‚ñº 1%','good'],['ÏûÖÏ£º ÏòàÏ†ï','3','‚Äì','neutral'],['Ìá¥Ïã§ ÏòàÏ†ï','1','‚Äì','neutral'],['ÌïòÏûê Ï†ëÏàò','2','‚Äì','neutral'],['ÏàòÏàòÎ£å Ï≤≠Íµ¨','3Í±¥','‚ñ≤ 1','good'],['Ïó∞Ï≤¥ Í±¥Ïàò','1','‚ñº 1','good'],['ÎßåÏ°±ÎèÑ','87%','‚ñ≤ 2%','good']],
    cm:  [['ÌîÑÎ°úÍ∑∏Îû® Ïàò','6','‚ñ≤ 1','good'],['Ï∞∏Ïó¨Ïú®','62%','‚ñ≤ 4%','good'],['Í≥µÏßÄ Î∞úÌñâ','8','‚Äì','neutral'],['ÏòàÏïΩ Ï≤òÎ¶¨','23','‚ñ≤ 5','good'],['CS ÌèâÍ∑† TAT','4.8h','‚ñº 0.4h','good'],['ÏÜåÎ™®Ìíà ÎπÑÏö©','‚Ç© 1.2M','‚ñº ‚Ç©0.1M','good'],['Ï†ïÏÇ∞ Í±¥Ïàò','12','‚Äì','neutral'],['ÏùºÎ≥¥ ÏûëÏÑ±','20','‚ñ≤ 3','good'],['Î¶¨Ìè¨Ìä∏ Ïàò','4','‚Äì','neutral'],['ÏïàÏ†Ñ Ïù¥Ïäà','0','‚Äì','neutral'],['ÌòÑÏû• Ï†êÍ≤Ä','14','‚ñ≤ 2','good'],['ÎßåÏ°±ÎèÑ','90%','‚ñ≤ 1%','good']],
    cpf: [['ÏßÑÌñâ ÌîÑÎ°úÍ∑∏Îû®','8','‚ñ≤ 2','good'],['ÏòàÏïΩÎ•†','78%','‚ñ≤ 3%','good'],['Ï∂úÏÑùÎ•†','91%','‚ñ≤ 1%','good'],['ÎÖ∏ÏáºÏú®','3%','‚ñº 0.5%','good'],['Îß§Ï∂ú','‚Ç© 12.4M','‚ñ≤ ‚Ç©0.8M','good'],['ÌôòÎ∂àÏú®','2%','‚Äì','neutral'],['Í∞ïÏÇ¨ Ïàò','12','‚Äì','neutral'],['ÎßåÏ°±ÎèÑ','92%','‚ñ≤ 1%','good'],['Ïã†Í∑ú Í∞ÄÏûÖ','45','‚ñ≤ 6','good'],['ÌôúÏÑ± ÌöåÏõê','320','‚ñ≤ 18','good'],['Ï∫†ÌéòÏù∏','3','‚Äì','neutral'],['Ïù¥Ïäà','0','‚Äì','neutral']],
    fm:  [['ÏùºÏÉÅ Ï†êÍ≤Ä','35','‚ñ≤ 4','good'],['ÏòàÎ∞© Ï†ïÎπÑ','4','‚Äì','neutral'],['Ïù¥ÏÉÅÏßïÌõÑ','2','‚Äì','neutral'],['Ï†ëÏàò Í±¥','7','‚Äì','neutral'],['ÏßÑÌñâ Í±¥','3','‚Äì','neutral'],['ÏôÑÎ£å Í±¥','12','‚Äì','neutral'],['ÏïàÏ†ÑÍµêÏú°','Ï†ïÏÉÅ','‚Äì','neutral'],['ÌïÑÏ¶ù Î≥¥Í¥Ä','100%','‚Äì','neutral'],['ÏÇ¨Í≥† Î≥¥Í≥†','0','‚Äì','neutral'],['ÌòÑÏû• ÎπÑÏö©','‚Ç© 0.6M','‚ñº ‚Ç©0.1M','good'],['Ï†àÍ∞ê Ï†úÏïà','2','‚ñ≤ 1','good'],['Í∞ÄÎèôÎ•†','97%','‚ñ≤ 1%','good']],
    wm:  [['ÏßÑÌñâ Í≥ºÏ†ú','42','‚ñ≤ 5','good'],['ÏôÑÎ£åÏú®','86%','‚ñ≤ 2%','good'],['ÌèâÍ∑† TAT','4.2h','‚ñº 0.2h','good'],['Î¶¨Ïä§ÌÅ¨ Ïò§Ìîà','3','‚ñº 1','good'],['Ïô∏Ï£º ÏßÑÌñâ','5','‚Äì','neutral'],['ÏòàÏÇ∞ ÏßëÌñâ','72%','‚ñ≤ 1%','neutral'],['ÍµêÏú° Ïù¥Ìñâ','100%','‚Äì','neutral'],['ÌíàÏßàÏßÄÌëú(Q)','92%','‚ñ≤ 1%','good'],['CS Ïû¨Ïò§Ìîà','1','‚Äì','neutral'],['ÏûêÎèôÌôî Í±¥Ïàò','7','‚ñ≤ 2','good'],['Î¨∏ÏÑú ÏóÖÎç∞Ïù¥Ìä∏','4','‚Äì','neutral'],['ÎßåÏ°±ÎèÑ','90%','‚ñ≤ 1%','good']],
    brk: [['Îß§Î¨º Îì±Î°ù','284','‚ñ≤ 12','good'],['ÎÖ∏Ï∂ú(Ïò§Îäò)','52,340','‚ñ≤ 6%','good'],['ÌÅ¥Î¶≠(Ïò§Îäò)','1,284','‚ñ≤ 3%','good'],['Ïã†Í∑ú Î¨∏Ïùò','18','‚ñ≤ 4','good'],['Ìà¨Ïñ¥ ÏòàÏïΩ','9','‚ñ≤ 2','good'],['Í≥ÑÏïΩ Ï≤¥Í≤∞','2','‚Äì','neutral'],['ÏäπÎ•†','24%','‚ñ≤ 2%','good'],['Í¥ëÍ≥†ÎπÑ(Ïõî)','‚Ç© 680Îßå','‚Äì','neutral'],['Î¶¨ÎìúÎãπÎπÑÏö©','‚Ç© 18,500','‚ñº ‚Ç©1,200','good'],['ÌîåÎû´Ìèº Ïò§Î•ò','3','‚ñº 2','good'],['Î∏åÎ¶¨Ìïë ÏóÖÎç∞Ïù¥Ìä∏','5','‚Äì','neutral'],['ÎßåÏ°±ÎèÑ','92%','‚ñ≤ 1%','good']],    
  };

  /* ========= Helpers / charts / dashboards / pages ========= */
  const UNIT_PREF = (title)=>{
    if(/ÌôçÎ≥¥|ÎÖ∏Ï∂ú|ÌÅ¥Î¶≠|ÏÑ∏ÏÖò|Í≤ÄÏÉâ/.test(title)) return 'Ìöå';
    if(/ÏÇ¨Ïö©Ïûê|ÌöåÏõê|ÏßÅÏõê|Î™Ö/.test(title)) return 'Î™Ö';
    if(/ÌîÑÎ°úÍ∑∏Îû® Ïàò|ÏßÑÌñâ ÌîÑÎ°úÍ∑∏Îû®|Îß§Î¨º/.test(title)) return 'Í∞ú';
    if(/ÎπÑÏö©|ÏßÄÏ∂ú|ÏòàÏÇ∞|CPC|ÌòÑÏû• ÎπÑÏö©|Îß§Ï∂ú|Í¥ëÍ≥†ÎπÑ|Î¶¨ÎìúÎãπÎπÑÏö©/.test(title)) return 'Ïõê';
    return 'Í±¥';
  };
  const strip = (s)=> (s||'').replace(/\s+/g,'').trim();
  const trimZero = (n)=> String(n).replace(/(\.\d*?[1-9])0+$|\.0+$/,'$1');
  function toKoreanMagnitude(num){
    if(!isFinite(num)) return '0';
    const abs = Math.abs(num);
    if(abs >= 1e8) return trimZero((num/1e8).toFixed(1))+'Ïñµ';
    if(abs >= 1e4) return trimZero((num/1e4).toFixed(1))+'Îßå';
    if(abs >= 1e3) return trimZero((num/1e3).toFixed(1))+'Ï≤ú';
    return String(Math.round(num));
  }
  function parseMixedNumber(s){
    const m = strip(s);
    let num = parseFloat(m.replace(/[^\d.+-]/g,'')); if(isNaN(num)) num=0;
    if(/k$/i.test(m)) num = num*1e3;
    if(/m$/i.test(m)) num = num*1e6;
    if(/b$/i.test(m)) num = num*1e9;
    if(/Ïñµ/.test(m)) num = num*1e8;
    if(/Îßå/.test(m)) num = num*1e4;
    if(/Ï≤ú/.test(m)) num = num*1e3;
    return num;
  }
  function normalizeMain(title, main){
    const raw = String(main||'').trim();
    if(/[ÔºÖ%]$/.test(raw) || /(\d+(\.\d+)?)\s?[hd]$/.test(raw) || /^\d+\/\d+$/.test(raw) || /^[-A-Za-z+]/.test(raw) || /Ï†ïÏÉÅ|Low|High|A\b|v\d+/i.test(raw)) return raw;
    if(/‚Ç©|Ïõê/.test(raw)){
      const n = /[kmb]$/i.test(raw) ? parseMixedNumber(raw) : parseFloat(raw.replace(/[^\d.]/g,''))||0;
      const human = toKoreanMagnitude(n);
      return '‚Ç© ' + human + ' Ïõê';
    }
    if(/[Í±¥ÌöåÍ∞ú]$/.test(raw)) return raw;
    let val = raw;
    if(/[kmb]$/i.test(strip(raw))){
      const n = parseMixedNumber(raw);
      val = toKoreanMagnitude(n);
    }
    const unit = UNIT_PREF(title);
    return val + unit;
  }

  function kpiCard([title, main, deltaText, tone]){
    const pretty = normalizeMain(title, main);
    return '<div class="kpi" tabindex="0"><h5>'+title+'</h5><div class="main '+(tone==='good'?'good':(tone==='bad'?'bad':''))+'">'+pretty+'</div><div class="sub"><span class="delta '+tone+'">'+deltaText+'</span></div></div>';
  }
  function renderKPIs(topId, isHomeActive){
    const wrap = $('#kpis');
    if(!isHomeActive){ wrap.innerHTML=''; return; }
    const list = KPIS[topId] || [];
    wrap.innerHTML = list.map(kpiCard).join('');
    $$('#kpis .kpi').forEach((card)=>{
      card.addEventListener('click', ()=>{
        const title = card.querySelector('h5')?.textContent || 'KPI';
        const main  = card.querySelector('.main')?.textContent || '0';
        const tone  = card.querySelector('.delta')?.classList[1] || 'neutral';
        const topIdActive = $('.top-btn.active')?.dataset.top || topId || 'pm';
        openKpiModal({ topId: topIdActive, title, main, tone });
      });
      card.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); card.click(); }});
    });
  }

  /* ===== micro charts utils (HSL helpers, generators) ===== */
  const HSL = (h,s,l)=>`hsl(${h}, ${s}%, ${l}%)`;
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  function lastN(n=20){ return Array.from({length:n},(_,i)=>i); }
  function microSeries(n=20, base=20, jitter=0.35){
    const vals = lastN(n).map(i=>{
      const v = base + Math.sin(i/2)*base*jitter + (Math.random()-0.5)*base*jitter*1.2;
      return Math.max(0.2, v);
    });
    return vals;
  }
  function microSVG(type, hueVal){
    const W=260, H=56, L=14, R=8, T=8, B=12;
    const vals = microSeries(18, 18+Math.random()*10);
    const max = Math.max(...vals,1), min = Math.min(...vals);
    const x = i => L + (i/(vals.length-1))*(W-L-R);
    const y = v => T + (1-(v-min)/(max-min||1))*(H-T-B);

    if(type==='bar'){
      const cw = (W-L-R)/vals.length, gap = 2, bw = Math.max(3, cw-gap);
      const rects = vals.map((v,i)=>`<rect x="${L+i*cw+(cw-bw)/2}" y="${y(v)}" width="${bw}" height="${H-B - y(v)}" rx="4" fill="${HSL(hueVal,70,46)}"/>`).join('');
      return `<svg viewBox="0 0 ${W} ${H}"><rect width="${W}" height="${H}" fill="#fff"/>${rects}</svg>`;
    }
    if(type==='line' || type==='area'){
      const path = vals.map((v,i)=>`${i?'L':'M'} ${x(i)},${y(v)}`).join(' ');
      const area = `${path} L ${x(vals.length-1)},${H-B} L ${x(0)},${H-B} Z`;
      const gradId = 'g'+Math.random().toString(36).slice(2);
      return `<svg viewBox="0 0 ${W} ${H}">
        <defs><linearGradient id="${gradId}" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0%" stop-color="${HSL(hueVal,75,58)}" stop-opacity=".25"/>
          <stop offset="100%" stop-color="${HSL(hueVal,75,58)}" stop-opacity="0"/>
        </linearGradient></defs>
        <rect width="${W}" height="${H}" fill="#fff"/>
        ${type==='area'? `<path d="${area}" fill="url(#${gradId})"/>` : '' }
        <path d="${path}" fill="none" stroke="${HSL(hueVal,70,46)}" stroke-width="2"/>
      </svg>`;
    }
    const pct = clamp(Math.round((vals.at(-1)/(max||1))*100),0,100);
    const cx=28, cy=28, r=18, sw=8, c=2*Math.PI*r, off=c*(1-pct/100);
    return `<svg viewBox="0 0 56 56">
      <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="#eef2ff" stroke-width="${sw}"/>
      <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${HSL(hueVal,70,46)}" stroke-width="${sw}" stroke-linecap="round" transform="rotate(-90 ${cx} ${cy})" stroke-dasharray="${c}" stroke-dashoffset="${off}"/>
      <text x="${cx}" y="${cy}" font-size="10" font-weight="800" text-anchor="middle" dominant-baseline="central" fill="#0f172a">${pct}%</text>
    </svg>`;
  }
  function pickMicroTypeByTitle(title){
    if(/Ïú®|Î•†|ÎπÑÏú®|Ï†êÏú†|%|Ï∂úÏÑù/.test(title)) return 'donut';
    if(/tat|ÏãúÍ∞Ñ|ÏÜçÎèÑ|Î¶¨Îìú\s?ÌÉÄÏûÑ|Ï∂îÏù¥|trend|ÏöîÏ≤≠|Ï≤òÎ¶¨|ÌòÑÌô©|ÏóÖÎç∞Ïù¥Ìä∏|Î¶¨Îìú|ÏÑ∏ÏÖò|ÏòàÏïΩ/i.test(title)) return 'line';
    if(/ÎπÑÏö©|ÏòàÏÇ∞|ÏßÄÏ∂ú|Í∏àÏï°|Ïõê|‚Ç©|Í≤ΩÎ≥¥|Ïù¥Ïäà|Îß§Ï∂ú|Ï†ïÏÇ∞|Í¥ëÍ≥†/.test(title)) return 'bar';
    const types = ['bar','line','area'];
    return types[ Math.floor(Math.random()*types.length) ];
  }

  function dashboardWidget(title, key, topId=($('.top-btn.active')?.dataset.top||'pm')){
    const t = pickMicroTypeByTitle(title);
    const hueVal = TOP_HUE_MAP[topId] || 221;
    return `
      <section class="mini" data-dash="${key}">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
          <h6>${title}</h6>
          <button class="btn stats" data-open-stats="${key}" aria-label="${title} ÌÜµÍ≥Ñ Ïó¥Í∏∞">ÌÜµÍ≥Ñ</button>
        </div>
        <div class="micro" aria-hidden="true">${microSVG(t, hueVal)}</div>
        <ul class="list">
          <li><span>ÏóÖÎç∞Ïù¥Ìä∏</span><b>+${Math.floor(Math.random()*5)+1}</b></li>
          <li><span>Ïò§Î•ò/Ïù¥Ïäà</span><b>${Math.floor(Math.random()*3)}</b></li>
          <li><span>ÌèâÍ∑† Ï≤òÎ¶¨</span><b>${(2+Math.random()*4).toFixed(1)}h</b></li>
        </ul>
      </section>`;
  }

  function makeTopDashboard(topId){
    const topLabel = FIXED_TOPS.find(x=>x.id===topId)?.label||topId.toUpperCase();
    return `
      <section class="widget">
        <header>
          <h4>${topLabel} Ìôà ¬∑ ÎåÄÏãúÎ≥¥Îìú</h4>
          <div class="row-actions">
            <button class="btn gray" data-refresh-dash="${topId}" aria-label="ÎåÄÏãúÎ≥¥Îìú ÏÉàÎ°úÍ≥†Ïπ®">ÏÉàÎ°úÍ≥†Ïπ®</button>
          </div>
        </header>
        <div class="dash-grid">
          <div>
            <div class="cards">
              ${dashboardWidget('ÏóÖÎ¨¥ ÏßÑÌñâ ÌòÑÌô©','progress', topId)}
              ${dashboardWidget('Ïù¥Ïäà & Í≤ΩÎ≥¥','alerts', topId)}
              ${dashboardWidget('ÏµúÍ∑º ÏöîÏ≤≠ Ï≤òÎ¶¨','requests', topId)}
            </div>

            <section class="mini" style="margin-top:10px">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <h6>CS Î¶¨Ïä§Ìä∏</h6>
                <button class="btn stats" data-open-stats="cslist">ÌÜµÍ≥Ñ</button>
              </div>
              <ul class="list">
                <li><span>1. A Ïù¥Ïäà</span><b class="pill-mini ok">Ï≤òÎ¶¨ÏôÑÎ£å</b></li>
                <li><span>2. B Ïù¥Ïäà</span><b class="pill-mini warn">ÏßÑÌñâÏ§ë</b></li>
                <li><span>3. C Ïù¥Ïäà</span><b class="pill-mini">Ïã†Í∑úÏ†ëÏàò</b></li>
                <li><span>4. D Ïù¥Ïäà</span><b class="pill-mini risk">Ïû¨Ï≤òÎ¶¨</b></li>
              </ul>
            </section>

            <section class="mini messenger-card" style="margin-top:10px">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <h6>Î©îÏã†Ï†Ä</h6>
              </div>
              <div class="messenger">
                <div class="msgs" data-msglist>
                  <div class="msg"><b>PM</b><span>ÏòàÏÇ∞Ïïà v2.1 Í≤ÄÌÜ† Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§.</span><time>09:10</time></div>
                  <div class="msg"><b>FM</b><span>ÏïàÏ†Ñ ÍµêÏú° ÏûêÎ£å Í≥µÏú†ÌñàÏäµÎãàÎã§.</span><time>09:22</time></div>
                </div>
                <form class="msg-form" data-msgform>
                  <input class="msg-input" data-msginput placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî."/>
                  <button class="btn msg-send">Î≥¥ÎÇ¥Í∏∞</button>
                </form>
              </div>
            </section>
          </div>

          <div>
            <section class="mini">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <h6>Îã¥ÎãπÏûê</h6>
                <button class="btn stats" data-open-stats="owners">ÌÜµÍ≥Ñ</button>
              </div>
              <ul class="list">
                <li><span>Ï¥ùÍ¥Ñ</span><b>ÌôçÍ∏∏Îèô</b></li>
                <li><span>ÌòÑÏû•</span><b>Ïù¥ÌòÑÏû•</b></li>
                <li><span>ÌöåÍ≥Ñ</span><b>ÍπÄÏûêÍ∏à</b></li>
              </ul>
            </section>

            <section class="mini" style="margin-top:10px">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <h6>ÏµúÍ∑º Î¨∏ÏÑú</h6>
                <button class="btn stats" data-open-stats="docs">ÌÜµÍ≥Ñ</button>
              </div>
              <ul class="list">
                <li><span>ÏõîÍ∞Ñ Î¶¨Ìè¨Ìä∏(Ï¥àÏïà)</span><b>v0.9</b></li>
                <li><span>ÏïàÏ†Ñ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏</span><b>v1.2</b></li>
                <li><span>ÏòàÏÇ∞ Í≥ÑÌöçÌëú</span><b>v2.1</b></li>
              </ul>
            </section>

            <section class="mini" style="margin-top:10px">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <h6>Í≥µÏßÄ/Î©îÎ™®</h6>
                <button class="btn stats" data-open-stats="notes">ÌÜµÍ≥Ñ</button>
              </div>
              <ul class="list">
                <li><span>Ï†ïÍ∏∞Ï†êÍ≤Ä 10/28 ÏòàÏ†ï</span><b class="pill-mini ok">OK</b></li>
                <li><span>Í≥ÑÏïΩÏÑú ÏÑúÏãù v3 Ï†ÅÏö©</span><b class="pill-mini warn">CHECK</b></li>
                <li><span>Ï£ºÏöî Î¶¨Ïä§ÌÅ¨ Ï†êÍ≤Ä</span><b class="pill-mini err">RISK</b></li>
              </ul>
            </section>
          </div>
        </div>
      </section>`;
  }

  function miniFromSub(sub, topId){
    const key = sub.id;
    const hueVal = TOP_HUE_MAP[topId] || 221;
    const mtype = pickMicroTypeByTitle(sub.label);
    return `
      <section class="mini" data-sub-summary="${key}">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
          <h6>${sub.label}</h6>
          <div style="display:flex;gap:6px">
            <button class="btn gray" data-goto="${key}" aria-label="${sub.label} ÏÉÅÏÑ∏Î°ú Î∞îÎ°úÍ∞ÄÍ∏∞">Î∞îÎ°úÍ∞ÄÍ∏∞</button>
            <button class="btn stats" data-open-subsummary="${key}">ÌÜµÍ≥Ñ</button>
          </div>
        </div>
        <div class="micro" aria-hidden="true">${microSVG(mtype, hueVal)}</div>
        <ul class="list">
          <li><span>Ïù¥Î≤àÏ£º Ï≤òÎ¶¨</span><b>${Math.floor(Math.random()*7)+1}Í±¥</b></li>
          <li><span>ÎØ∏Ìï¥Í≤∞</span><b>${Math.floor(Math.random()*3)}Í±¥</b></li>
          <li><span>ÌèâÍ∑† TAT</span><b>${(2+Math.random()*3).toFixed(1)}h</b></li>
        </ul>
      </section>`;
  }

  function makeCatDashboard(topId, cat){
    const subs = cat.subs||[];
    const topLabel = FIXED_TOPS.find(x=>x.id===topId)?.label||topId.toUpperCase();

    return `
      <section class="widget cat-home">
        <header class="cat-head">
          <h4>${topLabel} ¬∑ ${cat.label} Ìôà</h4>
          <div class="row-actions">
            <button class="btn lg" data-open-stats="cat-summary" aria-label="ÎåÄÏãúÎ≥¥Îìú Î≥¥Í∏∞">ÎåÄÏãúÎ≥¥Îìú</button>
          </div>
        </header>

        <div class="cat-sticky-top">
          <div class="cat-sticky-grid">
            <section class="mini sticky-card">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <h6>ÏöîÏïΩ ÏßÄÌëú</h6>
                <button class="btn stats" data-open-stats="cat-summary">ÌÜµÍ≥Ñ</button>
              </div>
              <div class="micro">${microSVG('bar', TOP_HUE_MAP[topId]||221)}</div>
              <ul class="list">
                <li><span>ÏßÑÏ≤ôÎèÑ</span><b>92%</b></li>
                <li><span>ÎØ∏Ìï¥Í≤∞</span><b>3Í±¥</b></li>
                <li><span>ÌèâÍ∑† TAT</span><b>4.6h</b></li>
              </ul>
            </section>

            <section class="mini sticky-card">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <h6>Ï§ëÏöî Í≥µÏßÄ</h6>
                <button class="btn stats" data-open-stats="cat-notes">ÌÜµÍ≥Ñ</button>
              </div>
              <ul class="list">
                <li><span>ÌîÑÎ°úÏÑ∏Ïä§ Ï†êÍ≤Ä Ï£ºÍ∞Ñ</span><b class="pill-mini warn">Ï£ºÏùò</b></li>
                <li><span>Îã¥Îãπ Î∞∞Ï†ï Î≥ÄÍ≤Ω</span><b class="pill-mini ok">OK</b></li>
                <li><span>ÏïàÏ†Ñ Ï†ïÍ∏∞ÍµêÏú° D-3</span><b class="pill-mini ok">READY</b></li>
              </ul>
            </section>
          </div>

          <div class="cat-sticky-grid" style="margin-top:10px">
            <section class="mini sticky-card">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <h6>ÏóÖÎç∞Ïù¥Ìä∏ ÌòÑÌô©</h6>
                <button class="btn stats" data-open-stats="cat-updates">ÌÜµÍ≥Ñ</button>
              </div>
              <div class="micro">${microSVG('line', TOP_HUE_MAP[topId]||221)}</div>
              <ul class="list">
                <li><span>Ïù¥Î≤àÏ£º ÏóÖÎç∞Ïù¥Ìä∏</span><b>+5</b></li>
                <li><span>Ïù¥Ïäà</span><b>1</b></li>
                <li><span>ÌèâÍ∑† Ï≤òÎ¶¨</span><b>3.1h</b></li>
              </ul>
            </section>

            <section class="mini sticky-card">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <h6>ÏòàÏÇ∞/ÏßÄÏ∂ú Î™®ÎãàÌÑ∞ÎßÅ</h6>
                <button class="btn stats" data-open-stats="cat-cost">ÌÜµÍ≥Ñ</button>
              </div>
              <div class="micro">${microSVG('bar', TOP_HUE_MAP[topId]||221)}</div>
              <ul class="list">
                <li><span>ÌòÑÏû¨ ÏßÄÏ∂ú</span><b>‚Ç© 11Îßå Ïõê</b></li>
                <li><span>ÏòàÏÇ∞ ÎåÄÎπÑ</span><b>78%</b></li>
                <li><span>Ï†ÑÏõî ÎåÄÎπÑ</span><b class="pill-mini warn">+4%</b></li>
              </ul>
            </section>
          </div>
        </div>

        <div class="dash-grid">
          <div class="cards">
            ${subs.map((s)=>miniFromSub(s, topId)).join('')}
          </div>
        </div>
      </section>`;
  }

  function ensureCatHome(topId, catKey){
    const cat = (WORK_TREE[topId]?.cats||[]).find(c=>c.key===catKey);
    if(!cat) return;
    const key = `${topId}-${catKey}-home`;
    let page = vcontent.querySelector(`.vpage[data-vpage="${key}"]`);
    if(!page){
      page = document.createElement('div');
      page.className = 'vpage';
      page.setAttribute('data-vpage', key);
      page.innerHTML = makeCatDashboard(topId, cat);
      vcontent.appendChild(page);
    }
    return page;
  }

  function subPageMarkup(subId, label){
    return `
      <section class="widget subpage" id="${subId}">
        <header><h4>${label}</h4>
          <div class="row-actions">
            <button class="btn stats" data-open-substats="#tbl-${subId}">ÌÜµÍ≥Ñ</button>
            <button class="btn gray" data-export="#tbl-${subId}">CSV</button>
            <button class="btn lg" data-back-top>ÎåÄÏãúÎ≥¥Îìú</button>
          </div>
        </header>
        <div class="toolbar" role="search">
          <input class="in search" placeholder="Í≤ÄÏÉâ" data-filter-input="#tbl-${subId}" aria-label="ÌÖåÏù¥Î∏î Í≤ÄÏÉâ"/>
          <input type="date" class="in date" aria-label="ÎÇ†Ïßú ÌïÑÌÑ∞"/>
          <select class="in select" data-status-filter="#tbl-${subId}" aria-label="ÏÉÅÌÉú ÌïÑÌÑ∞"><option value="">Ï†ÑÏ≤¥</option><option>ÏßÑÌñâ</option><option>ÏôÑÎ£å</option><option>Î≥¥Î•ò</option></select>
          <button class="btn" data-add="#tbl-${subId}">Ï∂îÍ∞Ä</button>
        </div>
        <div class="table-wrap"><table id="tbl-${subId}">
          <thead><tr><th>Ìï≠Î™©</th><th>ÏùºÏûê</th><th>ÏÉÅÌÉú</th><th>Îã¥Îãπ</th><th>Ïö∞ÏÑ†ÏàúÏúÑ</th><th>Ï≤òÎ¶¨</th></tr></thead>
          <tbody>
            <tr>
              <td>${label} ÎçîÎØ∏ Ìï≠Î™©</td>
              <td>2025-10-21</td>
              <td>ÏßÑÌñâ</td>
              <td>ÌôçÍ∏∏Îèô</td>
              <td>Î≥¥ÌÜµ</td>
              <td class="row-actions">
                <button class="btn gray" data-edit>ÏàòÏ†ï</button>
                <button class="btn danger" data-del>ÏÇ≠Ï†ú</button>
              </td>
            </tr>
          </tbody>
        </table></div>
      </section>`;
  }

  function ensureSubPage(subId, label){
  let page = vcontent.querySelector(`.vpage[data-vpage="${subId}"]`);
  if(page) return page;

  page = document.createElement('div');
  page.className = 'vpage';
  page.setAttribute('data-vpage', subId);

  if(subId === 'MTR-001'){
    page.innerHTML = renderMTR001();
    vcontent.appendChild(page);
    setTimeout(bootMTRPage, 0);
    return page;
  } else if(subId === 'MTR-102'){
    vcontent.appendChild(page);
    try{
      if (window.__MTR102_RENDER__) { window.__MTR102_RENDER__(page); }
      else { document.dispatchEvent(new CustomEvent('mtr102:mount', { detail: { host: page } })); }
    }catch(e){ console.error(e); }
    return page;
  }

  const name = (label || document.querySelector(`.mid[data-mid="${subId}"]`)?.textContent?.trim() || subId);
  page.innerHTML = `
    <section class="widget leaf-stub" data-leaf-stub="${subId}">
      <header><h4>${name}</h4></header>
      <div style="display:flex;align-items:center;justify-content:center;min-height:420px;padding:24px">
        <div style="text-align:center">
          <div style="font-weight:800;font-size:20px;margin-bottom:8px">${name}</div>
          <div style="color:#64748b;font-size:16px">Ï†úÏûë ÏòàÏ†ïÏûÖÎãàÎã§.</div>
        </div>
      </div>
    </section>`;
  vcontent.appendChild(page);
  return page;
}

  function buildAllPages(){
  // Top homes
  FIXED_TOPS.forEach(t=>{
    let page = vcontent.querySelector(`.vpage[data-vpage="${t.id}-home"]`);
    if(!page){
      page = document.createElement('div');
      page.className = 'vpage';
      page.setAttribute('data-vpage', `${t.id}-home`);
      page.innerHTML = makeTopDashboard(t.id);
      vcontent.appendChild(page);
    }
  });
  // Cat dashboards only (no leaf pre-render)
  Object.entries(WORK_TREE).forEach(([topId, obj])=>{
    (obj.cats||[]).forEach(cat=>{
      ensureCatHome(topId, cat.key);
    });
  });
}


  
/* ===== Permissions ===== */
const USER_PERMS = Object.assign({ view:true, create:true, update:true, assign:true, publish:true }, (window.USER_PERMS||{}));

/* ===== Data + Utilities for MTR-001 ===== */
function ymLabel(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function pad2(n){ return String(n).padStart(2,'0'); }

const SAMPLE_USERS = ['ÌôçÍ∏∏Îèô','ÍπÄÎã¥Îãπ','Ïù¥ÌòÑÏû•','Î∞ïÍ≤ÄÏπ®','ÏµúÏàòÎÇ©'];
const SAMPLE_LINES = ['101','102','201','202','301','302'];

function randomInt(a,b){ return a + Math.floor(Math.random()*(b-a+1)); }
function generateMTRData(year, month){
  const last = daysInMonth(year,month);
  const data = [];
  for(let d=1; d<=last; d++){
    const target = randomInt(5, 18);
    const done   = randomInt(Math.floor(target*0.6), target);
    const delayed = Math.max(0, target - done) + (Math.random() < .1 ? randomInt(0,3): 0);
    data.push({
      date: `${year}-${pad2(month+1)}-${pad2(d)}`,
      target, done, delayed,
      owner: SAMPLE_USERS[randomInt(0,SAMPLE_USERS.length-1)],
      line: SAMPLE_LINES[randomInt(0,SAMPLE_LINES.length-1)],
      priority: ['ÎÇÆÏùå','Î≥¥ÌÜµ','ÎÜíÏùå'][randomInt(0,2)],
      memo: (Math.random()<.25? 'ÌòÑÏû• ÌôïÏù∏ ÌïÑÏöî':'')
    });
  }
  return data;
}

/* ===== Logs ===== */
const MTR_LOG = { schedule: [], push: [] };
function addLog(kind, msg){
  const ts = new Date();
  const row = { ts, msg };
  (MTR_LOG[kind]||[]).push(row);
  const box = document.querySelector(kind==='push' ? '#mtr-push-log' : '#mtr-sched-log');
  if(box){
    const div = document.createElement('div');
    div.className = 'log';
    div.innerHTML = `<span class="ts">${ts.toLocaleString()}</span><span>${msg}</span>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }
}

/* ===== Renderers ===== */
function renderMTR001(){
  const now = new Date();
  const curYm = ymLabel(now);
  const markup = `
  <section class="widget" id="MTR-001">
    <header>
      <h4>ÏõîÍ∞Ñ Í≤ÄÏπ®ÏùºÏ†ï</h4>
      <div class="row-actions mtr-head-actions">
        <button class="btn" data-mtr-route>${'ÎùºÏö∞Ìä∏ ÏûêÎèôÏÉùÏÑ±'}</button>
        <button class="btn gray" data-mtr-assign>${'Î∞∞Ï†ï/Ïû¨Î∞∞Ï†ï'}</button>
        <button class="btn" data-mtr-push>${'Ìë∏ÏãúÎ∞úÌñâ'}</button>
      </div>
    </header>

    <div class="mtr-toolbar">
      <input class="in" type="month" id="mtr-month" value="${curYm}" aria-label="Ïõî ÏÑ†ÌÉù"/>
      <select class="in select" id="mtr-owner" aria-label="Îã¥ÎãπÏûê ÌïÑÌÑ∞">
        <option value="">Îã¥ÎãπÏûê Ï†ÑÏ≤¥</option>
        ${SAMPLE_USERS.map(u=>`<option>${u}</option>`).join('')}
      </select>
      <select class="in select" id="mtr-line" aria-label="Îèô/ÎùºÏù∏ ÌïÑÌÑ∞">
        <option value="">Îèô/ÎùºÏù∏ Ï†ÑÏ≤¥</option>
        ${SAMPLE_LINES.map(l=>`<option>${l}</option>`).join('')}
      </select>
      <select class="in select" id="mtr-priority" aria-label="Ïö∞ÏÑ†ÏàúÏúÑ ÌïÑÌÑ∞">
        <option value="">Ïö∞ÏÑ†ÏàúÏúÑ Ï†ÑÏ≤¥</option>
        <option>ÎÇÆÏùå</option><option>Î≥¥ÌÜµ</option><option>ÎÜíÏùå</option>
      </select>
      <span style="margin-left:auto"></span>
      <span class="pill-mini">Í∂åÌïú: 
        <b style="margin-left:6px">${['Ï°∞Ìöå','ÏÉùÏÑ±','ÏàòÏ†ï','Î∞∞Ï†ï','Î∞úÌñâ'].map((k,i)=>{
          const map={0:'view',1:'create',2:'update',3:'assign',4:'publish'};
          return USER_PERMS[map[i]]? `<span class="pill-mini ok">${k}</span>`:`<span class="pill-mini">${k}</span>`;
        }).join(' ')}</b>
      </span>
    </div>

    <div class="mtr-grid">
      <div>
        <div class="calendar" id="mtr-cal">
          <div class="cal-head">
            <h6 id="mtr-cal-title">Îã¨Î†•</h6>
            <div class="cal-nav">
              <button class="btn gray" id="mtr-prev" aria-label="Ïù¥Ï†Ñ Îã¨">‚óÄ</button>
              <button class="btn gray" id="mtr-next" aria-label="Îã§Ïùå Îã¨">‚ñ∂</button>
            </div>
          </div>
          <div class="cal-grid" id="mtr-dows">
            ${['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'].map(d=>`<div class="cal-dow">${d}</div>`).join('')}
          </div>
          <div class="cal-grid" id="mtr-days"></div>
        </div>
      </div>
      <div>
        <div class="kpi-inline" id="mtr-kpis">
          <div class="kpi-mini"><h6>ÎåÄÏÉÅÏàò</h6><b id="kpi-target">0</b></div>
          <div class="kpi-mini"><h6>ÏôÑÎ£åÏú®</h6><b id="kpi-done-rate">0%</b></div>
          <div class="kpi-mini"><h6>ÏßÄÏó∞Í±¥Ïàò</h6><b id="kpi-delayed">0</b></div>
        </div>
        <section class="mini" style="margin-top:10px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
            <h6>Í≤ÄÏπ® ÏùºÏ†ï</h6>
          </div>
          <div class="table-wrap mtr-table">
            <table id="tbl-mtr">
              <thead>
                <tr><th>ÏùºÏûê</th><th>Îã¥ÎãπÏûê</th><th>ÎåÄÏÉÅÏàò</th><th>ÏôÑÎ£å/ÏßÄÏó∞</th><th>Î©îÎ™®</th><th>Ï≤òÎ¶¨</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
        <section class="mini" style="margin-top:10px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
            <h6>Ïù¥Î≤§Ìä∏/Î°úÍ∑∏</h6>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <div>
              <div class="pill-mini">ÏùºÏ†ï ÏÉùÏÑ±/ÏàòÏ†ï/Î∞∞Ï†ï</div>
              <div id="mtr-sched-log" class="logbox" aria-label="ÏùºÏ†ï Î°úÍ∑∏"></div>
            </div>
            <div>
              <div class="pill-mini">Ìë∏Ïãú Î°úÍ∑∏</div>
              <div id="mtr-push-log" class="logbox" aria-label="Ìë∏Ïãú Î°úÍ∑∏"></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </section>`;
  return markup;
}

/* State & actions for MTR-001 */
const MTR = { cur: null, data: [], selDate: null };

function refreshMTR(){
  // filters
  const owner = document.getElementById('mtr-owner')?.value || '';
  const line  = document.getElementById('mtr-line')?.value || '';
  const pri   = document.getElementById('mtr-priority')?.value || '';
  let rows = MTR.data.slice();
  if(owner) rows = rows.filter(r=>r.owner===owner);
  if(line)  rows = rows.filter(r=>r.line===line);
  if(pri)   rows = rows.filter(r=>r.priority===pri);
  if(MTR.selDate) rows = rows.filter(r=>r.date===MTR.selDate);

  // KPIs
  const target = rows.reduce((a,b)=>a+b.target,0);
  const done   = rows.reduce((a,b)=>a+b.done,0);
  const delayed= rows.reduce((a,b)=>a+b.delayed,0);
  const rate = target? Math.round(done/target*100):0;
  document.getElementById('kpi-target').textContent = target.toLocaleString();
  document.getElementById('kpi-done-rate').textContent = rate+'%';
  document.getElementById('kpi-delayed').textContent = delayed.toLocaleString();

  // Table
  const tb = document.querySelector('#tbl-mtr tbody');
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.date}</td>
      <td>${r.owner}</td>
      <td>${r.target}</td>
      <td>${r.done}/${r.delayed}</td>
      <td>${r.memo||''}</td>
      <td class="row-actions">
        <button class="btn gray" data-mtr-edit="${r.date}">ÏàòÏ†ï</button>
        <button class="btn danger" data-mtr-reassign="${r.date}">Î∞∞Ï†ï</button>
      </td>
    </tr>`).join('');
}

function buildCalendar(y, m){
  const daysWrap = document.getElementById('mtr-days');
  const title = document.getElementById('mtr-cal-title');
  title.textContent = `${y}ÎÖÑ ${m+1}Ïõî`;
  const firstDow = new Date(y,m,1).getDay();
  const last = daysInMonth(y,m);
  const cells = [];
  for(let i=0;i<firstDow;i++) cells.push('<div></div>');
  for(let d=1; d<=last; d++){
    const date = `${y}-${pad2(m+1)}-${pad2(d)}`;
    const rec = MTR.data.find(r=>r.date===date);
    const t = rec? rec.target: 0;
    const delayed = rec? rec.delayed: 0;
    cells.push(`
      <div class="cal-day" data-date="${date}">
        <div class="d">${d}</div>
        <div class="badges">
          <span class="badge">ÎåÄÏÉÅ ${t}</span>
          <span class="badge ${delayed>0?'warn':''}">ÏßÄÏó∞ ${delayed}</span>
        </div>
      </div>`);
  }
  daysWrap.innerHTML = cells.join('');
  // select handling
  daysWrap.querySelectorAll('.cal-day').forEach(el=>{
    el.addEventListener('click', ()=>{
      daysWrap.querySelectorAll('.cal-day').forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected');
      MTR.selDate = el.getAttribute('data-date');
      refreshMTR();
    });
  });
}

function bootMTRPage(){
  const monthEl = document.getElementById('mtr-month');
  const dt = monthEl && monthEl.value? new Date(monthEl.value+'-01') : new Date();
  const y = dt.getFullYear(), m = dt.getMonth();
  MTR.cur = { y, m };
  MTR.data = generateMTRData(y, m);
  MTR.selDate = null;
  buildCalendar(y,m);
  refreshMTR();
  // binds
  ['mtr-owner','mtr-line','mtr-priority','mtr-month'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('change', ()=>{
      if(id==='mtr-month'){
        const d = new Date(el.value+'-01'); MTR.cur={y:d.getFullYear(), m:d.getMonth()};
        MTR.data = generateMTRData(MTR.cur.y, MTR.cur.m);
        buildCalendar(MTR.cur.y, MTR.cur.m);
      }
      MTR.selDate = null;
      refreshMTR();
      addLog('schedule', `ÌïÑÌÑ∞ Î≥ÄÍ≤Ω (${id})`);
    });
  });
  // nav
  document.getElementById('mtr-prev').addEventListener('click', ()=>{
    const d = new Date(MTR.cur.y, MTR.cur.m-1, 1);
    document.getElementById('mtr-month').value = ymLabel(d);
    MTR.cur = { y:d.getFullYear(), m:d.getMonth() };
    MTR.data = generateMTRData(MTR.cur.y, MTR.cur.m);
    buildCalendar(MTR.cur.y, MTR.cur.m);
    MTR.selDate=null; refreshMTR();
  });
  document.getElementById('mtr-next').addEventListener('click', ()=>{
    const d = new Date(MTR.cur.y, MTR.cur.m+1, 1);
    document.getElementById('mtr-month').value = ymLabel(d);
    MTR.cur = { y:d.getFullYear(), m:d.getMonth() };
    MTR.data = generateMTRData(MTR.cur.y, MTR.cur.m);
    buildCalendar(MTR.cur.y, MTR.cur.m);
    MTR.selDate=null; refreshMTR();
  });

  // actions
  const btnRoute  = document.querySelector('[data-mtr-route]');
  const btnAssign = document.querySelector('[data-mtr-assign]');
  const btnPush   = document.querySelector('[data-mtr-push]');

  if(btnRoute){
    btnRoute.addEventListener('click', ()=>{
      if(!USER_PERMS.create){ alert('Í∂åÌïú ÏóÜÏùå: ÏÉùÏÑ±'); return; }
      // regenerate plan & log
      MTR.data = generateMTRData(MTR.cur.y, MTR.cur.m);
      buildCalendar(MTR.cur.y, MTR.cur.m);
      refreshMTR();
      addLog('schedule','ÎùºÏö∞Ìä∏ ÏûêÎèôÏÉùÏÑ± Ïã§Ìñâ');
    });
  }
  if(btnAssign){
    btnAssign.addEventListener('click', ()=>{
      if(!USER_PERMS.assign){ alert('Í∂åÌïú ÏóÜÏùå: Î∞∞Ï†ï'); return; }
      const who = prompt('Î∞∞Ï†ïÌï† Îã¥ÎãπÏûêÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', SAMPLE_USERS[0]);
      if(!who) return;
      MTR.data.forEach(r=> r.owner = who);
      refreshMTR();
      addLog('schedule', `ÏùºÍ¥Ñ Î∞∞Ï†ï ‚Üí ${who}`);
    });
  }
  if(btnPush){
    btnPush.addEventListener('click', ()=>{
      if(!USER_PERMS.publish){ alert('Í∂åÌïú ÏóÜÏùå: Î∞úÌñâ'); return; }
      const target = MTR.selDate? `(${MTR.selDate})` : '(Ïõî Ï†ÑÏ≤¥)';
      addLog('push', `Ìë∏Ïãú Î∞úÌñâ ${target}`);
      alert('Ìë∏Ïãú Î∞úÌñâ ÏôÑÎ£å');
    });
  }

  // per-row actions
  document.querySelector('#tbl-mtr').addEventListener('click', (e)=>{
    const ed = e.target.closest('[data-mtr-edit]');
    const re = e.target.closest('[data-mtr-reassign]');
    if(ed){
      if(!USER_PERMS.update){ alert('Í∂åÌïú ÏóÜÏùå: ÏàòÏ†ï'); return; }
      const date = ed.getAttribute('data-mtr-edit');
      const rec = MTR.data.find(r=>r.date===date);
      if(!rec) return;
      const newT = prompt(`ÎåÄÏÉÅÏàò (${date})`, rec.target);
      if(newT!==null){
        rec.target = Math.max(0, parseInt(newT,10)||rec.target);
        rec.done = Math.min(rec.done, rec.target);
        refreshMTR();
        addLog('schedule', `ÏàòÏ†ï: ${date} ÎåÄÏÉÅÏàò ${rec.target}`);
      }
    }
    if(re){
      if(!USER_PERMS.assign){ alert('Í∂åÌïú ÏóÜÏùå: Î∞∞Ï†ï'); return; }
      const date = re.getAttribute('data-mtr-reassign');
      const rec = MTR.data.find(r=>r.date===date);
      if(!rec) return;
      const who = prompt(`Î∞∞Ï†ï/Ïû¨Î∞∞Ï†ï (${date})`, rec.owner);
      if(who){
        rec.owner = who.trim();
        refreshMTR();
        addLog('schedule', `Î∞∞Ï†ï Î≥ÄÍ≤Ω: ${date} ‚Üí ${who}`);
      }
    }
  });
}


  /* ========= Charts (Modals) ========= */
  const modal = $('#kpi-modal');
  modal.querySelector('.stat-card')?.addEventListener('click', (e)=> e.stopPropagation());
  const km = {
    title: $('#km-title'), now: $('#km-now'), maxmin: $('#km-maxmin'), avg: $('#km-avg'), unit: $('#km-unit'),
    chart: $('#km-chart'), legend: $('#km-legend'), closeBtn: $('#km-close')
  };
  let lastOpened = null;

  const gmodal = $('#gen-modal');
  gmodal.querySelector('.stat-card')?.addEventListener('click', (e)=> e.stopPropagation());
  const gm = {
    title: $('#gm-title'), now: $('#gm-now'), maxmin: $('#gm-maxmin'), avg: $('#gm-avg'), unit: $('#gm-unit'),
    chart: $('#gm-chart'), legend: $('#gm-legend'), closeBtn: $('#gm-close')
  };
  let lastGen = null;

  const fmt=(v,unit)=>{
    if(unit==='‚Ç©' || unit==='Ïõê') return '‚Ç© ' + Number(Math.round(v)).toLocaleString();
    if(unit==='%') return `${Math.round(v)}%`;
    if(unit==='h') return `${(typeof v==='number'? v : parseFloat(v)||0).toFixed(1)}h`;
    if(unit==='d') return `${Math.round(v)}d`;
    if(unit==='Í±¥' || unit==='Ìöå' || unit==='Í∞ú') return Number(Math.round(v)).toLocaleString()+unit;
    return Number.isFinite(v)? Number(Math.round(v)).toLocaleString() : String(v);
  };
  function parseKpi(mainText){
    const s = (mainText||'').trim();
    if(/[ÔºÖ%]$/.test(s)) return {kind:'percent', value:parseFloat(s), unit:'%'};      
    if(/‚Ç©|Ïõê/.test(s)){ const num = parseMixedNumber(s); return {kind:'currency', value:num, unit:'Ïõê'}; }
    if(/(\d+(\.\d+)?)h$/.test(s)) return {kind:'duration_h', value:parseFloat(s), unit:'h'};
    if(/(\d+(\.\d+)?)d$/.test(s)) return {kind:'duration_d', value:parseFloat(s), unit:'d'};
    if(/^\d+\/\d+$/.test(s)){ const [a,b]=s.split('/').map(Number); return {kind:'fraction', value: b? (a/b*100):0, unit:'%'}; }
    if(/(\d[\d,\.]*)\s?(Í±¥|Ìöå|Í∞ú)$/.test(s)){ const m = s.match(/([\d,\.]+)/); const u = s.match(/(Í±¥|Ìöå|Í∞ú)$/)[1];
      return {kind:'count', value: parseFloat((m?m[1]:'0').replace(/,/g,'')), unit:u};
    }
    if(isNaN(parseFloat(s))) return {kind:'grade', value:s, unit:''};
    return {kind:'count', value:parseFloat(s.replace(/[^0-9.]/g,'')), unit:''};
  }
  function lastNMonths(n=12){
    const now=new Date(); const labs=[];
    for(let i=n-1;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth()-i, 1); labs.push(`${d.getMonth()+1}Ïõî`); }
    return labs;
  }
  function seriesAround(base, kind){
    const labs = lastNMonths(12);
    const vals = labs.map((_m,i)=>{
      const drift = (kind==='percent'? 6: kind?.startsWith('duration')? 0.6 : kind==='currency'? (typeof base==='number'? Math.max(1000, base*0.08):1000) : Math.max(2, (typeof base==='number'? base*0.12:6)));
      let v = (typeof base==='number'? base : 50) + (Math.sin(i/2)*drift) + (Math.random()*drift - drift/2);
      if(kind==='percent'||kind==='fraction') v = clamp(v,0,100);
      if(kind==='duration_h') v = clamp(v, 0.2, Math.max(1,base*1.2||6));
      return Math.max(0, v);
    });
    return {labels:labs, values:vals};
  }

  function renderDonut(el, pct, hueVal){
    const p = clamp(pct,0,100);
    const radius=80, sw=22, cx=110, cy=110, c=2*Math.PI*(radius);
    const filled = c*(1-p/100);
    const gradId = 'g'+Math.random().toString(36).slice(2);
    el.innerHTML = `
      <svg class="chart-svg" viewBox="0 0 240 220" role="img" aria-label="donut">
        <defs>
          <linearGradient id="${gradId}" x1="0" x2="1">
            <stop offset="0%" stop-color="${HSL(hueVal,78,52)}"/>
            <stop offset="100%" stop-color="${HSL(hueVal,72,44)}"/>
          </linearGradient>
        </defs>
        <g transform="translate(0,10)">
          <circle cx="${cx}" cy="${cy}" r="${radius}" fill="none" stroke="#eef2ff" stroke-width="${sw}"/>
          <circle cx="${cx}" cy="${cy}" r="${radius}" fill="none" stroke="url(#${gradId})" stroke-width="${sw}"
            stroke-dasharray="${c}" stroke-dashoffset="${filled}" stroke-linecap="round"
            transform="rotate(-90 ${cx} ${cy})"/>
          <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="central"
            font-size="22" font-weight="800" fill="#0f172a">${Math.round(p)}%</text>
        </g>
      </svg>`;
  }
  function renderLine(el, labels, values, hueVal){
    const W=640, H=260, L=40, R=12, T=10, B=24;
    const max = Math.max(...values), min = Math.min(...values);
    const x = i => L + (i/(labels.length-1))*(W-L-R);
    const y = v => T + (1-(v-min)/(max-min||1))*(H-T-B);
    const path = values.map((v,i)=>`${i?'L':'M'} ${x(i)},${y(v)}`).join(' ');
    const area = values.map((v,i)=>`${i?'L':'M'} ${x(i)},${y(v)}`).join(' ') + ` L ${x(values.length-1)},${H-B} L ${x(0)},${H-B} Z`;
    const gradId = 'lg'+Math.random().toString(36).slice(2);
    const dots = values.map((v,i)=>`<circle cx="${x(i)}" cy="${y(v)}" r="2.6" fill="${HSL(hueVal,70,45)}"/>`).join('');
    const ticks = labels.map((lb,i)=> i%2? '' : `<text x="${x(i)}" y="${H-6}" font-size="10" text-anchor="middle" fill="#64748b">${lb}</text>`).join('');
    const grid = [0,0.25,0.5,0.75,1].map(t=>{
      const yy = T + t*(H-T-B);
      return `<line x1="${L}" y1="${yy}" x2="${W-R}" stroke="#eef2f7" stroke-width="1"/>`;
    }).join('');
    el.innerHTML = `
      <svg class="chart-svg" viewBox="0 0 ${W} ${H}" role="img" aria-label="line">
        <defs>
          <linearGradient id="${gradId}" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="${HSL(hueVal,75,58)}" stop-opacity=".28"/>
            <stop offset="100%" stop-color="${HSL(hueVal,75,58)}" stop-opacity="0"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="${W}" height="${H}" fill="#fff"/>
        ${grid}
        <path d="${area}" fill="url(#${gradId})" opacity=".7"/>
        <path d="${path}" fill="none" stroke="${HSL(hueVal,70,45)}" stroke-width="2.2"/>
        ${dots}
        ${ticks}
      </svg>`;
  }
  function renderBars(el, labels, values, hueVal){
    const W=640, H=260, L=40, R=12, T=10, B=24;
    const max = Math.max(...values, 1);
    const cw = (W-L-R)/values.length, gap = 6, bw = Math.max(6, cw-gap);
    const x = i => L + i*cw + (cw-bw)/2;
    const y = v => T + (1-(v/max))*(H-T-B);
    const rects = values.map((v,i)=>`<rect x="${x(i)}" y="${y(v)}" width="${bw}" height="${H-B - y(v)}" rx="5" fill="${HSL(hueVal,70,45)}"/>`).join('');
    const ticks = labels.map((lb,i)=> i%2? '' : `<text x="${x(i)+bw/2}" y="${H-6}" font-size="10" text-anchor="middle" fill="#64748b">${lb}</text>`).join('');
    const grid = [0,0.25,0.5,0.75,1].map(t=>{
      const yy = T + t*(H-T-B);
      return `<line x1="${L}" y1="${yy}" x2="${W-R}" stroke="#eef2f7" stroke-width="1"/>`;
    }).join('');
    el.innerHTML = `
      <svg class="chart-svg" viewBox="0 0 ${W} ${H}" role="img" aria-label="bar">
        <rect x="0" y="0" width="${W}" height="${H}" fill="#fff"/>
        ${grid}
        ${rects}
        ${ticks}
      </svg>`;
  }
  function chooseChartByKind(kind){
    if(kind==='percent'||kind==='fraction') return 'donut';
    if(kind==='duration_h'||kind==='duration_d') return 'line';
    if(kind==='currency') return 'bar';
    if(kind==='grade') return 'bar';
    return 'bar';
  }

  function openKpiModal({topId, title, main, tone}){
    const parsed = parseKpi(main);
    const hueVal = (TOP_HUE_MAP[topId] ?? 221);
    const base = (typeof parsed.value==='number'? parsed.value : 50);
    const ser = seriesAround(base, parsed.kind);

    $('#km-chart').innerHTML = ''; $('#km-legend').innerHTML='';
    const chartType = chooseChartByKind(parsed.kind);
    if(chartType==='donut') { renderDonut($('#km-chart'), (typeof parsed.value==='number'? parsed.value : 50), hueVal);
      } else if(chartType==='line') { renderLine($('#km-chart'), ser.labels, ser.values, hueVal);
    } else { renderBars($('#km-chart'), ser.labels, ser.values, hueVal); }

    const max = Math.max(...ser.values), min = Math.min(...ser.values);
    const avg = ser.values.reduce((a,b)=>a+b,0)/ser.values.length;
    $('#km-title').textContent = `${(FIXED_TOPS.find(x=>x.id===topId)?.label||topId.toUpperCase())} ¬∑ ${title}`;
    $('#km-now').textContent = fmt(parsed.value, parsed.unit||'');
    $('#km-maxmin').textContent = `${fmt(max, parsed.unit||'')} / ${fmt(min, parsed.unit||'')}`;
    $('#km-avg').textContent = `${fmt(avg, parsed.unit||'')}`;
    const ulabel = parsed.unit ? (parsed.unit==='Ïõê' ? 'Ïõê' : parsed.unit) : UNIT_PREF(title);
    $('#km-unit').textContent = ulabel;
    $('#km-legend').innerHTML = `<span><span class="legend-dot" style="background:${HSL(hueVal,70,45)}"></span>ÏµúÍ∑º 12Í∞ú Íµ¨Í∞Ñ</span><span class="pill-mini ${tone||'neutral'}">Œî ${tone||'neutral'}</span>`;
    $('#kpi-modal').hidden = false;
    lastOpened = {topId, title, main, tone};
  }

  function chartTypeForLabel(label=''){
    const t = label.toLowerCase();
    if(/Ïú®|Î•†|ÎπÑÏú®|Ï†êÏú†|%|Ï∂úÏÑù|ÎÖ∏Ïáº/.test(label)) return 'donut';
    if(/tat|ÏãúÍ∞Ñ|ÏÜçÎèÑ|Î¶¨Îìú\s?ÌÉÄÏûÑ|ÌèâÍ∑†|Ï∂îÏù¥|trend|ÏòàÏïΩ/.test(t)) return 'line';
    if(/ÎπÑÏö©|ÏòàÏÇ∞|ÏßÄÏ∂ú|Í∏àÏï°|Ïõê|‚Ç©|cpc|Îß§Ï∂ú|Ï†ïÏÇ∞|ÌôòÎ∂à|Í¥ëÍ≥†/.test(t)) return 'bar';
    return 'bar';
  }
  function unitForLabel(label=''){
    const t = label.toLowerCase();
    if(/Ïú®|Î•†|ÎπÑÏú®|Ï†êÏú†|%|Ï∂úÏÑù|ÎÖ∏Ïáº/.test(label)) return '%';
    if(/tat|ÏãúÍ∞Ñ|ÏÜçÎèÑ|Î¶¨Îìú\s?ÌÉÄÏûÑ|h\b/.test(t)) return 'h';
    if(/\bÏùº\b|days?|lead time d/.test(t)) return 'd';
    if(/ÎπÑÏö©|ÏòàÏÇ∞|ÏßÄÏ∂ú|Í∏àÏï°|Ïõê|‚Ç©|cpc|Îß§Ï∂ú|Ï†ïÏÇ∞|ÌôòÎ∂à|Í¥ëÍ≥†/.test(t)) return 'Ïõê';
    return 'Í±¥';
  }
  function baseForUnit(unit){
    if(unit==='%') return 60+Math.random()*30;
    if(unit==='Ïõê') return 10000+Math.random()*90000;
    if(unit==='h') return 2+Math.random()*6;
    if(unit==='d') return 3+Math.random()*14;
    return 10+Math.random()*20;
  }

  function openWidgetStats({topId, title, unit='Í±¥', chart='bar', base=20}){
    const hueVal = (TOP_HUE_MAP[topId] ?? 221);
    if(/ÏöîÏïΩ ÏßÄÌëú/.test(title)) chart = 'bar';
    else {
      const autoChart = chartTypeForLabel(title);
      const autoUnit  = unitForLabel(title);
      chart = autoChart || chart;
      unit  = autoUnit  || unit;
      base  = baseForUnit(unit);
    }
    const ser = seriesAround(base, chart==='line'?'count':(chart==='donut'?'percent':'count'));

    $('#gm-chart').innerHTML = ''; $('#gm-legend').innerHTML = '';
    if(chart==='line') renderLine($('#gm-chart'), ser.labels, ser.values, hueVal);
    else if(chart==='donut') renderDonut($('#gm-chart'), Math.min(100, Math.max(0, ser.values.at(-1)%101)), hueVal);
    else renderBars($('#gm-chart'), ser.labels, ser.values, hueVal);

    const max = Math.max(...ser.values), min = Math.min(...ser.values);
    const avg = ser.values.reduce((a,b)=>a+b,0)/ser.values.length;
    $('#gm-title').textContent = title+' ¬∑ ÌÜµÍ≥Ñ';
    $('#gm-now').textContent = fmt(ser.values.at(-1), unit==='%'?'%':unit);
    $('#gm-maxmin').textContent = `${fmt(max, unit==='%'?'%':unit)} / ${fmt(min, unit==='%'?'%':unit)}`;
    $('#gm-avg').textContent = fmt(avg, unit==='%'?'%':unit);
    $('#gm-unit').textContent = unit;
    $('#gm-legend').innerHTML = `<span><span class="legend-dot" style="background:${HSL(hueVal,70,45)}"></span>ÏµúÍ∑º 12Í∞ú Íµ¨Í∞Ñ</span>`;
    $('#gen-modal').hidden = false;
    lastGen = {topId, title, unit, chart, base};
  }

  function openSubStatsFromTable(table){
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const counts = rows.reduce((acc,tr)=>{
      const st=(tr.children[2]?.textContent||'Í∏∞ÌÉÄ').trim();
      acc[st]=(acc[st]||0)+1; return acc;
    },{});
    const labels = Object.keys(counts);
    const values = labels.map(k=>counts[k]);

    const topId = $('.top-btn.active')?.dataset.top || 'pm';
    const hueVal = TOP_HUE_MAP[topId] || 221;

    const labels12 = lastNMonths(12);
    const spreadVals = labels12.map((_m,i)=> values[i%values.length] || Math.max(1, Math.round(values.reduce((a,b)=>a+b,0)/labels.length)));

    $('#gm-chart').innerHTML=''; $('#gm-legend').innerHTML='';
    renderBars($('#gm-chart'), labels12, spreadVals, hueVal);
    const max = Math.max(...spreadVals), min = Math.min(...spreadVals);
    const avg = spreadVals.reduce((a,b)=>a+b,0)/spreadVals.length;
    $('#gm-title').textContent = (table.id||'ÌÖåÏù¥Î∏î')+' ¬∑ ÏÉÅÌÉú Î∂ÑÌè¨';
    $('#gm-now').textContent = fmt(spreadVals.at(-1), 'Í±¥');
    $('#gm-maxmin').textContent = `${fmt(max,'Í±¥')} / ${fmt(min,'Í±¥')}`;
    $('#gm-avg').textContent = fmt(avg,'Í±¥');
    $('#gm-unit').textContent = 'Í±¥';
    $('#gm-legend').innerHTML = '<span><span class="legend-dot" style="background:'+HSL(hueVal,70,45)+'"></span>ÏµúÍ∑º 12Í∞ú Íµ¨Í∞Ñ</span>';
    $('#gen-modal').hidden = false;
    lastGen = {topId, title:table.id+' ÏÉÅÌÉú', unit:'Í±¥', chart:'bar'};
  }

  function exportTableCSV(table){
    const rows=Array.from(table.querySelectorAll('tr'));
    const data=rows.map(tr=>Array.from(tr.querySelectorAll('th,td')).map(td=> '"'+(td.textContent||'').replace(/"/g,'""')+'"').join(','));
    const csv=data.join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=(table.id||'table')+'.csv';
    document.body.appendChild(a); a.click(); a.remove();
  }

  // === Top Î≤ÑÌäº ÎùºÎ≤® ÏûêÎèô Ìè∞Ìä∏ ÎßûÏ∂§ ===
  function autoFitTopLabels(){
    const MIN_TOP_FONT = 12;
    const START_MAP    = { default: 15, cpf: 16 };
    $$('.top-btn').forEach(btn => {
      const lbl = btn.querySelector('.lbl');
      if(!lbl) return;
      const start = START_MAP[btn.dataset.top] || START_MAP.default;
      lbl.style.fontSize = start + 'px';
      lbl.style.whiteSpace = 'nowrap';
      let size = start;
      let guard = 0;
      while (lbl.scrollWidth > lbl.clientWidth && size > MIN_TOP_FONT && guard < 60){
        size -= 0.5;
        lbl.style.fontSize = size + 'px';
        guard++;
      }
    });
  }

  /* ========= Accordion Build ========= */
  function buildAccordion(){
    const host = document.querySelector('#ui-pm-work #top-acc');
    if(!host) return;
    host.innerHTML = '';

    FIXED_TOPS.forEach((t,i)=>{
      const wrap = document.createElement('div');
      wrap.className = 'top-acc';
      const groupId = `top-group-${t.id}`;
      wrap.innerHTML = `
        <button class="top-btn ${i===0?'active':''}" data-top="${t.id}" style="--top-h:${hue(t.id)}"
                aria-expanded="${i===0?'true':'false'}" aria-controls="${groupId}">
          <span class="lbl"><span class="ico">${ICON_MAP[t.id]||'‚Ä¢'}</span>${t.label}</span><span aria-hidden="true">‚Ä∫</span>
        </button>
        <div class="top-group ${i===0?'show':''}" data-toplist="${t.id}" id="${groupId}" role="group" aria-label="${t.label} Ï§ëÎ∂ÑÎ•ò"></div>`;
      host.appendChild(wrap);
      autoFitTopLabels();
    });

    // render cats/subs for each top
    FIXED_TOPS.forEach(t=>{
      const grp = host.querySelector(`.top-group[data-toplist="${t.id}"]`);
      const cats = WORK_TREE[t.id]?.cats || [];
      grp.innerHTML = cats.map((cat, idx)=> {
        const catListId = `cat-list-${t.id}-${idx}`;
        return `
          <div class="cat">
            <button class="cat-btn" data-cat="${cat.key}" aria-expanded="false" aria-controls="${catListId}">
              <span>${cat.label}</span><span aria-hidden="true">‚Ä∫</span>
            </button>
            <div class="mid-group" data-catlist="${cat.key}" id="${catListId}" role="group" aria-label="${cat.label} ÏÜåÎ∂ÑÎ•ò">
              ${cat.subs.map((s)=>`<button class="mid" data-mid="${s.id}" aria-current="false">${s.label}</button>`).join('')}
            </div>
          </div>`;
      }).join('');
    });
  }

  /* ========= Routing / Highlights ========= */
  function activateVPage(vpageKey){
    $$('.vpage', vcontent).forEach(p=>p.classList.remove('active'));
    const page = vcontent.querySelector(`.vpage[data-vpage="${vpageKey}"]`);
    if(page){ page.classList.add('active'); }
  }
  function collapseCatsFor(topId){
    const group = document.querySelector(`.top-group[data-toplist="${topId}"]`);
    if(!group) return;
    $$('.cat-btn', group).forEach(b=> { b.classList.remove('active'); b.setAttribute('aria-expanded','false'); });
    $$('.mid-group', group).forEach(m=> m.classList.remove('show'));
    $$('.mid', group).forEach(m=> { m.classList.remove('active'); m.setAttribute('aria-current','false'); });
  }

  function showTop(topId){
    $$('.top-btn').forEach(b=>{
      const on = b.dataset.top===topId;
      b.classList.toggle('active', on);
      b.setAttribute('aria-expanded', on?'true':'false');
    });
    $$('.top-group').forEach(g=> g.classList.toggle('show', g.dataset.toplist===topId));
    collapseCatsFor(topId);
    showHeadFor(topId);
    setTimeout(autoFitTopLabels, 0);
    activateVPage(`${topId}-home`);
    renderKPIs(topId, true);
  }

  /* ========= Table & List helpers ========= */
  function bindTableEvents(scope=root){
    // Add
    $$('[data-add]', scope).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const sel = btn.getAttribute('data-add');
        const tbl = $(sel);
        if(!tbl) return;
        const tr = document.createElement('tr');
        const today = new Date();
        const d = today.toISOString().slice(0,10);
        tr.innerHTML = `
          <td>ÏÉà Ìï≠Î™©</td>
          <td>${d}</td>
          <td>ÏßÑÌñâ</td>
          <td>ÌôçÍ∏∏Îèô</td>
          <td>Î≥¥ÌÜµ</td>
          <td class="row-actions">
            <button class="btn gray" data-edit>ÏàòÏ†ï</button>
            <button class="btn danger" data-del>ÏÇ≠Ï†ú</button>
          </td>`;
        tbl.querySelector('tbody').prepend(tr);
      });
    });
    // Delete
    scope.addEventListener('click', (e)=>{
      const del = e.target.closest('[data-del]');
      if(del){
        const tr = del.closest('tr'); if(tr) tr.remove();
      }
    });
    // Edit
    scope.addEventListener('click', (e)=>{
      const ed = e.target.closest('[data-edit]');
      if(ed){
        const tr = ed.closest('tr'); if(!tr) return;
        const tds = tr.querySelectorAll('td');
        const val = prompt('Ìï≠Î™©Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', tds[0].textContent.trim());
        if(val!==null) tds[0].textContent = val.trim()||'Ìï≠Î™©';
      }
    });
    // Filter (search)
    $$('[data-filter-input]', scope).forEach(inp=>{
      const sel = inp.getAttribute('data-filter-input');
      const tbl = $(sel);
      if(!tbl) return;
      inp.addEventListener('input', ()=>{
        const q = (inp.value||'').toLowerCase();
        tbl.querySelectorAll('tbody tr').forEach(tr=>{
          const text = tr.textContent.toLowerCase();
          tr.style.display = text.includes(q) ? '' : 'none';
        });
      });
    });
    // Status filter
    $$('[data-status-filter]', scope).forEach(sel=>{
      const tbl = $(sel.getAttribute('data-status-filter'));
      if(!tbl) return;
      sel.addEventListener('change', ()=>{
        const v = sel.value;
        tbl.querySelectorAll('tbody tr').forEach(tr=>{
          const st = (tr.children[2]?.textContent||'').trim();
          tr.style.display = (!v || st===v) ? '' : 'none';
        });
      });
    });
    // Export CSV
    $$('[data-export]', scope).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tbl = $(btn.getAttribute('data-export'));
        if(tbl) exportTableCSV(tbl);
      });
    });
    // Sub stats
    $$('[data-open-substats]', scope).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tbl = $(btn.getAttribute('data-open-substats'));
        if(tbl) openSubStatsFromTable(tbl);
      });
    });
  }

  function bindMessenger(scope=root){
    $$('[data-msgform]', scope).forEach(form=>{
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const inp = form.querySelector('[data-msginput]');
        const list = form.closest('.messenger')?.querySelector('[data-msglist]');
        const txt = (inp?.value||'').trim();
        if(!txt || !list) return;
        const tm = new Date(); const hh=String(tm.getHours()).padStart(2,'0'); const mm=String(tm.getMinutes()).padStart(2,'0');
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<b>ME</b><span>${txt}</span><time>${hh}:${mm}</time>`;
        list.appendChild(div);
        inp.value='';
        list.scrollTop = list.scrollHeight;
      });
    });
  }

  /* ========= Global binds ========= */
  function bindGlobal(){
    // Top switch
    root.addEventListener('click', (e)=>{
      const topBtn = e.target.closest('.top-btn');
      if(topBtn){
        const id = topBtn.dataset.top;
        showTop(id);
        renderKPIs(id, true);
      }
    });
    // Cat open/close
    root.addEventListener('click', (e)=>{
      const catBtn = e.target.closest('.cat-btn');
      if(catBtn){
        const key = catBtn.dataset.cat;
        const wrap = catBtn.closest('.cat');
        const list = root.querySelector(`.mid-group[data-catlist="${key}"]`);
        const on = !catBtn.classList.contains('active');
        $$('.cat-btn', wrap.parentElement).forEach(b=>b.classList.remove('active'));
        $$('.mid-group', wrap.parentElement).forEach(m=>m.classList.remove('show'));
        if(on){
          catBtn.classList.add('active');
          catBtn.setAttribute('aria-expanded','true');
          list?.classList.add('show');
          const topId = $('.top-btn.active')?.dataset.top;
          const page = ensureCatHome(topId, key);
          if(page){ activateVPage(page.getAttribute('data-vpage')); renderKPIs(topId, false); }
        }else{
          catBtn.classList.remove('active');
          catBtn.setAttribute('aria-expanded','false');
          list?.classList.remove('show');
        }
      }
    });
    // Mid select
    root.addEventListener('click', (e)=>{
      const mid = e.target.closest('.mid');
      if(mid){
        const subId = mid.dataset.mid;
        $$('.mid').forEach(m=>{ m.classList.remove('active'); m.setAttribute('aria-current','false'); });
        mid.classList.add('active'); mid.setAttribute('aria-current','true');
        ensureSubPage(subId, mid.textContent.trim());
        activateVPage(subId);
        const topId = $('.top-btn.active')?.dataset.top;
        renderKPIs(topId, false);
      }
    });
    // Goto in mini cards
    root.addEventListener('click', (e)=>{
      const go = e.target.closest('[data-goto]');
      if(go){
        const sub = go.getAttribute('data-goto');
        const btn = $(`.mid[data-mid="${sub}"]`);
        if(btn){ btn.click(); }
      }
    });
    // Back to top dashboard
    root.addEventListener('click', (e)=>{
      const back = e.target.closest('[data-back-top]');
      if(back){
        const topId = $('.top-btn.active')?.dataset.top||'pm';
        activateVPage(`${topId}-home`);
        renderKPIs(topId, true);
      }
    });
    // Refresh dash
    root.addEventListener('click', (e)=>{
      const r = e.target.closest('[data-refresh-dash]');
      if(r){
        const topId = r.getAttribute('data-refresh-dash');
        const page = $(`.vpage[data-vpage="${topId}-home"]`);
        if(page){
          page.innerHTML = makeTopDashboard(topId);
          bindTableEvents(page);
          bindMessenger(page);
        }
      }
    });
    // Open stats (dash widgets)
    root.addEventListener('click', (e)=>{
      const st = e.target.closest('[data-open-stats]');
      if(st){
        const key = st.getAttribute('data-open-stats')||'ÌÜµÍ≥Ñ';
        const topId = $('.top-btn.active')?.dataset.top||'pm';
        openWidgetStats({topId, title:key});
      }
    });
    // Open sub summary (mini cards on cat home)
    root.addEventListener('click', (e)=>{
      const st = e.target.closest('[data-open-subsummary]');
      if(st){
        const key = st.getAttribute('data-open-subsummary')||'ÏöîÏïΩ';
        const topId = $('.top-btn.active')?.dataset.top||'pm';
        openWidgetStats({topId, title:key});
      }
    });
    // KPI modal close / generic modal close
    $('#km-close').addEventListener('click', ()=> $('#kpi-modal').hidden = true);
    $('#gm-close').addEventListener('click', ()=> $('#gen-modal').hidden = true);
    $('#kpi-modal').addEventListener('click', ()=> $('#kpi-modal').hidden = true);
    $('#gen-modal').addEventListener('click', ()=> $('#gen-modal').hidden = true);

    // Keyboard
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ $('#kpi-modal').hidden=true; $('#gen-modal').hidden=true; }
      if(e.altKey && (e.key==='p' || e.key==='P')){
        const activeTop = $('.top-btn.active')?.dataset.top||'pm';
        const first = KPIS[activeTop]?.[0];
        if(first) openKpiModal({topId:activeTop, title:first[0], main:normalizeMain(first[0], first[1]), tone:first[3]});
      }
      if(e.altKey && (e.key==='g' || e.key==='G')){
        const activeTop = $('.top-btn.active')?.dataset.top||'pm';
        openWidgetStats({topId:activeTop, title:'ÏöîÏïΩ ÏßÄÌëú'});
      }
    });
  }

  
// [REMOVED SPEC-DRIVEN UI BLOCK]

/* [REMOVED AUTO PATCH vConfirmAndPages_v2 BLOCK] */

/* ========= Boot ========= */
  buildHeaders();
  buildAccordion();
  buildAllPages();
  autoFitTopLabels();
  window.addEventListener('resize', autoFitTopLabels);
  bindTableEvents(root);
  bindMessenger(root);
  bindGlobal();
  showTop('fee'); // Default: General

})();
</script>
</div>


<!-- [REMOVED LEAF STUB RENDERER BLOCK] -->


<style id="mtr-upgrade-style">
/* ===== MTR-001 UPGRADE (visual polish) ===== */
#ui-pm-work .mtr-toolbar{backdrop-filter:saturate(1.2) blur(2px)}
#ui-pm-work .mtr-grid{padding-bottom:4px}
#ui-pm-work .calendar{position:relative; overflow:hidden}
#ui-pm-work .calendar:before{
  content:""; position:absolute; inset:auto -40% -44% -40%; height:140px;
  background:radial-gradient(40% 60% at 50% 0%, rgba(59,130,246,.08), transparent 60%);
  pointer-events:none
}
#ui-pm-work .cal-day{transition:transform .15s ease, box-shadow .15s ease, background-color .3s ease}
#ui-pm-work .cal-day .badge.warn{border-color:#fca5a5; color:#b91c1c; background:linear-gradient(180deg,#fff,#fff5f5)}
#ui-pm-work .cal-day .badge.ok{border-color:#86efac; color:#166534; background:linear-gradient(180deg,#fff,#f1fff5)}
#ui-pm-work .cal-legend{display:flex; gap:8px; align-items:center; margin:8px 0 2px 2px; color:var(--ink-600); font-size:12px}
#ui-pm-work .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:linear-gradient(180deg,#fff,#f7fafc); font-size:12px}
#ui-pm-work .chip .x{cursor:pointer; opacity:.65}
#ui-pm-work .kpi-mini b{font-variant-numeric:tabular-nums}
#ui-pm-work .mtr-table table{table-layout:fixed; width:100%}
#ui-pm-work .mtr-table th, #ui-pm-work .mtr-table td{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:middle}
#ui-pm-work .mtr-table td .pri{margin-left:6px}
#ui-pm-work .pri{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:11px}
#ui-pm-work .pri.high{color:#991b1b; background:#fff1f2; border-color:#fecdd3}
#ui-pm-work .pri.mid{color:#92400e; background:#fffbeb; border-color:#fde68a}
#ui-pm-work .pri.low{color:#065f46; background:#ecfdf5; border-color:#6ee7b7}
#ui-pm-work .row-actions{display:flex; gap:6px; justify-content:flex-end}
#ui-pm-work .pulse{animation:pulse-ring .8s ease-out 2}
@keyframes pulse-ring{0%{box-shadow:0 0 0 0 rgba(59,130,246,.35)}100%{box-shadow:0 0 0 10px rgba(59,130,246,0)}}
/* Drawer */
#ui-pm-work .drawer{position:fixed; top:0; right:-420px; width:400px; height:100%; background:#fff; border-left:1px solid var(--border); box-shadow:var(--sh-3); transition:right .25s var(--ease); z-index:1002; display:flex; flex-direction:column}
#ui-pm-work .drawer.open{right:0}
#ui-pm-work .drawer header{display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border)}
#ui-pm-work .drawer .content{padding:12px; overflow:auto; flex:1}
#ui-pm-work .drawer .row{display:grid; grid-template-columns:100px 1fr; gap:10px; padding:8px 0; border-bottom:1px dashed #eef2f7}
/* Modal */
#ui-pm-work .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1001}
#ui-pm-work .modal.show{display:flex}
#ui-pm-work .backdrop{position:absolute; inset:0; background:rgba(15,23,42,.45); backdrop-filter:blur(2px)}
#ui-pm-work .dialog{position:relative; width:min(640px,92vw); background:#fff; border-radius:14px; border:1px solid var(--border); box-shadow:var(--sh-4); overflow:hidden}
#ui-pm-work .dialog header{padding:10px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
#ui-pm-work .dialog .body{padding:12px}
#ui-pm-work .dialog .foot{padding:12px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end}
/* Toast */
#ui-pm-work .toasts{position:fixed; right:12px; bottom:12px; display:flex; flex-direction:column; gap:8px; z-index:1003}
#ui-pm-work .toast{background:#111827; color:#e5e7eb; border-radius:12px; padding:10px 12px; box-shadow:var(--sh-3); font-size:13px; opacity:.96; transform:translateY(8px); animation:slide-in .2s ease both}
@keyframes slide-in{to{transform:none}}
/* Responsive hide memo on narrow */
@media(max-width:860px){ #ui-pm-work #tbl-mtr th:nth-child(5), #ui-pm-work #tbl-mtr td:nth-child(5){display:none} }
</style>


<script id="mtr-upgrade-script">
(function(g){
  if (g.__MTR_UPGRADE__) return; g.__MTR_UPGRADE__ = true;

  /* Helpers: toast, modal, drawer, chips, shading */
  function showToast(msg){
    const box = document.getElementById('mtr-toasts'); if(!box) return;
    const d = document.createElement('div'); d.className='toast'; d.textContent=msg; box.appendChild(d);
    setTimeout(()=>{ d.style.opacity='.0'; d.style.transform='translateY(-4px)'; setTimeout(()=>d.remove(), 260); }, 2200);
  }
  function openModal(title, bodyHTML, onOk){
    const m = document.getElementById('mtr-modal');
    if(!m){ alert('modal missing'); return; }
    m.querySelector('#modal-title').textContent = title;
    m.querySelector('#modal-body').innerHTML = bodyHTML;
    m.classList.add('show');
    const ok = m.querySelector('#modal-ok');
    const closeAll = ()=> m.classList.remove('show');
    m.querySelectorAll('[data-close]').forEach(b=> b.onclick = closeAll);
    ok.onclick = ()=>{ try{ onOk && onOk(); } finally { closeAll(); } };
  }
  function openDrawer(title, html){
    const dr = document.getElementById('mtr-drawer');
    if(!dr){ console.warn('drawer missing'); return; }
    document.getElementById('drawer-title').textContent = title;
    document.getElementById('drawer-body').innerHTML = html;
    dr.classList.add('open'); dr.setAttribute('aria-hidden','false');
  }
  function closeDrawer(){
    const dr = document.getElementById('mtr-drawer');
    if(!dr) return; dr.classList.remove('open'); dr.setAttribute('aria-hidden','true');
  }
  document.addEventListener('click', (e)=>{ if(e.target && e.target.id==='drawer-close') closeDrawer(); });

  function updateChips(){
    const bar = document.getElementById('mtr-chipbar'); if(!bar) return;
    const owner = document.getElementById('mtr-owner')?.value || '';
    const line  = document.getElementById('mtr-line')?.value || '';
    const pri   = document.getElementById('mtr-priority')?.value || '';
    bar.innerHTML = '';
    [['Îã¥ÎãπÏûê', owner], ['Îèô/ÎùºÏù∏', line], ['Ïö∞ÏÑ†ÏàúÏúÑ', pri]].forEach(([k,v])=>{
      if(v){
        const el = document.createElement('span'); el.className='chip';
        el.innerHTML = '<b>'+k+'</b> '+v+' <span class="x" aria-label="clear">√ó</span>';
        el.querySelector('.x').onclick = ()=>{
          if(k==='Îã¥ÎãπÏûê') document.getElementById('mtr-owner').value='';
          if(k==='Îèô/ÎùºÏù∏') document.getElementById('mtr-line').value='';
          if(k==='Ïö∞ÏÑ†ÏàúÏúÑ') document.getElementById('mtr-priority').value='';
          g.MTR.selDate=null; g.refreshMTR && g.refreshMTR(); updateChips(); highlightWrap();
        };
        bar.appendChild(el);
      }
    });
  }
  function highlightWrap(){
    const wrap = document.getElementById('tbl-wrap');
    if(!wrap) return;
    wrap.classList.remove('pulse'); void wrap.offsetWidth; wrap.classList.add('pulse');
  }
  function shadeFor(rec){
    if(!rec) return '';
    const intensity = Math.min(1, (rec.target||0) / 20);
    const red = Math.min(1, (rec.delayed||0) / Math.max(1,(rec.target||1)));
    const green = Math.min(1, (rec.done||0) / Math.max(1,(rec.target||1)));
    const bg = red>.3 ? '#fee2e2' : (green>.7 ? '#dcfce7' : '#eff6ff');
    const bd = red>.3 ? '#fecaca' : (green>.7 ? '#bbf7d0' : '#c7d2fe');
    return 'background:'+bg+'; border-color:'+bd;
  }

  /* Override: renderMTR001 markup (adds chips, legend, containers) */
  if (typeof g.renderMTR001 === 'function'){
    g.renderMTR001 = function(){
      const now = new Date();
      const curYm = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
      return [
        '<section class="widget" id="MTR-001">',
          '<header>',
            '<h4>ÏõîÍ∞Ñ Í≤ÄÏπ®ÏùºÏ†ï</h4>',
            '<div class="row-actions mtr-head-actions">',
              '<button class="btn" data-mtr-route>ÎùºÏö∞Ìä∏ ÏûêÎèôÏÉùÏÑ±</button>',
              '<button class="btn gray" data-mtr-assign>Î∞∞Ï†ï/Ïû¨Î∞∞Ï†ï</button>',
              '<button class="btn" data-mtr-push>Ìë∏ÏãúÎ∞úÌñâ</button>',
            '</div>',
          '</header>',
          '<div class="mtr-toolbar" id="mtr-toolbar">',
            '<input class="in" type="month" id="mtr-month" value="'+curYm+'" aria-label="Ïõî ÏÑ†ÌÉù"/>',
            '<select class="in select" id="mtr-owner" aria-label="Îã¥ÎãπÏûê ÌïÑÌÑ∞"></select>',
            '<select class="in select" id="mtr-line" aria-label="Îèô/ÎùºÏù∏ ÌïÑÌÑ∞"></select>',
            '<select class="in select" id="mtr-priority" aria-label="Ïö∞ÏÑ†ÏàúÏúÑ ÌïÑÌÑ∞"><option value="">Ïö∞ÏÑ†ÏàúÏúÑ Ï†ÑÏ≤¥</option><option>ÎÇÆÏùå</option><option>Î≥¥ÌÜµ</option><option>ÎÜíÏùå</option></select>',
            '<span style="margin-left:auto"></span>',
            '<span class="pill-mini">Í∂åÌïú: <b style="margin-left:6px" id="perm-badges"></b></span>',
          '</div>',
          '<div style="padding:8px 12px 0 12px; display:flex; gap:8px; flex-wrap:wrap" id="mtr-chipbar"></div>',
          '<div class="mtr-grid">',
            '<div>',
              '<div class="calendar" id="mtr-cal">',
                '<div class="cal-head"><h6 id="mtr-cal-title">Îã¨Î†•</h6><div class="cal-nav"><button class="btn gray" id="mtr-prev" aria-label="Ïù¥Ï†Ñ Îã¨">‚óÄ</button><button class="btn gray" id="mtr-next" aria-label="Îã§Ïùå Îã¨">‚ñ∂</button></div></div>',
                '<div class="cal-legend"><span class="chip"><span style="width:10px;height:10px;border-radius:3px;background:#fee2e2;border:1px solid #fecaca"></span> ÏßÄÏó∞ ÎÜíÏùå</span><span class="chip"><span style="width:10px;height:10px;border-radius:3px;background:#e0e7ff;border:1px solid #c7d2fe"></span> ÏûëÏóÖ ÎßéÏùå</span><span class="chip"><span style="width:10px;height:10px;border-radius:3px;background:#dcfce7;border:1px solid #bbf7d0"></span> ÏôÑÎ£å Ïö∞Ïàò</span></div>',
                '<div class="cal-grid" id="mtr-dows">'+['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'].map(d=>'<div class="cal-dow">'+d+'</div>').join('')+'</div>',
                '<div class="cal-grid" id="mtr-days"></div>',
              '</div>',
            '</div>',
          
            '<div>',
              '<div class="kpi-inline" id="mtr-kpis">',
                '<div class="kpi-mini"><h6>ÎåÄÏÉÅÏàò</h6><b id="kpi-target">0</b></div>',
                '<div class="kpi-mini"><h6>ÏôÑÎ£åÏú®</h6><b id="kpi-done-rate">0%</b></div>',
                '<div class="kpi-mini"><h6>ÏßÄÏó∞Í±¥Ïàò</h6><b id="kpi-delayed">0</b></div>',
              '</div>',
              '<section class="mini" style="margin-top:10px">',
                '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><h6>Í≤ÄÏπ® ÏùºÏ†ï</h6></div>',
                '<div class="table-wrap mtr-table pulse" id="tbl-wrap">',
                  '<table id="tbl-mtr">',
                    '<colgroup><col style="width:110px"/><col style="width:120px"/><col style="width:90px"/><col style="width:120px"/><col/><col style="width:160px"/></colgroup>',
                    '<thead><tr><th>ÏùºÏûê</th><th>Îã¥ÎãπÏûê</th><th>ÎåÄÏÉÅÏàò</th><th>ÏôÑÎ£å/ÏßÄÏó∞</th><th>Î©îÎ™®</th><th>Ï≤òÎ¶¨</th></tr></thead>',
                    '<tbody></tbody>',
                  '</table>',
                '</div>',
              '</section>',
              '<section class="mini" style="margin-top:10px">',
                '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><h6>Ïù¥Î≤§Ìä∏/Î°úÍ∑∏</h6></div>',
                '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">',
                  '<div><div class="pill-mini">ÏùºÏ†ï ÏÉùÏÑ±/ÏàòÏ†ï/Î∞∞Ï†ï</div><div id="mtr-sched-log" class="logbox" aria-label="ÏùºÏ†ï Î°úÍ∑∏"></div></div>',
                  '<div><div class="pill-mini">Ìë∏Ïãú Î°úÍ∑∏</div><div id="mtr-push-log" class="logbox" aria-label="Ìë∏Ïãú Î°úÍ∑∏"></div></div>',
                '</div>',
              '</section>',
            '</div>',
          '</div>',
          '<aside class="drawer" id="mtr-drawer" aria-hidden="true"><header><strong id="drawer-title">ÏÉÅÏÑ∏</strong><button class="btn gray" id="drawer-close">Îã´Í∏∞</button></header><div class="content" id="drawer-body"></div></aside>',
          '<div class="modal" id="mtr-modal"><div class="backdrop" data-close></div><div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modal-title"><header><strong id="modal-title">ÏûëÏóÖ</strong><button class="btn gray" data-close>Îã´Í∏∞</button></header><div class="body" id="modal-body"></div><div class="foot"><button class="btn gray" data-close>Ï∑®ÏÜå</button><button class="btn" id="modal-ok">ÌôïÏù∏</button></div></div></div>',
          '<div class="toasts" id="mtr-toasts"></div>',
        '</section>'
      ].join('');
    };
  }

  /* Override: buildCalendar (visual shading + drawer) */
  if (typeof g.buildCalendar === 'function'){
    g.buildCalendar = function(y, m){
      const daysWrap = document.getElementById('mtr-days');
      const title = document.getElementById('mtr-cal-title');
      title.textContent = y+'ÎÖÑ '+(m+1)+'Ïõî';
      const firstDow = new Date(y,m,1).getDay();
      const last = new Date(y, m+1, 0).getDate();
      const cells = [];
      for(let i=0;i<firstDow;i++) cells.push('<div></div>');
      for(let d=1; d<=last; d++){
        const date = y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
        const rec = g.MTR.data.find(r=>r.date===date);
        const t = rec? rec.target: 0;
        const delayed = rec? rec.delayed: 0;
        const done = rec? rec.done: 0;
        cells.push(
          '<div class="cal-day" data-date="'+date+'" style="'+shadeFor(rec)+'">'
            +'<div class="d">'+d+'</div>'
            +'<div class="badges">'
              +'<span class="badge">ÎåÄÏÉÅ '+t+'</span>'
              +'<span class="badge '+(delayed>0?'warn':'ok')+'">'+(delayed>0? ('ÏßÄÏó∞ '+delayed) : ('ÏôÑÎ£å '+done))+'</span>'
            +'</div>'
          +'</div>'
        );
      }
      daysWrap.innerHTML = cells.join('');
      daysWrap.querySelectorAll('.cal-day').forEach(el=>{
        el.addEventListener('click', ()=>{
          daysWrap.querySelectorAll('.cal-day').forEach(x=>x.classList.remove('selected'));
          el.classList.add('selected');
          g.MTR.selDate = el.getAttribute('data-date');
          g.refreshMTR(); highlightWrap();
          const rec = g.MTR.data.find(r=>r.date===g.MTR.selDate);
          const html = [
            '<div class="row"><div>ÏùºÏûê</div><div>'+g.MTR.selDate+'</div></div>',
            '<div class="row"><div>Îã¥ÎãπÏûê</div><div>'+(rec?rec.owner:'-')+'</div></div>',
            '<div class="row"><div>ÎåÄÏÉÅÏàò</div><div>'+(rec?rec.target:0)+'</div></div>',
            '<div class="row"><div>ÏôÑÎ£å/ÏßÄÏó∞</div><div>'+(rec? (rec.done+'/'+rec.delayed) : '0/0')+'</div></div>',
            '<div class="row"><div>Î©îÎ™®</div><div>'+(rec && rec.memo? rec.memo : '-')+'</div></div>',
            '<div style="padding-top:12px; display:flex; gap:8px"><button class="btn" id="dr-add">ÏùºÏ†ï Ï∂îÍ∞Ä</button><button class="btn gray" id="dr-clear">ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî</button></div>'
          ].join('');
          openDrawer('ÏùºÏ†ï ÏÉÅÏÑ∏', html);
          setTimeout(()=>{
            const btnA = document.getElementById('dr-add');
            const btnC = document.getElementById('dr-clear');
            if(btnA) btnA.onclick = ()=>{
              if(!g.USER_PERMS || !g.USER_PERMS.create){ alert('Í∂åÌïú ÏóÜÏùå: ÏÉùÏÑ±'); return; }
              const who = prompt('Îã¥ÎãπÏûê', (g.SAMPLE_USERS||['ÌôçÍ∏∏Îèô'])[0]); if(!who) return;
              const target = Math.max(1, parseInt(prompt('ÎåÄÏÉÅÏàò', '10')||'10', 10));
              const done = Math.min(target, parseInt(prompt('ÏôÑÎ£åÏàò', String(Math.floor(target*.7)))||'7',10));
              const delayed = Math.max(0, target-done);
              g.MTR.data.push({date:g.MTR.selDate, target, done, delayed, owner:who, line:(g.SAMPLE_LINES||['101'])[0], priority:'Î≥¥ÌÜµ', memo:'Ï∂îÍ∞Ä Îì±Î°ù'});
              g.refreshMTR(); g.buildCalendar(g.MTR.cur.y, g.MTR.cur.m);
              showToast('ÏùºÏ†ïÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§'); g.addLog && g.addLog('schedule','ÏùºÏ†ï Ï∂îÍ∞Ä: '+g.MTR.selDate);
            };
            if(btnC) btnC.onclick = ()=>{ g.MTR.selDate=null; g.refreshMTR(); showToast('ÌïÑÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§'); };
          }, 0);
        });
      });
    };
  }

  /* Override: refreshMTR to add priority badges and pulses */
  if (typeof g.refreshMTR === 'function'){
    const _origRefresh = g.refreshMTR;
    g.refreshMTR = function(){
      _origRefresh();
      // add pri badges + row drawer
      const tb = document.querySelector('#tbl-mtr tbody');
      if(!tb) return;
      // inject priority badges and drawer click
      Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
        const tds = tr.children;
        if(tds && tds[3] && !tds[3].querySelector('.pri')){
          const date = tds[0].textContent.trim();
          const r = g.MTR.data.find(x=>x.date===date);
          if(r){
            const span = document.createElement('span');
            span.className = 'pri '+(r.priority==='ÎÜíÏùå'?'high':(r.priority==='Î≥¥ÌÜµ'?'mid':'low'));
            span.textContent = r.priority;
            tds[3].appendChild(span);
          }
        }
        tr.addEventListener('click', (e)=>{
          if(e.target.closest('.row-actions')) return;
          const date = tr.children[0].textContent.trim();
          const r = g.MTR.data.find(x=>x.date===date); if(!r) return;
          openDrawer('Í≤ÄÏπ® ÏùºÏ†ï ÏÉÅÏÑ∏', [
            '<div class="row"><div>ÏùºÏûê</div><div>'+r.date+'</div></div>',
            '<div class="row"><div>Îã¥ÎãπÏûê</div><div>'+r.owner+'</div></div>',
            '<div class="row"><div>ÎåÄÏÉÅÏàò</div><div>'+r.target+'</div></div>',
            '<div class="row"><div>ÏôÑÎ£å/ÏßÄÏó∞</div><div>'+r.done+' / '+r.delayed+'</div></div>',
            '<div class="row"><div>Ïö∞ÏÑ†ÏàúÏúÑ</div><div>'+r.priority+'</div></div>',
            '<div class="row"><div>Î©îÎ™®</div><div>'+(r.memo||'-')+'</div></div>'
          ].join(''));
        });
      });
      // KPI pulse
      ['kpi-target','kpi-done-rate','kpi-delayed'].forEach(id=>{
        const el = document.getElementById(id)?.parentElement;
        if(el){ el.classList.add('pulse'); setTimeout(()=>el.classList.remove('pulse'), 600); }
      });
    };
  }

  /* Wrap bootMTRPage to attach our enhanced interactions (modals, chips) */
  if (typeof g.bootMTRPage === 'function'){
    const _origBoot = g.bootMTRPage;
    g.bootMTRPage = function(){
      _origBoot();
      // fill select options (owner, line) if empty
      const own = document.getElementById('mtr-owner');
      const lin = document.getElementById('mtr-line');
      if(own && own.options.length<=1 && g.SAMPLE_USERS){
        own.innerHTML = '<option value="">Îã¥ÎãπÏûê Ï†ÑÏ≤¥</option>'+g.SAMPLE_USERS.map(u=>'<option>'+u+'</option>').join('');
      }
      if(lin && lin.options.length<=1 && g.SAMPLE_LINES){
        lin.innerHTML = '<option value="">Îèô/ÎùºÏù∏ Ï†ÑÏ≤¥</option>'+g.SAMPLE_LINES.map(l=>'<option>'+l+'</option>').join('');
      }
      // Perm badges
      const p = g.USER_PERMS || {view:1,create:1,update:1,assign:1,publish:1};
      const b = document.getElementById('perm-badges');
      if(b){
        b.innerHTML = ['Ï°∞Ìöå','ÏÉùÏÑ±','ÏàòÏ†ï','Î∞∞Ï†ï','Î∞úÌñâ'].map((k,i)=>{
          const map=['view','create','update','assign','publish'][i];
          return p[map]? '<span class="pill-mini ok">'+k+'</span>':'<span class="pill-mini">'+k+'</span>';
        }).join(' ');
      }
      // Filter changes -> chips + pulse
      ['mtr-owner','mtr-line','mtr-priority','mtr-month'].forEach(id=>{
        const el = document.getElementById(id);
        if(el){
          el.addEventListener('change', ()=>{ updateChips(); highlightWrap(); }, {capture:true});
        }
      });
      updateChips();
      // Replace actions by capture listeners -> our modals
      const btnRoute  = document.querySelector('[data-mtr-route]');
      const btnAssign = document.querySelector('[data-mtr-assign]');
      const btnPush   = document.querySelector('[data-mtr-push]');

      if(btnRoute){
        btnRoute.addEventListener('click', (e)=>{
          e.preventDefault(); e.stopImmediatePropagation();
          if(!p.create){ alert('Í∂åÌïú ÏóÜÏùå: ÏÉùÏÑ±'); return; }
          openModal('ÎùºÏö∞Ìä∏ ÏûêÎèôÏÉùÏÑ±', [
            '<div style="display:grid; grid-template-columns:160px 1fr; gap:10px; align-items:center">',
              '<label>ÏÉùÏÑ± Í∑úÏπô</label>',
              '<select class="in select" id="route-rule"><option>ÎèôÎ≥Ñ Í∑†Îì±</option><option>Îã¥ÎãπÏûê Î∂ÑÏÇ∞</option><option>ÏßÄÏó∞ Ïö∞ÏÑ†</option></select>',
              '<label>Î™©Ìëú ÏôÑÎ£åÏú®</label>',
              '<input class="in" id="route-target" type="number" min="50" max="100" step="5" value="80"/>',
            '</div>'
          ].join(''), ()=>{
            g.MTR.data = g.generateMTRData(g.MTR.cur.y, g.MTR.cur.m);
            g.buildCalendar(g.MTR.cur.y, g.MTR.cur.m); g.refreshMTR(); updateChips(); highlightWrap();
            g.addLog && g.addLog('schedule','ÎùºÏö∞Ìä∏ ÏûêÎèôÏÉùÏÑ± Ïã§Ìñâ'); showToast('ÎùºÏö∞Ìä∏Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§');
          });
        }, {capture:true});
      }
      if(btnAssign){
        btnAssign.addEventListener('click', (e)=>{
          e.preventDefault(); e.stopImmediatePropagation();
          if(!p.assign){ alert('Í∂åÌïú ÏóÜÏùå: Î∞∞Ï†ï'); return; }
          openModal('Î∞∞Ï†ï/Ïû¨Î∞∞Ï†ï', [
            '<div style="display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:center">',
              '<label>Îã¥ÎãπÏûê</label>',
              '<select id="assign-who" class="in select">'+(g.SAMPLE_USERS||['ÌôçÍ∏∏Îèô']).map(u=>'<option>'+u+'</option>').join('')+'</select>',
              '<label>Î≤îÏúÑ</label>',
              '<div><label><input type="radio" name="assign-scope" value="all" checked/> Ï†ÑÏ≤¥</label> &nbsp; <label><input type="radio" name="assign-scope" value="filtered"/> ÌïÑÌÑ∞ Ï†ÅÏö© Ìñâ</label></div>',
            '</div>'
          ].join(''), ()=>{
            const who = document.getElementById('assign-who').value;
            const scope = (document.querySelector('input[name="assign-scope"]:checked')||{}).value || 'all';
            let rows = g.MTR.data.slice();
            if(scope==='filtered'){
              const owner = document.getElementById('mtr-owner')?.value || '';
              const line  = document.getElementById('mtr-line')?.value || '';
              const pri   = document.getElementById('mtr-priority')?.value || '';
              if(owner) rows = rows.filter(r=>r.owner===owner);
              if(line)  rows = rows.filter(r=>r.line===line);
              if(pri)   rows = rows.filter(r=>r.priority===pri);
            }
            rows.forEach(r=> r.owner = who);
            g.refreshMTR(); showToast('Î∞∞Ï†ïÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§'); g.addLog && g.addLog('schedule', 'ÏùºÍ¥Ñ Î∞∞Ï†ï ‚Üí '+who+' ('+scope+')');
          });
        }, {capture:true});
      }
      if(btnPush){
        btnPush.addEventListener('click', (e)=>{
          e.preventDefault(); e.stopImmediatePropagation();
          if(!p.publish){ alert('Í∂åÌïú ÏóÜÏùå: Î∞úÌñâ'); return; }
          const count = (document.querySelector('#tbl-mtr tbody')?.children.length)||0;
          openModal('Ìë∏Ïãú Î∞úÌñâ ÌôïÏù∏', '<p>ÌòÑÏû¨ ÌôîÎ©¥ Í∏∞Ï§ÄÏúºÎ°ú <b>'+count.toLocaleString()+'</b>Í±¥ ÎåÄÏÉÅÏóêÍ≤å Ìë∏ÏãúÎ•º Î∞úÌñâÌï©ÎãàÎã§.</p><p style="color:#64748b">ÌïÑÌÑ∞/ÏùºÏûê ÏÑ†ÌÉùÏóê Îî∞Îùº Î∞úÌñâ Î≤îÏúÑÍ∞Ä Îã¨ÎùºÏßëÎãàÎã§.</p>', ()=>{
            const target = g.MTR.selDate? '('+g.MTR.selDate+')' : '(Ïõî Ï†ÑÏ≤¥)';
            g.addLog && g.addLog('push', 'Ìë∏Ïãú Î∞úÌñâ '+target); showToast('Ìë∏ÏãúÎ•º Î∞úÌñâÌñàÏäµÎãàÎã§');
          });
        }, {capture:true});
      }
    };
  }

})(window);
</script>


<style id="mtr-fullwidth-patch">
/* === Full-width calendar patch === */
#ui-pm-work .mtr-grid{ grid-template-columns: 1fr !important; }
#ui-pm-work .mtr-grid > div:first-child { grid-column: 1 / -1; } /* calendar row spans full width */
#ui-pm-work .calendar { width: 100%; }
</style>


<!-- ===================== MTR-002 (Î∞∞Ï†ï) ¬∑ STYLE & SCRIPT INJECT ===================== -->
<style id="mtr-assign-style">
:root{
  --brand-500:#3b82f6; --brand-600:#2563eb; --brand-700:#1d4ed8;
  --border:#e8edf4; --muted:#f9fafb; --ink-600:#374151; --ok:#10b981;
  --sh-1:0 1px 2px rgba(12,17,29,.06), 0 1px 1px rgba(12,17,29,.04);
  --sh-3:0 24px 60px rgba(13,23,42,.14), inset 0 1px 0 rgba(255,255,255,.25);
  --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, "Noto Sans KR", "Malgun Gothic", sans-serif;
  --fs-12:12px; --fs-13:13px;
}
#ui-pm-work .assign-toolbar{display:flex;gap:8px;align-items:center;padding:10px 12px;background:linear-gradient(180deg,var(--muted),#fff);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:7}
#ui-pm-work .assign-toolbar .in{height:34px;padding:0 12px;border-radius:12px;border:1px solid var(--border);background:linear-gradient(180deg,#fff,#f8fafc);box-shadow:inset 0 1px 0 rgba(255,255,255,.6);font-size:var(--fs-13)}
#ui-pm-work .assign-toolbar .toggle{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#fff,#f7fafc)}
#ui-pm-work .assign-toolbar .toggle button{height:34px;padding:0 12px;border:0;background:transparent;font-weight:700;cursor:pointer}
#ui-pm-work .assign-toolbar .toggle button.active{background:linear-gradient(180deg,var(--brand-500),var(--brand-700));color:#fff}
#ui-pm-work .assign-chipbar{padding:8px 12px 0 12px;display:flex;gap:8px;flex-wrap:wrap}
#ui-pm-work .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:#fff}
#ui-pm-work .chip .x{cursor:pointer;opacity:.7}
#ui-pm-work .assign-map-full{padding:12px}
#ui-pm-work .assign-map{border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#fff,#fbfdff);padding:10px;box-shadow:var(--sh-1);position:relative;overflow:hidden}
#ui-pm-work .assign-map .map-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
#ui-pm-work .assign-map .legend{display:flex;gap:8px;flex-wrap:wrap;color:#334155;font-size:12px}
#ui-pm-work .assign-map .legend .dot{width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:6px}
#ui-pm-work .assign-map .map-controls{position:absolute;right:10px;top:56px;display:flex;gap:6px;z-index:5}
#ui-pm-work .iconbtn{height:32px;min-width:32px;padding:0 10px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;box-shadow:var(--sh-1);font-weight:700}
#ui-pm-work .assign-map .hintbar{position:absolute;left:10px;bottom:10px;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,.9);border:1px solid var(--border);font-size:12px}
#ui-pm-work .assign-summary{display:flex;gap:10px;flex-wrap:wrap;padding:0 12px 6px 12px}
#ui-pm-work .pill-mini{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:#fff;font-size:12px}
#ui-pm-work .pill-mini.ok{background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.35)}
#ui-pm-work .assign-below{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
@media(max-width:1100px){#ui-pm-work .assign-below{grid-template-columns:1fr}}
#ui-pm-work .assign-card{border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#fff,#fbfdff);padding:10px;box-shadow:var(--sh-1)}
#ui-pm-work .assign-list .item{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-bottom:1px dashed #eef2f7}
#ui-pm-work .assign-table .table-wrap{max-height:420px;overflow:auto}
#ui-pm-work .assign-table table{table-layout:fixed;width:100%}
#ui-pm-work .assign-table th,#ui-pm-work .assign-table td{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;vertical-align:middle}
#ui-pm-work .drag-handle{cursor:grab;opacity:.85}
#ui-pm-work tr.dragging{opacity:.6;background:#eef2ff}
#ui-pm-work .assign-logs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
#ui-pm-work .assign-below > .assign-logs-full{grid-column:1 / -1}

@media(max-width:860px){#ui-pm-work .assign-logs{grid-template-columns:1fr}}
#ui-pm-work .assign-logbox{border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);padding:10px;max-height:220px;overflow:auto}
#ui-pm-work .assign-logbox .log{font-size:var(--fs-12);padding:6px 0;border-bottom:1px dashed #eef2f7;display:flex;gap:10px}
#ui-pm-work .assign-logbox .log:last-child{border-bottom:0}
#ui-pm-work .assign-logbox .ts{color:#64748b;min-width:128px}
#ui-pm-work .assign-toastbox{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:1003}
#ui-pm-work .assign-toast{background:#111827;color:#e5e7eb;border-radius:12px;padding:10px 12px;box-shadow:var(--sh-3);font-size:13px;opacity:.96;transform:translateY(8px);animation:assign-slide-in .2s ease both}
@keyframes assign-slide-in{to{transform:none}}
#ui-pm-work .assign-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1004}
#ui-pm-work .assign-modal.show{display:flex}
#ui-pm-work .assign-modal .backdrop{position:absolute;inset:0;background:rgba(15,23,42,.45);backdrop-filter:blur(2px)}
#ui-pm-work .assign-modal .dialog{position:relative;width:min(560px,92vw);background:#fff;border-radius:14px;border:1px solid var(--border);box-shadow:var(--sh-3);overflow:hidden}
#ui-pm-work .assign-modal header{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
#ui-pm-work .assign-modal .body{padding:12px}
#ui-pm-work .assign-modal .foot{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}

#ui-pm-work .assign-map .map-wrap{height:66vh;max-height:none}
#ui-pm-work #assign-map-svg svg{width:100%;height:100%}
#ui-pm-work .assign-map.fullscreen{position:fixed;inset:10px;background:#fff;border-radius:12px;z-index:9999;box-shadow:0 30px 80px rgba(10,20,30,.25)}
#ui-pm-work .assign-map.fullscreen .map-wrap{height:calc(100vh - 140px)}
</style>

<script id="mtr-assign-script">
(function(g){
  if (g.__MTR_ASSIGN_V2__) return; g.__MTR_ASSIGN_V2__ = true;

  const USERS = (g.SAMPLE_USERS || ['ÌôçÍ∏∏Îèô','ÍπÄÎã¥Îãπ','Ïù¥ÌòÑÏû•','Î∞ïÍ≤ÄÏπ®','ÏµúÏàòÎÇ©']).slice();
  const LINES = (g.SAMPLE_LINES || ['101','102','201','202','301','302']).slice();
  const TYPES = ['Ï†ÑÍ∏∞','ÏàòÎèÑ','Í∞ÄÏä§','Ïó¥Îüâ'];
  const TYPE_COLOR = { 'Ï†ÑÍ∏∞':'#22c55e', 'ÏàòÎèÑ':'#3b82f6', 'Í∞ÄÏä§':'#f97316', 'Ïó¥Îüâ':'#a78bfa' };

  function pad2(n){ return String(n).padStart(2,'0'); }
  function fmtTime(h,m){ return pad2(h)+':'+pad2(m); }
  function nowH(){ const d=new Date(); return d.getHours(); }
  function nowM(){ const d=new Date(); return d.getMinutes(); }

  function genMeters(){
    const arr=[];
    for(let i=1;i<=32;i++){
      const line = LINES[i % LINES.length];
      const type = TYPES[i % TYPES.length];
      const owner= USERS[i % USERS.length];
      const x = 6 + (i*3.0 % 88);
      const y = 10 + (i*4.4 % 72);
      const h = (nowH()+ (i%6))%24, m = (nowM()+ (i*7)%60)%60;
      arr.push({ id:'M-'+line+'-'+pad2(i), line, type, owner, loc: line+'Îèô '+(100+i)+'Ìò∏', eta: fmtTime(h,m), x: Math.round(x*10)/10, y: Math.round(y*10)/10 });
    }
    return arr;
  }

  const ASSIGN = { data: genMeters(), filtered: [], selected:new Set(), booted:false, zoom:1, pan:{x:0,y:0}, heat:false, route:false, showLabels:true };
  g.__ASSIGN_STATE__ = ASSIGN;
  const perms = ()=> Object.assign({view:true, update:true, assign:true, export:true, import:true}, (g.USER_PERMS||{}));
  const ALOG = { route:[], imp:[] };

  function addLog(kind,msg){
    const ts = new Date();
    (ALOG[kind]||[]).push({ts,msg});
    const box = document.getElementById(kind==='imp'?'assign-imp-log':'assign-route-log');
    if(box){ const div=document.createElement('div'); div.className='log'; div.innerHTML = '<span class="ts">'+ts.toLocaleString()+'</span><span>'+msg+'</span>'; box.appendChild(div); box.scrollTop = box.scrollHeight; }
  }
  function toast(msg){
    const host=document.getElementById('assign-toasts'); if(!host) return;
    const d=document.createElement('div'); d.className='assign-toast'; d.textContent=msg; host.appendChild(d);
    setTimeout(()=>{ d.style.opacity='.0'; d.style.transform='translateY(-4px)'; setTimeout(()=>d.remove(), 260); }, 2200);
  }

  function currentFilters(){ return {
    owner: document.getElementById('as-owner')?.value || '',
    line : document.getElementById('as-line')?.value || '',
    type : document.getElementById('as-type')?.value || '',
    q    : (document.getElementById('as-search')?.value||'').toLowerCase()
  };}

  function applyFilters(){
    const f = currentFilters();
    ASSIGN.filtered = ASSIGN.data.filter(d=>{
      if(f.owner && d.owner!==f.owner) return false;
      if(f.line && d.line!==f.line) return false;
      if(f.type && d.type!==f.type) return false;
      const t = (d.id+' '+d.loc+' '+d.owner+' '+d.type).toLowerCase();
      if(f.q && !t.includes(f.q)) return false;
      return true;
    });
    renderChipbar(); renderMap(); renderTable(); renderList(); renderSummary();
  }

  function renderChipbar(){
    const bar = document.getElementById('assign-chipbar'); if(!bar) return;
    bar.innerHTML = '';
    const f = currentFilters();
    [['Îã¥ÎãπÏûê','owner'],['Îèô/ÎùºÏù∏','line'],['Í≥ÑÎüâÍ∏∞Ï¢ÖÎ•ò','type']].forEach(([label,key])=>{
      const v=f[key]; if(!v) return;
      const el=document.createElement('span'); el.className='chip';
      el.innerHTML='<b>'+label+'</b> '+v+' <span class="x" aria-label="clear">√ó</span>';
      el.querySelector('.x').onclick=()=>{ const id=key==='owner'?'as-owner': key==='line'?'as-line':'as-type'; const sel=document.getElementById(id); if(sel){ sel.value=''; applyFilters(); } };
      bar.appendChild(el);
    });
  }

  function projector(x,y){
    const W=720,H=420;
    const cx = 20 + (x/100)*(W-40);
    const cy = 20 + (y/100)*(H-40);
    return {x: (cx + ASSIGN.pan.x), y: (cy + ASSIGN.pan.y)};
  }
  function tableOrderIds(){
    const rows = document.querySelectorAll('#assign-tbl tbody tr');
    return Array.from(rows).map(tr=>tr.getAttribute('data-id'));
  }
  function avgETA(ids){
    if(!ids.length) return '-';
    const mins = ids.map(id=>{
      const r = ASSIGN.data.find(x=>x.id===id); if(!r) return 0;
      const [h,m]=r.eta.split(':').map(Number); return h*60+m;
    });
    const avg = Math.round(mins.reduce((a,b)=>a+b,0)/mins.length);
    return pad2(Math.floor(avg/60))+':'+pad2(avg%60);
  }

  function mapSVG(rows){
    const W=720,H=420;
    const grid = Array.from({length:8},(_,i)=>{ const y=40+i*40; return '<line x1="20" y1="'+y+'" x2="'+(W-20)+'" y2="'+y+'" stroke="#eef2f7" />'; }).join('');
    const walls = '<rect x="20" y="20" width="'+(W-40)+'" height="'+(H-40)+'" rx="12" fill="none" stroke="#e5eaf2"/>';
    const heat = ASSIGN.heat ? rows.map(m=>{ const p=projector(m.x,m.y); return '<circle cx="'+p.x+'" cy="'+p.y+'" r="18" fill="rgba(59,130,246,.10)"/>'; }).join('') : '';
    let route='';
    if(ASSIGN.route){
      const order = tableOrderIds();
      const ordered = (order.length? order : rows.map(r=>r.id)).map(id => rows.find(r=>r.id===id)).filter(Boolean);
      if(ordered.length>1){
        const pts = ordered.map(m=>{ const p=projector(m.x,m.y); return p.x+','+p.y; }).join(' ');
        route = '<polyline points="'+pts+'" fill="none" stroke="#0ea5e9" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>';
      }
    }
    const ms = rows.map(m=>{
      const p=projector(m.x,m.y);
      const sel = ASSIGN.selected.has(m.id);
      const fill = TYPE_COLOR[m.type] || '#64748b';
      const r = sel? 8:6;
      return '<g tabindex="0" data-id="'+m.id+'" class="mk" role="button" aria-label="'+m.id+' '+m.loc+' '+m.eta+'">'
           + '<circle cx="'+p.x+'" cy="'+p.y+'" r="'+r+'" fill="'+fill+'" stroke="'+(sel?'#0f172a':'#fff')+'" stroke-width="'+(sel?2:1)+'"/>'
           + (ASSIGN.showLabels ? '<text x="'+(p.x+10)+'" y="'+(p.y-10)+'" font-size="11" fill="#0f172a">'+m.id+'</text>' : '')
           + '</g>';
    }).join('');
    const scale='scale('+ASSIGN.zoom+')';
    return '<svg viewBox="0 0 '+W+' '+H+'"><g transform="'+scale+'"><rect width="'+W+'" height="'+H+'" fill="#fff"/>'+grid+walls+heat+route+ms+'</g></svg>';
  }
  function renderMap(){
    const cont=document.getElementById('assign-map-svg'); if(!cont) return;
    cont.innerHTML = mapSVG(ASSIGN.filtered);
    const hint=document.getElementById('assign-map-hint');
    if(hint){ const sel=ASSIGN.selected.size; const avg=avgETA(Array.from(ASSIGN.selected)); hint.innerHTML='ÏÑ†ÌÉù: <b>'+sel+'</b>Í∞ú ¬∑ ÌèâÍ∑† ÏòàÏÉÅÏãúÍ∞Ñ <b>'+avg+'</b>'; }
    cont.querySelectorAll('.mk').forEach(gEl=>{
      gEl.addEventListener('click', ()=>{
        const id=gEl.getAttribute('data-id');
        if(ASSIGN.selected.has(id)) ASSIGN.selected.delete(id); else ASSIGN.selected.add(id);
        renderMap(); renderTable(); renderSummary();
      });
      gEl.addEventListener('keypress', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); gEl.click(); }});
    });
  }

  function renderTable(){
    const tb=document.querySelector('#assign-tbl tbody'); if(!tb) return;
    const rows=ASSIGN.filtered.slice();
    tb.innerHTML = rows.map((r,idx)=>{
      const on = ASSIGN.selected.has(r.id)? ' style="background:linear-gradient(180deg,#fff7ed,#fff)"' : '';
      return '<tr draggable="true" data-id="'+r.id+'"'+on+'>'
           + '<td><span class="drag-handle">‚†ø</span> '+pad2(idx+1)+'</td>'
           + '<td>'+r.id+'</td><td>'+r.loc+'</td><td>'+r.eta+'</td><td>'+r.owner+'</td></tr>';
    }).join('');
    tb.querySelectorAll('tr').forEach(tr=>{
      tr.addEventListener('click',(e)=>{
        if(e.target.closest('.drag-handle')) return;
        const id=tr.getAttribute('data-id');
        if(e.metaKey||e.ctrlKey){ if(ASSIGN.selected.has(id)) ASSIGN.selected.delete(id); else ASSIGN.selected.add(id); }
        else{ ASSIGN.selected.clear(); ASSIGN.selected.add(id); }
        renderMap(); renderTable(); renderSummary();
      });
    });
    let dragId=null;
    tb.querySelectorAll('tr').forEach(tr=>{
      tr.addEventListener('dragstart', ()=>{ dragId=tr.getAttribute('data-id'); tr.classList.add('dragging'); });
      tr.addEventListener('dragend',   ()=>{ tr.classList.remove('dragging'); dragId=null; });
      tr.addEventListener('dragover', (e)=>{
        e.preventDefault();
        const over=e.currentTarget, overId=over.getAttribute('data-id');
        if(dragId && overId && dragId!==overId){
          const idOrder=ASSIGN.data.map(x=>x.id);
          const aIdx=idOrder.indexOf(dragId), bIdx=idOrder.indexOf(overId);
          const tmp=ASSIGN.data[aIdx]; ASSIGN.data[aIdx]=ASSIGN.data[bIdx]; ASSIGN.data[bIdx]=tmp;
          applyFilters(); addLog('route','ÎìúÎûòÍ∑∏ Ïû¨Ï†ïÎ†¨: '+dragId+' ‚Üî '+overId);
        }
      });
    });
  }

  function renderList(){
    const ul=document.getElementById('as-eta-top'); if(!ul) return;
    const rows = ASSIGN.filtered.slice().sort((a,b)=> a.eta < b.eta ? -1 : 1).slice(0,6);
    document.getElementById('as-count').textContent = ASSIGN.filtered.length.toLocaleString();
    ul.innerHTML = rows.map((r,i)=> '<li class="item"><span>'+(i+1)+'. '+r.id+' ¬∑ '+r.loc+'</span><b>'+r.eta+'</b></li>').join('');
  }

  function renderSummary(){
    const el=document.getElementById('assign-summary'); if(!el) return;
    const total=ASSIGN.filtered.length, sel=ASSIGN.selected.size, avg=avgETA(Array.from(ASSIGN.selected));
    let dist=0; const ids=Array.from(ASSIGN.selected);
    for(let i=1;i<ids.length;i++){ const a=ASSIGN.data.find(x=>x.id===ids[i-1]), b=ASSIGN.data.find(x=>x.id===ids[i]); if(a&&b){ dist+=Math.hypot(b.x-a.x, b.y-a.y);} }
    el.innerHTML = '<span class="pill-mini">ÎåÄÏÉÅ <b>'+total+'</b></span>'
                 + '<span class="pill-mini ok">ÏÑ†ÌÉù <b>'+sel+'</b></span>'
                 + '<span class="pill-mini">ÌèâÍ∑† ETA <b>'+avg+'</b></span>'
                 + '<span class="pill-mini">Í≤ΩÎ°ú Í∏∏Ïù¥(Î™®Ìòï) <b>'+Math.round(dist)+'</b></span>';
  }

  function exportCSV(selectedOnly=false){
    if(!perms().export){ alert('Í∂åÌïú ÏóÜÏùå: ÎÇ¥Î≥¥ÎÇ¥Í∏∞'); return; }
    const header=['ÏàúÎ≤à','Í≥ÑÎüâÍ∏∞ID','ÏúÑÏπò','ÏòàÏÉÅÏãúÍ∞Ñ','Îã¥ÎãπÏûê'];
    const dataRows=(selectedOnly? ASSIGN.filtered.filter(r=>ASSIGN.selected.has(r.id)) : ASSIGN.filtered);
    const lines=[header.join(',')];
    dataRows.forEach((r,idx)=> lines.push([idx+1,r.id,r.loc,r.eta,r.owner].map(v=>'"'+String(v).replace(/"/g,'""')+'"' ).join(',')));
    const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download= selectedOnly?'MTR-002_selected.csv':'MTR-002_assign.csv'; a.click();
    toast('CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏôÑÎ£å');
  }
  function importCSV(file){
    if(!perms().import){ alert('Í∂åÌïú ÏóÜÏùå: Í∞ÄÏ†∏Ïò§Í∏∞'); return; }
    const reader=new FileReader();
    reader.onload=(e)=>{
      const text=String(e.target.result||''); const rows=text.trim().split(/\r?\n/);
      let ok=0, fail=0;
      for(let i=1;i<rows.length;i++){
        const cols=rows[i].split(',').map(s=>s.replace(/^"|"$/g,''));
        if(cols.length<5){ fail++; continue; }
        const id=cols[1].trim(), loc=cols[2].trim(), eta=cols[3].trim(), owner=cols[4].trim()||USERS[0];
        const line=(loc.split('Îèô')[0]||'101').replace(/\D/g,''), type=TYPES[i%TYPES.length];
        if(!id){ fail++; continue; }
        const ex=ASSIGN.data.find(x=>x.id===id);
        if(ex){ ex.loc=loc; ex.eta=eta; ex.owner=owner; ok++; }
        else{ ASSIGN.data.push({id,loc,eta,owner,line,type,x:10+(i%80),y:10+((i*3)%70)}); ok++; }
      }
      applyFilters(); addLog('imp','Í∞ÄÏ†∏Ïò§Í∏∞ Í≤∞Í≥º: ÏÑ±Í≥µ '+ok+'Í±¥, Ïã§Ìå® '+fail+'Í±¥'); toast('CSV Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å ('+ok+'Í±¥)');
    };
    reader.readAsText(file,'utf-8');
  }

  function openModal(title, bodyHTML, onOk){
    const m=document.getElementById('assign-modal'); if(!m) return;
    m.querySelector('#assign-modal-title').textContent=title;
    m.querySelector('#assign-modal-body').innerHTML=bodyHTML;
    m.classList.add('show');
    const ok=m.querySelector('#assign-modal-ok'); const closeAll=()=>m.classList.remove('show');
    m.querySelectorAll('[data-close]').forEach(b=> b.onclick=closeAll);
    ok.onclick=()=>{ try{ onOk && onOk(); } finally{ closeAll(); } };
  }

  function bindMapControls(){
    const zin=document.getElementById('mc-zoom-in');
    const zout=document.getElementById('mc-zoom-out');
    const fit=document.getElementById('mc-fit');
    const heat=document.getElementById('mc-heat');
    const route=document.getElementById('mc-route');
    zin.onclick = ()=>{ ASSIGN.zoom=Math.min(ASSIGN.zoom+0.1, 2.0); renderMap(); };
    zout.onclick= ()=>{ ASSIGN.zoom=Math.max(ASSIGN.zoom-0.1, 0.6); renderMap(); };
    fit.onclick  = ()=>{ ASSIGN.zoom=1; ASSIGN.pan={x:0,y:0}; renderMap(); };
    heat.onclick = ()=>{ ASSIGN.heat=!ASSIGN.heat; renderMap(); };
    route.onclick= ()=>{ ASSIGN.route=!ASSIGN.route; renderMap(); };
    const full=document.getElementById('mc-full'); if(full){ full.onclick=()=>{ const box=document.getElementById('assign-map'); box.classList.toggle('fullscreen'); }; }
    const labels=document.getElementById('mc-labels'); if(labels){ labels.onclick=()=>{ ASSIGN.showLabels=!ASSIGN.showLabels; renderMap(); }; }
  }

  function renderMTR002(){
    const perm=perms();
    const permHTML=['Ï°∞Ìöå','ÏàòÏ†ï','Î∞∞Ï†ï','ÎÇ¥Î≥¥ÎÇ¥Í∏∞','Í∞ÄÏ†∏Ïò§Í∏∞'].map((k,i)=>{
      const key=['view','update','assign','export','import'][i];
      return perm[key]? '<span class="pill-mini ok">'+k+'</span>':'<span class="pill-mini">'+k+'</span>';
    }).join(' ');

    return [
      '<div id="ui-pm-work">',
      '<section class="widget" id="MTR-002">',
        '<header>',
          '<h4>Î∞∞Ï†ï</h4>',
          '<div class="row-actions">',
            '<button class="iconbtn" id="as-clear">ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî</button>',
            '<button class="iconbtn" id="as-export-sel">ÏÑ†ÌÉù ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>',
            '<button class="iconbtn" id="as-batch">Î¨∂Ïùå Î∞∞Ï†ï</button>',
            '<button class="iconbtn" id="as-export">CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>',
            '<button class="iconbtn" id="as-import">CSV Í∞ÄÏ†∏Ïò§Í∏∞</button>',
            '<input type="file" id="as-import-file" accept=".csv" style="display:none" />',
            '<span class="assign-perms pill-mini">Í∂åÌïú: <b style="margin-left:6px">'+permHTML+'</b></span>',
          '</div>',
        '</header>',
        '<div class="assign-toolbar">',
          '<input class="in search" id="as-search" placeholder="Í≥ÑÎüâÍ∏∞ID/Ï£ºÏÜå/Îã¥ÎãπÏûê Í≤ÄÏÉâ" />',
          '<select class="in select" id="as-owner"><option value="">Îã¥ÎãπÏûê Ï†ÑÏ≤¥</option>'+USERS.map(u=>'<option>'+u+'</option>').join('')+'</select>',
          '<select class="in select" id="as-line"><option value="">Îèô/ÎùºÏù∏ Ï†ÑÏ≤¥</option>'+LINES.map(l=>'<option>'+l+'</option>').join('')+'</select>',
          '<select class="in select" id="as-type"><option value="">Í≥ÑÎüâÍ∏∞Ï¢ÖÎ•ò Ï†ÑÏ≤¥</option>'+TYPES.map(t=>'<option>'+t+'</option>').join('')+'</select>',
          '<span style="margin-left:auto"></span>',
          '<div class="toggle" role="tablist" aria-label="ÏßÄÎèÑ/Î¶¨Ïä§Ìä∏ Î≥¥Í∏∞">',
            '<button type="button" id="as-mode-map"  class="active" aria-selected="true">ÏßÄÎèÑ</button>',
            '<button type="button" id="as-mode-list" aria-selected="false">Î¶¨Ïä§Ìä∏</button>',
          '</div>',
        '</div>',
        '<div class="assign-chipbar" id="assign-chipbar"></div>',
        '<div class="assign-map-full">',
          '<section class="assign-map" id="assign-map" aria-label="Í≥ÑÎüâÍ∏∞ ÏßÄÎèÑ">',
            '<div class="map-head">',
              '<div class="legend">',
                '<span><span class="dot" style="background:#22c55e"></span>Ï†ÑÍ∏∞</span>',
                '<span><span class="dot" style="background:#3b82f6"></span>ÏàòÎèÑ</span>',
                '<span><span class="dot" style="background:#f97316"></span>Í∞ÄÏä§</span>',
                '<span><span class="dot" style="background:#a78bfa"></span>Ïó¥Îüâ</span>',
              '</div>',
              '<div class="pill-mini">ÏßÄÎèÑ Ï†ÑÌè≠ Î≥¥Í∏∞ ¬∑ ÌôïÎåÄ/Ï∂ïÏÜå/ÌûàÌä∏Îßµ/Í≤ΩÎ°úÏÑ†</div>',
            '</div>',
            '<div class="map-controls">',
              '<button class="iconbtn" id="mc-zoom-in">Ôºã</button>',
              '<button class="iconbtn" id="mc-zoom-out">Ôºç</button>',
              '<button class="iconbtn" id="mc-fit">Fit</button>',
              '<button class="iconbtn" id="mc-heat">ÌûàÌä∏Îßµ</button>',
              '<button class="iconbtn" id="mc-route">Í≤ΩÎ°úÏÑ†</button>',
              '<button class="iconbtn" id="mc-labels">ÎùºÎ≤®</button>',
              '<button class="iconbtn" id="mc-full">Ï†ÑÏ≤¥ÌôîÎ©¥</button>',
            '</div>',
            '<div class="map-wrap" id="assign-map-svg" style="height:66vh"></div>',
            '<div class="hintbar" id="assign-map-hint">ÏÑ†ÌÉù: 0Í∞ú ¬∑ ÌèâÍ∑† ÏòàÏÉÅÏãúÍ∞Ñ -</div>',
          '</section>',
        '</div>',
        '<div class="assign-summary" id="assign-summary"></div>',
        '<div class="assign-below">',
          '<section class="assign-card assign-list">',
            '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">',
              '<h6 style="margin:0;font:800 13px/1 var(--font)">ÏòàÏÉÅÏãúÍ∞Ñ ÏÉÅÏúÑ</h6>',
              '<div class="pill-mini">Ï¥ù <b id="as-count">0</b>Í∞ú</div>',
            '</div>',
            '<ul class="list" id="as-eta-top"></ul>',
          '</section>',
          '<div>',
            '<section class="assign-card assign-table">',
              '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">',
                '<h6 style="margin:0;font:800 13px/1 var(--font)">Î∞∞Ï†ï ÎåÄÏÉÅ ÌÖåÏù¥Î∏î</h6>',
                '<div class="pill-mini">ÎìúÎûòÍ∑∏ Ïû¨Ï†ïÎ†¨ ÏßÄÏõê</div>',
              '</div>',
              '<div class="table-wrap">',
                '<table id="assign-tbl">',
                  '<colgroup><col style="width:100px"/><col style="width:120px"/><col/><col style="width:110px"/><col style="width:110px"/></colgroup>',
                  '<thead><tr><th>ÏàúÎ≤à</th><th>Í≥ÑÎüâÍ∏∞ID</th><th>ÏúÑÏπò</th><th>ÏòàÏÉÅÏãúÍ∞Ñ</th><th>Îã¥ÎãπÏûê</th></tr></thead>',
                  '<tbody></tbody>',
                '</table>',
              '</div>',
            '</section>',
            '</div>',
        '<section class="assign-card assign-logs-full" style="margin-top:10px">',
,
              '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">',
                '<h6 style="margin:0;font:800 13px/1 var(--font)">Ïù¥Î≤§Ìä∏/Î°úÍ∑∏</h6>',
              '</div>',
              '<div class="assign-logs">',
                '<div><div class="pill-mini">ÎùºÏö∞Ìä∏ Ìé∏ÏßëÏù¥Î†•</div><div id="assign-route-log" class="assign-logbox"></div></div>',
                '<div><div class="pill-mini">Í∞ÄÏ†∏Ïò§Í∏∞ Í≤∞Í≥º</div><div id="assign-imp-log" class="assign-logbox"></div></div>',
              '</div>',
            '</section>',
'</div>',
        '<div class="assign-toastbox" id="assign-toasts"></div>',
        '<div class="assign-modal" id="assign-modal"><div class="backdrop" data-close></div><div class="dialog" role="dialog" aria-modal="true" aria-labelledby="assign-modal-title"><header><strong id="assign-modal-title">ÏûëÏóÖ</strong><button class="iconbtn" data-close>Îã´Í∏∞</button></header><div class="body" id="assign-modal-body"></div><div class="foot"><button class="iconbtn" data-close>Ï∑®ÏÜå</button><button class="iconbtn" id="assign-modal-ok">ÌôïÏù∏</button></div></div></div>',
      '</section>',
      '</div>'
    ].join('');
  }

  function boot(){
    // filters
    ['as-owner','as-line','as-type'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.addEventListener('change', ()=>{ ASSIGN.selected.clear(); applyFilters(); });
    });
    const sch=document.getElementById('as-search'); if(sch) sch.addEventListener('input', ()=> applyFilters());

    // view toggle UI
    const bMap=document.getElementById('as-mode-map');
    const bList=document.getElementById('as-mode-list');
    bMap.onclick=()=>{ bMap.classList.add('active'); bList.classList.remove('active'); };
    bList.onclick=()=>{ bList.classList.add('active'); bMap.classList.remove('active'); };

    // actions
    const btnClear=document.getElementById('as-clear'); if(btnClear) btnClear.onclick=()=>{ ASSIGN.selected.clear(); renderMap(); renderTable(); renderSummary(); };
    const btnExpSel=document.getElementById('as-export-sel'); if(btnExpSel) btnExpSel.onclick=()=> exportCSV(true);
    const btnExp=document.getElementById('as-export'); if(btnExp) btnExp.onclick=()=> exportCSV(false);
    const btnImp=document.getElementById('as-import'); const finp=document.getElementById('as-import-file');
    if(btnImp && finp){ btnImp.onclick=()=>{ if(!perms().import){ alert('Í∂åÌïú ÏóÜÏùå: Í∞ÄÏ†∏Ïò§Í∏∞'); return; } finp.click(); }; finp.onchange=(e)=>{ const f=e.target.files?.[0]; if(f) importCSV(f); e.target.value=''; }; }

    const btnBatch=document.getElementById('as-batch');
    if(btnBatch){
      btnBatch.onclick=()=>{
        if(!perms().assign){ alert('Í∂åÌïú ÏóÜÏùå: Î∞∞Ï†ï'); return; }
        const ids = (ASSIGN.selected.size>0? Array.from(ASSIGN.selected) : ASSIGN.filtered.map(x=>x.id));
        const body = '<div style="display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center">'
                   + '<label>ÎåÄÏÉÅ</label><div>'+ids.length+'Í∞ú</div>'
                   + '<label>Îã¥ÎãπÏûê</label><select id="as-assign-who" class="in select">'+USERS.map(u=>'<option>'+u+'</option>').join('')+'</select></div>';
        openModal('Î¨∂Ïùå Î∞∞Ï†ï', body, ()=>{
          const who=document.getElementById('as-assign-who').value;
          ASSIGN.data.forEach(r=>{ if(ids.includes(r.id)) r.owner=who; });
          applyFilters(); toast('Î∞∞Ï†ï ÏôÑÎ£å: '+who+' ('+ids.length+'Í∞ú)'); addLog('route','Î¨∂Ïùå Î∞∞Ï†ï ‚Üí '+who+' : '+ids.length+'Í∞ú');
        });
      };
    }

    bindMapControls();
  }

  function mountIfNeeded(){
    if(ASSIGN.booted) return;
    const page=document.querySelector('.vpage[data-vpage="MTR-002"]');
    if(page && !page.__assignReady){
      page.innerHTML = renderMTR002();
      page.__assignReady = true; ASSIGN.booted = true;
      applyFilters(); setTimeout(boot, 0);
    }
  }

  document.addEventListener('click', (e)=>{
    const mid=e.target.closest('.mid[data-mid="MTR-002"]');
    if(mid){ setTimeout(mountIfNeeded, 0); }
  });
  setTimeout(mountIfNeeded, 400);
})(window);
</script>
<!-- =================== END MTR-002 (Î∞∞Ï†ï) INJECT =================== -->


<!-- ===================== MTR-101 (ÏûêÎèôÍ≤ÄÏπ® AMI ÌòÑÌô©) ¬∑ STYLE & SCRIPT INJECT ===================== -->
<style id="mtr-ami-style">
:root{
  --brand-500:#3b82f6; --brand-600:#2563eb; --brand-700:#1d4ed8;
  --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --muted:#f9fafb; --ink-500:#6b7280; --ink-700:#374151;
  --border:#e8edf4; --fs-12:12px; --fs-13:13px; --sh-1:0 1px 2px rgba(12,17,29,.06), 0 1px 1px rgba(12,17,29,.04);
  --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, "Noto Sans KR", "Malgun Gothic", sans-serif;
}
#ui-pm-work .ami-toolbar{display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:7;background:linear-gradient(180deg,#fff,#fbfdff);padding:10px;border-radius:14px 14px 0 0}
#ui-pm-work .ami-toolbar .in{height:34px;padding:0 12px;border:1px solid var(--border);border-radius:10px;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.6);font-size:var(--fs-13)}
#ui-pm-work .ami-toolbar .select{width:140px;appearance:none;padding-right:28px;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16'%3E%3Cpath fill='%237b8794' d='M2.3 6.4L3.2 5.5 8 10.3l4.8-4.8.9.9L8 12 2.3 6.4l.9-.9z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 8px center;}
#ui-pm-work .ami-toolbar .chip{display:inline-flex;gap:6px;align-items:center;padding:0 10px;height:28px;border-radius:999px;background:#f3f6fb;border:1px solid #e7ecf5;font-size:var(--fs-12)}
#ui-pm-work .ami-toolbar .pill{display:inline-flex;align-items:center;height:28px;padding:0 10px;border-radius:10px;border:1px solid var(--border);background:#fff}
#ui-pm-work .ami-toolbar .pill small{color:var(--ink-500)}

#ui-pm-work .kpi-grid{display:grid;gap:12px;margin:12px 0 16px;grid-template-columns:repeat(2,1fr)}
@media(min-width:1024px){#ui-pm-work .kpi-grid{grid-template-columns:repeat(4,1fr)}}
#ui-pm-work .kpi{border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;box-shadow:var(--sh-1)}
#ui-pm-work .kpi h6{margin:0 0 8px;font:800 13px/1 var(--font);color:#111827}
#ui-pm-work .kpi .big{font:800 20px/1 var(--font)}
#ui-pm-work .kpi .muted{font-size:var(--fs-12);color:var(--ink-500)}
#ui-pm-work .bar{height:8px;background:#eef2f7;border-radius:999px;overflow:hidden}
#ui-pm-work .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--brand-500),var(--brand-700));border-radius:999px}

#ui-pm-work .ami-grid{display:grid;grid-template-columns: 1fr;gap:12px;padding:12px}
#ui-pm-work .ami-table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff}
#ui-pm-work .ami-table thead th{position:sticky;top:0;background:linear-gradient(180deg,#fff,#f8fafc);border-bottom:1px solid var(--border);text-align:left;font:700 var(--fs-13)/1 var(--font);padding:10px;color:#111827}
#ui-pm-work .ami-table tbody td{border-bottom:1px solid var(--border);padding:10px;font-size:var(--fs-13)}
#ui-pm-work .ami-table tbody tr:hover{background:#fbfdff}
#ui-pm-work .ami-table tbody tr.sel{background:rgba(37,99,235,.08)}
#ui-pm-work .status{display:inline-flex;align-items:center;gap:6px;height:22px;padding:0 8px;border-radius:999px;font-size:11px;border:1px solid var(--border)}
#ui-pm-work .status.ok{background:#ecfdf5;color:#065f46;border-color:#d1fae5}
#ui-pm-work .status.bad{background:#fef2f2;color:#991b1b;border-color:#fee2e2}
#ui-pm-work .qflag{display:inline-flex;gap:6px;align-items:center}
#ui-pm-work .qflag .dot{width:8px;height:8px;border-radius:50%}
#ui-pm-work .qflag.a .dot{background:#10b981} .qflag.b .dot{background:#f59e0b} .qflag.c .dot{background:#ef4444}

#ui-pm-work .ami-logs{display:grid;gap:12px;grid-template-columns:1fr 1fr;grid-column:1/-1}
@media(max-width:1200px){#ui-pm-work .ami-logs{grid-template-columns:1fr}}
#ui-pm-work .logbox{border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);padding:8px;max-height:240px;overflow:auto}
#ui-pm-work .logbox .item{display:flex;gap:8px;align-items:center;border-bottom:1px dashed #edf2f7;padding:6px 4px;font-size:var(--fs-12)}
#ui-pm-work .logbox .item:last-child{border-bottom:0}
#ui-pm-work .logbox .t{font-weight:800}
#ui-pm-work .logbox .k{padding:0 8px;height:20px;border-radius:999px;border:1px solid var(--border);display:inline-flex;align-items:center;font-size:11px}
#ui-pm-work .logbox .k.ok{background:#ecfdf5;color:#065f46;border-color:#d1fae5} 
#ui-pm-work .logbox .k.fail{background:#fef2f2;color:#991b1b;border-color:#fee2e2}
#ui-pm-work .logbox .k.fault{background:#fff7ed;color:#9a3412;border-color:#ffedd5}
#ui-pm-work .logbox .k.recover{background:#eff6ff;color:#1e40af;border-color:#dbeafe}

#ui-pm-work .row-actions .iconbtn{height:28px;line-height:26px;padding:0 10px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
#ui-pm-work .perm-pill{margin-left:8px}

/* --- Fix: prevent clipping in AMI widget & allow toolbar to wrap --- */
#ui-pm-work #MTR-101{ overflow: visible !important; }
#ui-pm-work .ami-toolbar{ flex-wrap: wrap; padding-right:16px; }
#ui-pm-work .ami-toolbar > *{ min-width: 0; } /* allow flex children to shrink */

/* --- Spacing & modal helpers --- */
#ui-pm-work .kpi-grid{ gap:16px; padding:0 12px; }
@media(min-width:1024px){ #ui-pm-work .kpi-grid{ padding:0 16px; } }
#ui-pm-work .kpi{ cursor:pointer; }

#ui-pm-work .modal-scroll{ max-height:50vh; overflow:auto; }
#ui-pm-work .mini-table{ width:100%; border-collapse:separate; border-spacing:0; }
#ui-pm-work .mini-table th, 
#ui-pm-work .mini-table td{ text-align:left; font-size:12px; padding:6px 8px; border-bottom:1px solid var(--border); }
#ui-pm-work .mini-table thead th{ font-weight:800; background:#f8fafc; }
#ui-pm-work .bar-mini{ height:6px; background:#eef2f7; border-radius:999px; overflow:hidden }
#ui-pm-work .bar-mini>i{ display:block; height:100%; background:linear-gradient(90deg,var(--brand-500),var(--brand-700)); }
</style>



<script id="mtr-ami-script">
(function(g){
  if(g.__MTR101_BOOT__) return; g.__MTR101_BOOT__=true;

  const $ = (sel, p=document)=> p.querySelector(sel);
  const $$= (sel, p=document)=> Array.from(p.querySelectorAll(sel));
  const now = ()=> new Date();
  const fmt = (d)=>{ const z=n=> (''+n).padStart(2,'0'); return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate())+' '+z(d.getHours())+':'+z(d.getMinutes())+':'+z(d.getSeconds()); };

  const providers = ['ÌïúÏ†Ñ(KEPCO)', 'ÏΩîÏõêÏóêÎÑàÏßÄ', 'ÏÑúÏö∏ÏãúÏàòÎèÑ', 'ÏÇºÏ≤úÎ¶¨ÎèÑÏãúÍ∞ÄÏä§'];
  const complexes = ['ÎûòÎØ∏ÏïàA','ÏûêÏù¥B','Ìë∏Î•¥ÏßÄÏò§C'];
  const utils = ['Ï†ÑÍ∏∞','Í∞ÄÏä§','ÏàòÎèÑ'];
  const rnd = (n)=> Math.floor(Math.random()*n);

  function genAMI(n=120){
    const rows=[];
    for(let i=0;i<n;i++){
      const cx = complexes[rnd(complexes.length)];
      const dong = 100 + rnd(5);
      const ho = 101 + rnd(20);
      const util = utils[rnd(utils.length)];
      const pv = providers[rnd(providers.length)];
      const last = new Date(Date.now() - (rnd(48)+1)*3600*1000 * Math.random());
      const ok = Math.random()>0.15;
      const quality = Math.random()<0.7? 'A': (Math.random()<0.85?'B':'C');
      const val = (1000 + rnd(90000)) + rnd(99)/100;
      rows.push({ id: util[0].toUpperCase()+String(i+101).padStart(5,'0'),
                  complex:cx, dong, ho, util, provider:pv,
                  lastSeen:last, status: ok?'OK':'FAULT', recv: ok? 'ÏÑ±Í≥µ':'Ïã§Ìå®', cum: val, q:quality });
    }
    return rows;
  }

  const AMI = {
    data: genAMI(120),
    filtered: [],
    selected: new Set(),
    booted: false,
    perm: ()=> Object.assign({view:true, export:true, retry:true}, (g.USER_PERMS||{}), (g.USER_PERMS_101||{})),
    logs: { recv:[], fault:[] }
  };
  g.__AMI_STATE__ = AMI;
  // Index by ID for quick lookup
  function buildIndex(){
    AMI.index = Object.create(null);
    (AMI.data||[]).forEach(r=> AMI.index[r.id]=r);
  }
  buildIndex();

  function pct(a,b){ return b? Math.round(a/b*100):0; }

  // KPI modal generators
  function kpiModalHTML(kind){
    const rows = AMI.filtered.length? AMI.filtered : AMI.data;
    if(kind===0){ // ÏàòÏã†Ïú® breakdown (Ïú†Ìã∏Î¶¨Ìã∞/Í≥µÍ∏âÏÇ¨)
      const byUtil = ['Ï†ÑÍ∏∞','Í∞ÄÏä§','ÏàòÎèÑ'].map(u=>{
        const tot = rows.filter(r=> r.util===u).length;
        const ok  = rows.filter(r=> r.util===u && r.status==='OK').length;
        return {u, tot, ok, pr:pct(ok,tot)};
      });
      const byPv = ['ÌïúÏ†Ñ(KEPCO)','ÏΩîÏõêÏóêÎÑàÏßÄ','ÏÑúÏö∏ÏãúÏàòÎèÑ','ÏÇºÏ≤úÎ¶¨ÎèÑÏãúÍ∞ÄÏä§'].map(pv=>{
        const tot = rows.filter(r=> r.provider===pv).length;
        const ok  = rows.filter(r=> r.provider===pv && r.status==='OK').length;
        return {pv, tot, ok, pr:pct(ok,tot)};
      });
      return [
        '<div class="modal-scroll">',
          '<h4 style="margin:0 0 6px">ÏàòÏã†Ïú® ÏÑ∏Î∂Ä ÌÜµÍ≥Ñ</h4>',
          '<table class="mini-table"><thead><tr><th>Ïú†Ìã∏Î¶¨Ìã∞</th><th>Ï†ïÏÉÅ</th><th>Ï¥ùÍ≥Ñ</th><th>ÏàòÏã†Ïú®</th><th style="width:40%">Í∑∏ÎûòÌîÑ</th></tr></thead><tbody>',
            byUtil.map(o=> '<tr><td>'+o.u+'</td><td>'+o.ok+'</td><td>'+o.tot+'</td><td>'+o.pr+'%</td><td><div class="bar-mini"><i style="width:'+o.pr+'%"></i></div></td></tr>').join(''),
          '</tbody></table>',
          '<div style="height:8px"></div>',
          '<table class="mini-table"><thead><tr><th>Í≥µÍ∏âÏÇ¨</th><th>Ï†ïÏÉÅ</th><th>Ï¥ùÍ≥Ñ</th><th>ÏàòÏã†Ïú®</th><th style="width:40%">Í∑∏ÎûòÌîÑ</th></tr></thead><tbody>',
            byPv.map(o=> '<tr><td>'+o.pv+'</td><td>'+o.ok+'</td><td>'+o.tot+'</td><td>'+o.pr+'%</td><td><div class="bar-mini"><i style="width:'+o.pr+'%"></i></div></td></tr>').join(''),
          '</tbody></table>',
        '</div>'
      ].join('');
    }
    if(kind===1){ // ÏµúÍ∑º ÏàòÏã† Top10
      const top = rows.slice().sort((a,b)=> b.lastSeen-a.lastSeen).slice(0,10);
      return [
        '<div class="modal-scroll">',
          '<h4 style="margin:0 0 6px">ÏµúÍ∑º ÏàòÏã† Top 10</h4>',
          '<table class="mini-table"><thead><tr><th>Í≥ÑÎüâÍ∏∞ID</th><th>Ï£ºÏÜå</th><th>Ïú†Ìã∏Î¶¨Ìã∞</th><th>ÏµúÍ∑ºÏàòÏã†</th><th>ÏÉÅÌÉú</th></tr></thead><tbody>',
            top.map(r=> '<tr><td>'+r.id+'</td><td>'+r.complex+' '+r.dong+'/'+r.ho+'</td><td>'+r.util+'</td><td>'+fmt(r.lastSeen)+'</td><td>'+ (r.status==='OK'?'Ï†ïÏÉÅ':'Ïû•Ïï†') +'</td></tr>').join(''),
          '</tbody></table>',
        '</div>'
      ].join('');
    }
    if(kind===2){ // Ïû•Ïï†ÏÉÅÌÉú Î∂ÑÏÑù
      const nowTS = Date.now();
      const faultRows = rows.filter(r=> r.status!=='OK' || (nowTS - r.lastSeen.getTime() > 6*3600*1000));
      const buckets = [
        {name:'6~12ÏãúÍ∞Ñ', from:6, to:12},
        {name:'12~24ÏãúÍ∞Ñ', from:12, to:24},
        {name:'24~48ÏãúÍ∞Ñ', from:24, to:48},
        {name:'48ÏãúÍ∞Ñ+', from:48, to:9999},
      ];
      function hoursAgo(ts){ return Math.floor((nowTS - ts)/3600e3); }
      const lines = faultRows.map(r=> ({id:r.id, addr:r.complex+' '+r.dong+'/'+r.ho, util:r.util, hours: hoursAgo(r.lastSeen.getTime())}))
                             .sort((a,b)=> b.hours-a.hours);
      return [
        '<div class="modal-scroll">',
          '<h4 style="margin:0 0 6px">Ïû•Ïï† ÏßÄÏÜç Íµ¨Í∞Ñ Î∂ÑÌè¨</h4>',
          '<table class="mini-table"><thead><tr><th>Íµ¨Í∞Ñ</th><th>Í±¥Ïàò</th></tr></thead><tbody>',
            buckets.map(b=>{
              const c = lines.filter(x=> x.hours>=b.from && x.hours<b.to).length;
              return '<tr><td>'+b.name+'</td><td>'+c+'</td></tr>';
            }).join(''),
          '</tbody></table>',
          '<div style="height:8px"></div>',
          '<h4 style="margin:6px 0">ÏÉÅÏúÑ Ïû•Ïï† Î¶¨Ïä§Ìä∏</h4>',
          '<table class="mini-table"><thead><tr><th>Í≥ÑÎüâÍ∏∞ID</th><th>Ï£ºÏÜå</th><th>Ïú†Ìã∏Î¶¨Ìã∞</th><th>Í≤ΩÍ≥º(ÏãúÍ∞Ñ)</th></tr></thead><tbody>',
            lines.slice(0,15).map(r=> '<tr><td>'+r.id+'</td><td>'+r.addr+'</td><td>'+r.util+'</td><td>'+r.hours+'</td></tr>').join(''),
          '</tbody></table>',
        '</div>'
      ].join('');
    }
    if(kind===3){ // Í≥µÍ∏âÏÇ¨Î≥Ñ ÏàòÏã†ÌòÑÌô©
      const pvList = ['ÌïúÏ†Ñ(KEPCO)','ÏΩîÏõêÏóêÎÑàÏßÄ','ÏÑúÏö∏ÏãúÏàòÎèÑ','ÏÇºÏ≤úÎ¶¨ÎèÑÏãúÍ∞ÄÏä§'];
      const stats = pvList.map(pv=>{
        const tot = rows.filter(r=> r.provider===pv).length;
        const ok  = rows.filter(r=> r.provider===pv && r.status==='OK').length;
        return {pv, tot, ok, pr:pct(ok,tot)};
      });
      return [
        '<div class="modal-scroll">',
          '<h4 style="margin:0 0 6px">Í≥µÍ∏âÏÇ¨Î≥Ñ ÏàòÏã†ÌòÑÌô©</h4>',
          '<table class="mini-table"><thead><tr><th>Í≥µÍ∏âÏÇ¨</th><th>Ï†ïÏÉÅ</th><th>Ï¥ùÍ≥Ñ</th><th>ÏàòÏã†Ïú®</th><th style="width:40%">Í∑∏ÎûòÌîÑ</th></tr></thead><tbody>',
            stats.map(o=> '<tr><td>'+o.pv+'</td><td>'+o.ok+'</td><td>'+o.tot+'</td><td>'+o.pr+'%</td><td><div class="bar-mini"><i style="width:'+o.pr+'%"></i></div></td></tr>').join(''),
          '</tbody></table>',
        '</div>'
      ].join('');
    }
    return '<div>Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';
  }

  function openKpiModal(kind){
    const titles = ['AMI ÏàòÏã†Ïú®', 'ÏµúÍ∑º ÏàòÏã†ÏãúÍ∞Å', 'Ïû•Ïï†ÏÉÅÌÉú', 'Í≥µÍ∏âÏÇ¨Î≥Ñ ÏàòÏã†ÌòÑÌô©'];
    openModal(titles[kind]+' ¬∑ ÏÉÅÏÑ∏ ÌÜµÍ≥Ñ', kpiModalHTML(kind));
  }

  function bindKpiEvents(){
    const page = findContainer();
    if(!page) return;
    const cards = page.querySelectorAll('.kpi-grid .kpi');
    cards.forEach((el, idx)=>{
      el.style.cursor='pointer';
      el.addEventListener('click', ()=> openKpiModal(idx));
    });
  }

  // Row detail modal on double-click
  function causeFor(r){
    if(r.status==='OK') return 'Ï†ïÏÉÅ(ÏµúÍ∑º ÌÜµÏã† ÌôïÏù∏)';
    const causes = ['ÌÜµÏã†Î∂àÎüâ','Î∞∞ÌÑ∞Î¶¨Ï†ÄÏ†ÑÏïï','Í≤ÄÏπ®Í∏∞Í∏∞Ïò§Î•ò','Ï†ÑÏõêÏ∞®Îã®','ÎØ∏Î∞∞ÏÑ†'];
    return causes[(r.id.charCodeAt(2)+r.dong+r.ho)%causes.length];
  }
  function rowDetailHTML(r){
    const hours = Math.floor((Date.now() - r.lastSeen.getTime())/3600e3);
    return [
      '<div class="modal-scroll">',
        '<h4 style="margin:0 0 8px">Ïû•Ïπò ÏÉÅÏÑ∏</h4>',
        '<table class="mini-table"><tbody>',
          '<tr><th style="width:120px">Í≥ÑÎüâÍ∏∞ID</th><td>'+r.id+'</td></tr>',
          '<tr><th>Ï£ºÏÜå</th><td>'+r.complex+' '+r.dong+'/'+r.ho+'</td></tr>',
          '<tr><th>Ïú†Ìã∏Î¶¨Ìã∞</th><td>'+r.util+'</td></tr>',
          '<tr><th>Í≥µÍ∏âÏÇ¨</th><td>'+r.provider+'</td></tr>',
          '<tr><th>ÏµúÍ∑ºÏàòÏã†</th><td>'+fmt(r.lastSeen)+' ('+hours+'ÏãúÍ∞Ñ Í≤ΩÍ≥º)</td></tr>',
          '<tr><th>ÏàòÏã†ÏÉÅÌÉú</th><td>'+(r.status==='OK'?'Ï†ïÏÉÅ':'Ïû•Ïï†')+'</td></tr>',
          '<tr><th>ÎàÑÏ†ÅÍ∞í</th><td>'+r.cum.toLocaleString()+'</td></tr>',
          '<tr><th>ÌíàÏßàÌîåÎûòÍ∑∏</th><td>'+r.q+'</td></tr>',
          '<tr><th>Ï∂îÏ†ï ÏõêÏù∏</th><td>'+causeFor(r)+'</td></tr>',
        '</tbody></table>',
      '</div>'
    ].join('');
  }
  function openRowDetail(id){
    const r = AMI.index?.[id]; if(!r) return;
    openModal('Ïû•Ïπò ÏÉÅÏÑ∏', rowDetailHTML(r));
  }


  function permHTML(){
    const p = AMI.perm();
    const keys = [['view','Ï°∞Ìöå'], ['export','ÎÇ¥Î≥¥ÎÇ¥Í∏∞'], ['retry','Ïû•ÏπòÏû¨ÏãúÎèÑ']];
    return keys.map(([k,la])=> p[k]? '<span class="pill-mini ok">'+la+'</span>' : '<span class="pill-mini">'+la+'</span>').join(' ');
  }

  function kpiHTML(){
    const total=AMI.filtered.length||AMI.data.length;
    const rows = AMI.filtered.length? AMI.filtered : AMI.data;
    const ok = rows.filter(r=> r.status==='OK').length;
    const rate = total? Math.round(ok/total*100):0;
    const latest = rows.slice().sort((a,b)=> b.lastSeen-a.lastSeen)[0]?.lastSeen || now();
    const cutoff = Date.now() - 6*3600*1000;
    const faults = rows.filter(r=> r.status!=='OK' || r.lastSeen.getTime()<cutoff).length;
    const byPv = providers.map(pv=>({pv, cnt: rows.filter(r=> r.provider===pv).length || 0, ok: rows.filter(r=> r.provider===pv && r.status==='OK').length || 0}));
    return [
      '<div class="kpi-grid" role="region" aria-label="Ï°∞ÌöåÏßÄÌëú">',
        '<div class="kpi"><h6>AMI ÏàòÏã†Ïú®</h6><div class="big">'+rate+'%</div><div class="bar"><i style="width:'+rate+'%"></i></div><div class="muted">Ï¥ù '+total+'ÎåÄ Ï§ë Ï†ïÏÉÅ '+ok+'ÎåÄ</div></div>',
        '<div class="kpi"><h6>ÏµúÍ∑º ÏàòÏã†ÏãúÍ∞Å</h6><div class="big">'+fmt(latest)+'</div><div class="muted">Í∞ÄÏû• ÏµúÍ∑º ÏàòÏã†</div></div>',
        '<div class="kpi"><h6>Ïû•Ïï†ÏÉÅÌÉú</h6><div class="big">'+faults+'ÎåÄ</div><div class="muted">ÏµúÍ∑º 6ÏãúÍ∞Ñ Í∏∞Ï§Ä Ïû•Ïï†/ÎØ∏ÏàòÏã†</div></div>',
        '<div class="kpi"><h6>Í≥µÍ∏âÏÇ¨Î≥Ñ ÏàòÏã†ÌòÑÌô©</h6>'+ byPv.map(o=>{ const pr = o.cnt? Math.round(o.ok/o.cnt*100):0; return '<div style="display:flex;align-items:center;gap:8px;margin:6px 0"><span class="muted" style="width:110px">'+o.pv+'</span><div class="bar" style="flex:1"><i style="width:'+pr+'%"></i></div><b style="font:800 12px var(--font)">'+pr+'%</b></div>'; }).join('') + '</div>',
      '</div>'
    ].join('');
  }

  function toolbarHTML(){
    const p = AMI.perm();
    return [
      '<div class="ami-toolbar">',
        '<input class="in" id="ami-q" placeholder="Í≥ÑÎüâÍ∏∞ID/Ï£ºÏÜå Í≤ÄÏÉâ" aria-label="Í≤ÄÏÉâ" />',
        '<select class="in select" id="ami-complex"><option value="">Îã®ÏßÄ Ï†ÑÏ≤¥</option>'+['ÎûòÎØ∏ÏïàA','ÏûêÏù¥B','Ìë∏Î•¥ÏßÄÏò§C'].map(c=>'<option>'+c+'</option>').join('')+'</select>',
        '<select class="in select" id="ami-dong"><option value="">Îèô Ï†ÑÏ≤¥</option>'+[101,102,103,104,105,106].map(d=>'<option>'+d+'</option>').join('')+'</select>',
        '<select class="in select" id="ami-ho"><option value="">Ìò∏ Ï†ÑÏ≤¥</option>'+[101,102,201,202,301,302,401,402].map(h=>'<option>'+h+'</option>').join('')+'</select>',
        '<select class="in select" id="ami-provider"><option value="">Í≥µÍ∏âÏÇ¨ Ï†ÑÏ≤¥</option>'+providers.map(p=>'<option>'+p+'</option>').join('')+'</select>',
        '<select class="in select" id="ami-util"><option value="">Ïú†Ìã∏Î¶¨Ìã∞ Ï†ÑÏ≤¥</option>'+utils.map(u=>'<option>'+u+'</option>').join('')+'</select>',
        '<div class="pill"><small>Ïû•ÏπòÏÉÅÌÉú</small>&nbsp;<select class="in select" id="ami-status"><option value="">Ï†ÑÏ≤¥</option><option value="OK">active</option><option value="FAULT">fault</option></select></div>',
        '<div class="pill"><small>ÏµúÍ∑º</small>&nbsp;<input id="ami-hours" type="number" min="1" max="72" value="24" class="in" style="width:68px"/>&nbsp;<small>ÏãúÍ∞Ñ</small></div>',
        '<span style="margin-left:auto"></span>',
        '<button class="iconbtn" id="ami-retry" '+(p.retry?'':'disabled')+'>Ïû¨ÏàòÏã† Ìä∏Î¶¨Í±∞</button>',
        '<button class="iconbtn" id="ami-inspect" '+(p.retry?'':'disabled')+'>Ïû•Ïπò Ï†êÍ≤ÄÏöîÏ≤≠</button>',
        '<button class="iconbtn" id="ami-export" '+(p.export?'':'disabled')+'>CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>',
        '<span class="perm-pill pill-mini">Í∂åÌïú: <b style="margin-left:6px">'+permHTML()+'</b></span>',
      '</div>'
    ].join('');
  }

  function tableHTML(rows){
    return [
      '<table class="ami-table" role="table" aria-label="AMI ÌÖåÏù¥Î∏î">',
      '<thead><tr>',
        '<th style="width:120px">Í≥ÑÎüâÍ∏∞ID</th>',
        '<th style="width:160px">Îã®ÏßÄ/Îèô/Ìò∏</th>',
        '<th style="width:80px">Ïú†Ìã∏Î¶¨Ìã∞</th>',
        '<th style="width:160px">ÏµúÍ∑ºÏàòÏã†ÏãúÍ∞Å</th>',
        '<th style="width:110px">ÏàòÏã†ÏÉÅÌÉú</th>',
        '<th style="width:120px">ÎàÑÏ†ÅÍ∞í</th>',
        '<th style="width:130px">ÌíàÏßàÌîåÎûòÍ∑∏</th>',
      '</tr></thead>',
      '<tbody>',
      rows.map(r=>{
        const cls = r.status==='OK'?'ok':'bad';
        const qcls = r.q==='A'?'qflag a': (r.q==='B'?'qflag b':'qflag c');
        return '<tr data-id="'+r.id+'">'
          +'<td><b>'+r.id+'</b></td>'
          +'<td>'+r.complex+' '+r.dong+'/'+r.ho+'</td>'
          +'<td>'+r.util+'</td>'
          +'<td>'+fmt(r.lastSeen)+'</td>'
          +'<td><span class="status '+cls+'">'+(r.status==='OK'?'Ï†ïÏÉÅ':'Ïû•Ïï†')+'</span></td>'
          +'<td>'+r.cum.toLocaleString()+'</td>'
          +'<td><span class="'+qcls+'"><i class="dot"></i><span>'+r.q+'</span></span></td>'
        +'</tr>';
      }).join(''),
      '</tbody></table>'
    ].join('');
  }

  function pageHTML(){
    const rows = AMI.filtered.length? AMI.filtered : AMI.data;
    return [
      '<section class="widget" id="MTR-101">',
        '<header>',
          '<h4>ÏûêÎèôÍ≤ÄÏπ®(AMI) ÌòÑÌô©</h4>',
          '<div class="row-actions">',
            '<button class="iconbtn" id="ami-retry">Ïû¨ÏàòÏã† Ìä∏Î¶¨Í±∞</button>',
            '<button class="iconbtn" id="ami-inspect">Ïû•Ïπò Ï†êÍ≤ÄÏöîÏ≤≠</button>',
            '<button class="iconbtn" id="ami-export">CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>',
          '</div>',
        '</header>',
        toolbarHTML(),
        kpiHTML(),
        '<div class="ami-grid">',
          tableHTML(rows),
          '<div class="ami-logs event-logs">',
            '<div>',
              '<div class="pill-mini">ÏàòÏã† Î°úÍ∑∏</div>',
              '<div id="ami-log-recv" class="logbox" aria-live="polite"></div>',
            '</div>',
            '<div>',
              '<div class="pill-mini">Ïû•Ïï†/Î≥µÍµ¨ Î°úÍ∑∏</div>',
              '<div id="ami-log-fault" class="logbox" aria-live="polite"></div>',
            '</div>',
          '</div>',
        '</div>',
      '</section>'
    ].join('');
  }

  function addLog(kind, tag, msg){
    const box = $('#'+(kind==='recv'?'ami-log-recv':'ami-log-fault'));
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = '<span class="k '+tag+'">'+tag+'</span><span class="t">'+fmt(new Date())+'</span><span>'+msg+'</span>';
    if(box){ box.appendChild(div); box.scrollTop = box.scrollHeight; }
  }

  function applyFilters(){
    const q= $('#ami-q')?.value.trim();
    const cx=$('#ami-complex')?.value||'';
    const dong=$('#ami-dong')?.value||'';
    const ho=$('#ami-ho')?.value||'';
    const pv=$('#ami-provider')?.value||'';
    const util=$('#ami-util')?.value||'';
    const st=$('#ami-status')?.value||'';
    const hrs=parseInt($('#ami-hours')?.value||'24',10);
    const cutoff = Date.now() - (hrs*3600*1000);
    AMI.filtered = AMI.data.filter(r=>{
      if(q && !(r.id.includes(q) || (r.complex+' '+r.dong+'/'+r.ho).includes(q))) return false;
      if(cx && r.complex!==cx) return false;
      if(dong && String(r.dong)!==dong) return false;
      if(ho && String(r.ho)!==ho) return false;
      if(pv && r.provider!==pv) return false;
      if(util && r.util!==util) return false;
      if(st && r.status!==st) return false;
      if(r.lastSeen.getTime() < cutoff) return false;
      return true;
    });
    const page = findContainer();
    if(!page) return;
    const grid = page.querySelector('.ami-grid');
    if(grid){
      grid.innerHTML = tableHTML(AMI.filtered.length? AMI.filtered : AMI.data) + grid.innerHTML.substring(grid.innerHTML.indexOf('<div class="ami-logs event-logs">'));
      bindRowEvents();
    }
    const kpiHost = page.querySelector('.kpi-grid')?.parentElement;
    if(kpiHost){ kpiHost.innerHTML = kpiHTML(); bindKpiEvents(); }
  }

  function bindRowEvents(){
    $$('.ami-table tbody tr').forEach(tr=>{
      tr.onclick = ()=>{
        const id = tr.getAttribute('data-id');
        if(AMI.selected.has(id)){ AMI.selected.delete(id); tr.classList.remove('sel'); }
        else { AMI.selected.add(id); tr.classList.add('sel'); }
      };
      tr.ondblclick = ()=>{ const id = tr.getAttribute('data-id'); openRowDetail(id); };
    });
  }

  function exportCSV(){
    if(!AMI.perm().export){ alert('Í∂åÌïú ÏóÜÏùå: ÎÇ¥Î≥¥ÎÇ¥Í∏∞'); return; }
    const header = ['Í≥ÑÎüâÍ∏∞ID','Îã®ÏßÄ','Îèô','Ìò∏','Ïú†Ìã∏Î¶¨Ìã∞','ÏµúÍ∑ºÏàòÏã†ÏãúÍ∞Å','ÏàòÏã†ÏÉÅÌÉú','ÎàÑÏ†ÅÍ∞í','ÌíàÏßàÌîåÎûòÍ∑∏','Í≥µÍ∏âÏÇ¨'];
    const rows = (AMI.selected.size>0? (AMI.filtered.length? AMI.filtered: AMI.data).filter(r=> AMI.selected.has(r.id)) : (AMI.filtered.length? AMI.filtered: AMI.data));
    const lines = [header.join(',')];
    rows.forEach(r=> lines.push([r.id,r.complex,r.dong,r.ho,r.util,fmt(r.lastSeen),r.status,r.cum,r.q,r.provider].join(',')));
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='AMI_status_export.csv'; a.click();
    addLog('recv','ok','CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞: '+rows.length+'Í±¥');
  }

  function openModal(title, body, onOk){
    const wrap = document.createElement('div');
    wrap.style.position='fixed'; wrap.style.inset='0'; wrap.style.background='rgba(16,24,40,.35)'; wrap.style.display='grid'; wrap.style.placeItems='center'; wrap.style.zIndex=9999;
    wrap.innerHTML = '<div style="width:520px;max-width:92vw;border:1px solid var(--border);border-radius:14px;background:#fff;box-shadow:var(--sh-1)">'+
      '<div style="padding:12px 14px;border-bottom:1px solid var(--border)"><b>'+title+'</b></div>'+
      '<div style="padding:12px 14px">'+body+'</div>'+
      '<div style="display:flex;justify-content:flex-end;gap:8px;padding:10px 14px;border-top:1px solid var(--border)">'+
        '<button id="ami-cancel" class="iconbtn">Ï∑®ÏÜå</button><button id="ami-ok" class="iconbtn">ÌôïÏù∏</button>'+
      '</div></div>';
    document.body.appendChild(wrap);
    wrap.addEventListener('click', (e)=>{ if(e.target===wrap) document.body.removeChild(wrap); });
    wrap.querySelector('#ami-cancel').onclick = ()=> document.body.removeChild(wrap);
    wrap.querySelector('#ami-ok').onclick = ()=>{ onOk?.(); document.body.removeChild(wrap); };
  }

  function findContainer(){
    const sels = [
      '.vpage[data-vpage="MTR-101"]',
      '.vpage#MTR-101',
      '[data-page="MTR-101"]',
      '[data-key="MTR-101"]',
      '.vpage[data-vpage*="MTR-101"]'
    ];
    for(const s of sels){ const el = $(s); if(el) return el; }
    return null; // STRICT: do not hijack other pages
  }

  function mount(){
    const page = findContainer();
    if(!page || page.__amiReady) return;
    let host = page.querySelector('#ui-pm-work');
    if(!host){ page.innerHTML = '<div id="ui-pm-work"></div>'; host = page.firstElementChild; }
    host.innerHTML = pageHTML();
    page.__amiReady = true; AMI.booted = true;
    bindToolbar(); bindRowEvents(); bindKpiEvents();
    addLog('recv','ok','Ï¥àÍ∏∞ ÎèôÍ∏∞Ìôî ÏôÑÎ£å'); addLog('fault','recover','ÏµúÍ∑º Ïû•Ïï† 2Í±¥ Î≥µÍµ¨');
  }

  // Bind only to the exact left-subtab element
  document.addEventListener('click', (e)=>{
    const t = e.target.closest('.mid[data-mid="MTR-101"]');
    if(t) setTimeout(mount,0);
  });
  // Also try after small delays, but only if the target container exists
  const tryMount = ()=> { if(findContainer()) setTimeout(mount,0); };
  window.addEventListener('hashchange', tryMount);
  window.addEventListener('popstate', tryMount);
  const obs = new MutationObserver(tryMount);
  obs.observe(document.body, {childList:true,subtree:true,attributes:true,attributeFilter:['data-vpage','id']});
  setTimeout(tryMount, 200);
  setTimeout(tryMount, 800);
  setTimeout(tryMount, 1600);
})(window);
</script>


<!-- =================== END MTR-101 (ÏûêÎèôÍ≤ÄÏπ® AMI ÌòÑÌô©) INJECT =================== -->


<script id="ami-click-delegate">
(function(){
  // Avoid double-install
  if (window.__AMI_CLICK_DELEGATE__) return;
  window.__AMI_CLICK_DELEGATE__ = true;

  // Simple modal fallback if openModal not provided
  function fallbackModal(title, body){
    var wrap = document.createElement('div');
    wrap.style.cssText = 'position:fixed;inset:0;display:grid;place-items:center;background:rgba(16,24,40,.35);z-index:99999';
    wrap.innerHTML = '<div style="width:560px;max-width:92vw;border:1px solid #e5e7eb;border-radius:14px;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.12)">'+
      '<div style="padding:12px 16px;border-bottom:1px solid #e5e7eb;font-weight:700">'+title+'</div>'+
      '<div style="padding:16px;max-height:60vh;overflow:auto">'+body+'</div>'+
      '<div style="display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid #e5e7eb">'+
        '<button id="ami-close" style="height:32px;padding:0 12px;border:1px solid #e5e7eb;border-radius:8px;background:#fff">Îã´Í∏∞</button>'+
      '</div></div>';
    document.body.appendChild(wrap);
    function close(){ if(wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap); }
    wrap.addEventListener('click', function(e){ if(e.target===wrap) close(); });
    wrap.querySelector('#ami-close').onclick = close;
  }
  function openModalSafe(title, body){
    if (typeof openModal === 'function') openModal(title, body);
    else fallbackModal(title, body);
  }

  function fmt(d){
    try{
      if(!(d instanceof Date)) d = new Date(d);
      const z=n=>(''+n).padStart(2,'0');
      return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate())+' '+z(d.getHours())+':'+z(d.getMinutes())+':'+z(d.getSeconds());
    }catch(e){ return String(d); }
  }

  // Build simple stats from DOM if __AMI_STATE__ is absent
  function domStats(){
    var rows = Array.from(document.querySelectorAll('.ami-table tbody tr'));
    var ok=0, tot=rows.length;
    rows.forEach(function(tr){
      var s = tr.querySelector('.status');
      if(s && /Ï†ïÏÉÅ|OK/i.test(s.textContent||'')) ok++;
    });
    return {ok:ok, tot:tot, rate: tot? Math.round(ok/tot*100):0};
  }

  function fallbackKpiModal(idx){
    var s = (window.__AMI_STATE__ || null);
    if (idx===0){ // ÏàòÏã†Ïú®
      var st = s? (function(){ const rows = (s.filtered&&s.filtered.length?s.filtered:s.data)||[]; const ok = rows.filter(r=>r.status==='OK').length; return {ok:ok, tot:rows.length, rate: rows.length? Math.round(ok/rows.length*100):0}; })() : domStats();
      openModalSafe('AMI ÏàòÏã†Ïú® ¬∑ ÏÉÅÏÑ∏', '<div>Ï†ïÏÉÅ: <b>'+st.ok+'</b> / Ï¥ùÍ≥Ñ: <b>'+st.tot+'</b> ('+st.rate+'%)</div>');
      return;
    }
    if (idx===1){ // ÏµúÍ∑º ÏàòÏã†
      var rows = s? (s.filtered&&s.filtered.length?s.filtered:s.data) : [];
      var top = (rows||[]).slice().sort(function(a,b){ return (b.lastSeen||0)-(a.lastSeen||0); }).slice(0,10);
      var html = '<table style="width:100%;border-collapse:separate;border-spacing:0"><thead><tr><th>Í≥ÑÎüâÍ∏∞ID</th><th>Ï£ºÏÜå</th><th>Ïú†Ìã∏Î¶¨Ìã∞</th><th>ÏµúÍ∑ºÏàòÏã†</th></tr></thead><tbody>';
      if (top.length===0){
        // fallback from DOM
        var trs = Array.from(document.querySelectorAll('.ami-table tbody tr')).slice(0,10);
        top = trs.map(function(tr){
          var tds = tr.querySelectorAll('td');
          return {id:(tds[0]&&tds[0].innerText)||'', addr:(tds[1]&&tds[1].innerText)||'', util:(tds[2]&&tds[2].innerText)||'', last:(tds[3]&&tds[3].innerText)||''};
        });
        html += top.map(function(r){ return '<tr><td>'+r.id+'</td><td>'+r.addr+'</td><td>'+r.util+'</td><td>'+r.last+'</td></tr>'; }).join('');
      }else{
        html += top.map(function(r){ return '<tr><td>'+r.id+'</td><td>'+r.complex+' '+r.dong+'/'+r.ho+'</td><td>'+r.util+'</td><td>'+fmt(r.lastSeen)+'</td></tr>'; }).join('');
      }
      html += '</tbody></table>';
      openModalSafe('ÏµúÍ∑º ÏàòÏã† ¬∑ Top 10', html);
      return;
    }
    if (idx===2){ // Ïû•Ïï†ÏÉÅÌÉú
      var rows = s? (s.filtered&&s.filtered.length?s.filtered:s.data) : [];
      var faults = (rows||[]).filter(function(r){ return r.status!=='OK'; });
      var html = '<div>Ïû•Ïï† Ï∂îÏ†ï: <b>'+faults.length+'</b>ÎåÄ</div>';
      openModalSafe('Ïû•Ïï†ÏÉÅÌÉú ¬∑ Î∂ÑÏÑù', html);
      return;
    }
    if (idx===3){ // Í≥µÍ∏âÏÇ¨Î≥Ñ
      var rows = s? (s.filtered&&s.filtered.length?s.filtered:s.data) : [];
      var pvs = ['ÌïúÏ†Ñ(KEPCO)','ÏΩîÏõêÏóêÎÑàÏßÄ','ÏÑúÏö∏ÏãúÏàòÎèÑ','ÏÇºÏ≤úÎ¶¨ÎèÑÏãúÍ∞ÄÏä§'];
      var html = '<table style="width:100%;border-collapse:separate;border-spacing:0"><thead><tr><th>Í≥µÍ∏âÏÇ¨</th><th>Ï†ïÏÉÅ</th><th>Ï¥ùÍ≥Ñ</th><th>ÏàòÏã†Ïú®</th></tr></thead><tbody>';
      pvs.forEach(function(pv){
        var tot = (rows||[]).filter(function(r){return r.provider===pv;}).length;
        var ok = (rows||[]).filter(function(r){return r.provider===pv && r.status==='OK';}).length;
        var pr = tot? Math.round(ok/tot*100):0;
        html += '<tr><td>'+pv+'</td><td>'+ok+'</td><td>'+tot+'</td><td>'+pr+'%</td></tr>';
      });
      html += '</tbody></table>';
      openModalSafe('Í≥µÍ∏âÏÇ¨Î≥Ñ ÏàòÏã†ÌòÑÌô©', html);
      return;
    }
    openModalSafe('ÏÉÅÏÑ∏ ÌÜµÍ≥Ñ', 'Îç∞Ïù¥ÌÑ∞Î•º Ï§ÄÎπÑÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
  }

  function fallbackRowModal(tr){
    var cells = tr.querySelectorAll('td');
    var id   = (tr.getAttribute('data-id')||'').trim();
    var addr = cells[1]? cells[1].innerText : '';
    var util = cells[2]? cells[2].innerText : '';
    var last = cells[3]? cells[3].innerText : '';
    var stat = cells[4]? cells[4].innerText : '';
    var cum  = cells[5]? cells[5].innerText : '';
    var q    = cells[6]? cells[6].innerText : '';
    var html = '<table style="width:100%;border-collapse:separate;border-spacing:0"><tbody>'+
      '<tr><th style="width:120px;text-align:left">Í≥ÑÎüâÍ∏∞ID</th><td>'+id+'</td></tr>'+
      '<tr><th>Ï£ºÏÜå</th><td>'+addr+'</td></tr>'+
      '<tr><th>Ïú†Ìã∏Î¶¨Ìã∞</th><td>'+util+'</td></tr>'+
      '<tr><th>ÏµúÍ∑ºÏàòÏã†</th><td>'+last+'</td></tr>'+
      '<tr><th>ÏàòÏã†ÏÉÅÌÉú</th><td>'+stat+'</td></tr>'+
      '<tr><th>ÎàÑÏ†ÅÍ∞í</th><td>'+cum+'</td></tr>'+
      '<tr><th>ÌíàÏßàÌîåÎûòÍ∑∏</th><td>'+q+'</td></tr>'+
      '</tbody></table>';
    openModalSafe('Ïû•Ïπò ÏÉÅÏÑ∏', html);
  }

  // Capture-phase delegation so bubbling handlers (ÏÑ†ÌÉù ÌÜ†Í∏Ä Îì±)Î≥¥Îã§ Î®ºÏ†Ä Ï≤òÎ¶¨
  function onClick(e){
    // List row
    var row = e.target.closest && e.target.closest('.ami-table tbody tr[data-id]');
    if (row){
      if (e.ctrlKey || e.metaKey) return; // Î©ÄÌã∞ÏÑ†ÌÉù Ïú†ÏßÄ
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
      var id = row.getAttribute('data-id');
      if (typeof openRowDetail === 'function'){ openRowDetail(id); }
      else { fallbackRowModal(row); }
      return;
    }
    // KPI card
    var k = e.target.closest && e.target.closest('.kpi-grid .kpi');
    if (k){
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
      var cards = Array.from(k.parentElement.querySelectorAll('.kpi'));
      var idx = Math.max(0, cards.indexOf(k));
      if (typeof openKpiModal === 'function'){ openKpiModal(idx); }
      else { fallbackKpiModal(idx); }
    }
  }

  function onKey(e){
    if(e.key !== 'Enter' && e.key !== ' ') return;
    var row = e.target.closest && e.target.closest('.ami-table tbody tr[data-id]');
    if(row){
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
      var id = row.getAttribute('data-id');
      if (typeof openRowDetail === 'function'){ openRowDetail(id); }
      else { fallbackRowModal(row); }
      return;
    }
    var k = e.target.closest && e.target.closest('.kpi-grid .kpi');
    if(k){
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
      var cards = Array.from(k.parentElement.querySelectorAll('.kpi'));
      var idx = Math.max(0, cards.indexOf(k));
      if (typeof openKpiModal === 'function'){ openKpiModal(idx); }
      else { fallbackKpiModal(idx); }
    }
  }

  document.addEventListener('click', onClick, true);   // capture
  document.addEventListener('keydown', onKey, true);   // capture
})();
</script>


<script id="patch-assign-summary-move">
(function(){
  function run(){
    var root = document.getElementById('assign-map');
    var sum = document.getElementById('assign-summary');
    if(!root || !sum) return;
    if(sum.__moved__) return;
    var head = root.querySelector('.map-head .legend');
    var container = root.querySelector('.map-head');
    if(container && head){
      // insert after legend
      head.insertAdjacentElement('afterend', sum);
      sum.classList.add('assign-summary-overlay');
      sum.__moved__ = true;
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', run);
  }else{
    setTimeout(run, 0);
  }
})();
</script>
<style id="patch-assign-summary-style">
/* PATCH v1.8: assign summary overlay under legend */
#ui-pm-work #assign-map .assign-summary-overlay{
  margin-left:0; margin-top:8px;
  display:grid; grid-auto-flow:column; gap:10px; align-items:center;
}
@media(max-width:1200px){
  #ui-pm-work #assign-map .assign-summary-overlay{ grid-auto-flow:row; gap:6px; }
}
#ui-pm-work #assign-map .assign-summary-overlay .pill-mini{ background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 10px; }
#ui-pm-work #assign-map .assign-summary-overlay .ok{ background:#ecfdf5; border-color:#bbf7d0; }
</style>

<script id="patch-mtr002-metrics-move-v19">
(function(){
  function move(){
    var sum = document.getElementById('assign-summary');
    if(!sum || sum.__moved__) return;
    var root = sum.closest('#MTR-002') || document.getElementById('MTR-002');
    if(!root) return;
    var head = root.querySelector('.map-head');
    var legend = head && head.querySelector('.legend');
    if(legend){
      legend.insertAdjacentElement('afterend', sum);
      sum.classList.add('assign-summary-overlay');
      sum.__moved__ = true;
      return;
    }
    var mapWrap = root.querySelector('.assign-map, .map-wrap');
    if(mapWrap){
      mapWrap.style.position = 'relative';
      sum.classList.add('assign-summary-abs');
      mapWrap.appendChild(sum);
      sum.__moved__ = true;
    }
  }
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', move); }
  else { setTimeout(move,0); }
  new MutationObserver(move).observe(document.body,{subtree:true,childList:true});
})();
</script>

<script id="patch-mtr101-dedup-buttons-v19">
(function(){
  function run(){
    var root = document.getElementById('MTR-101');
    if(!root) return;
    ['ami-retry','ami-inspect','ami-export'].forEach(function(id){
      var nodes = root.querySelectorAll('#'+id);
      if(!nodes.length) return;
      nodes.forEach(function(n){
        if(!n.closest('header')) n.remove();
      });
    });
  }
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', run); }
  else { setTimeout(run,0); }
  new MutationObserver(run).observe(document.body,{childList:true,subtree:true});
})();
</script>

<script id="patch-mtr101-eventlogs-card-v19">
(function(){
  function wrap(){
    var root = document.getElementById('MTR-101');
    if(!root) return;
    var logs = root.querySelector('.ami-logs');
    if(!logs || logs.__wrapped__) return;
    var card = document.createElement('section');
    card.className = 'eventlogs-card assign-card';
    card.innerHTML = '<h6 class="ev-title">Ïù¥Î≤§Ìä∏/Î°úÍ∑∏</h6>';
    logs.parentNode.insertBefore(card, logs);
    card.appendChild(logs);
    logs.__wrapped__ = true;
    var cols = logs.querySelectorAll('.col');
    if(cols.length >= 2){
      var a = document.createElement('div'); a.className='pill-mini'; a.textContent='ÏàòÏã† Î°úÍ∑∏';
      var b = document.createElement('div'); b.className='pill-mini'; b.textContent='Ïû•Ïï†/Î≥µÍµ¨ Î°úÍ∑∏';
      cols[0].insertBefore(a, cols[0].firstChild);
      cols[1].insertBefore(b, cols[1].firstChild);
    }
  }
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', wrap); }
  else { setTimeout(wrap,0); }
  new MutationObserver(wrap).observe(document.body,{childList:true,subtree:true});
})();
</script>

<script id="patch-mtr101-dedup-buttons-v20">
(function(){
  function ensure(){
    var root = document.getElementById('MTR-101');
    if(!root) return;
    var ids = ['ami-retry','ami-inspect','ami-export'];
    var header = root.querySelector('header .row-actions') || root.querySelector('header') || root;
    ids.forEach(function(id){
      var nodes = root.querySelectorAll('#'+id);
      if(nodes.length===0 && header){
        var btn = document.createElement('button');
        btn.className='iconbtn'; btn.id = id;
        btn.textContent = (id==='ami-retry'?'Ïû¨ÏàòÏã† Ìä∏Î¶¨Í±∞': id==='ami-inspect'?'Ïû•Ïπò Ï†êÍ≤ÄÏöîÏ≤≠':'CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞');
        header.appendChild(btn);
      }else if(nodes.length>1){
        nodes.forEach(function(node, idx){ if(idx>0) node.remove(); });
      }
    });
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', ensure); }
  else { setTimeout(ensure,0); }
  new MutationObserver(ensure).observe(document.body,{childList:true,subtree:true});
})();
</script>

<script id="ami-toolbar-fix">
(function(){
  if (window.__AMI_TOOL_FIX__) return; window.__AMI_TOOL_FIX__ = true;
  function openModalFallback(title, bodyHTML){
    try{ if (typeof openModal === 'function'){ openModal(title, bodyHTML); return; } }catch(e){}
    // lightweight fallback
    var wrap = document.createElement('div');
    wrap.style.cssText = 'position:fixed;inset:0;display:grid;place-items:center;background:rgba(15,23,42,.35);z-index:99999';
    wrap.innerHTML = '<div style="width:min(640px,92vw);background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.18);border:1px solid #e8edf4">'+
      '<div style="padding:12px 14px;border-bottom:1px solid #e8edf4;font-weight:800">'+title+'</div>'+
      '<div style="padding:14px;max-height:70vh;overflow:auto">'+bodyHTML+'</div>'+
      '<div style="display:flex;justify-content:flex-end;gap:8px;padding:10px 14px;border-top:1px solid #e8edf4">'+
        '<button id="ami-fix-close" class="iconbtn">Îã´Í∏∞</button>'+
      '</div></div>';
    document.body.appendChild(wrap);
    wrap.addEventListener('click', function(e){ if(e.target.id==='ami-fix-close' || e.target===wrap) wrap.remove(); }, true);
  }
  function handleClick(e){
    var btn = e.target && e.target.closest && e.target.closest('#ami-retry,#ami-inspect,#ami-export,#ami-retry-h,#ami-inspect-h,#ami-export-h');
    if(!btn) return;
    if(btn.disabled || btn.getAttribute('disabled')!==null){ e.preventDefault(); return; }
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    var id = btn.id.replace(/-h$/,'');
    if(id==='ami-retry'){
      openModalFallback('Ïû¨ÏàòÏã† Ìä∏Î¶¨Í±∞', '<div style="line-height:1.7">ÏµúÍ∑º <input id="ami-fix-hours" type="number" min="1" max="72" value="24" style="width:64px"> ÏãúÍ∞Ñ ÎÇ¥ ÎØ∏ÏàòÏã† Ïû•ÏπòÏóê Ïû¨ÏàòÏã† Ìä∏Î¶¨Í±∞Î•º Î≥¥ÎÉÖÎãàÎã§.<br><small>ÌïÑÌÑ∞Í∞Ä Ï†ÅÏö©Îêú Í≤ΩÏö∞, ÌòÑÏû¨ ÌïÑÌÑ∞ Í≤∞Í≥ºÏóê ÌïúÏ†ïÎê©ÎãàÎã§.</small><div style="margin-top:10px;text-align:right"><button id="ami-fix-retry-ok" class="iconbtn">Ïã§Ìñâ</button></div></div>');
    }else if(id==='ami-inspect'){
      openModalFallback('Ïû•Ïπò Ï†êÍ≤ÄÏöîÏ≤≠', '<div>ÏÑ†ÌÉù Ïû•Ïπò(ÎòêÎäî ÌïÑÌÑ∞Îêú Ïû•Ïπò)Ïóê Ï†êÍ≤Ä ÏöîÏ≤≠ÏùÑ Ï†ÑÏÜ°Ìï©ÎãàÎã§.<div style="margin-top:10px;text-align:right"><button id="ami-fix-insp-ok" class="iconbtn">ÏöîÏ≤≠</button></div></div>');
    }else if(id==='ami-export'){
      try{
        // If AMI rows available in state, try to export; otherwise fall back to table scrape
        var rows = (window.__AMI_STATE__ && (__AMI_STATE__.filtered && __AMI_STATE__.filtered.length ? __AMI_STATE__.filtered : __AMI_STATE__.data)) || [];
        if(!rows.length){
          var trs = Array.from(document.querySelectorAll('.ami-table tbody tr'));
          rows = trs.map(function(tr){
            var tds = tr.querySelectorAll('td');
            return {id:(tds[0]&&tds[0].innerText)||'', addr:(tds[1]&&tds[1].innerText)||'', util:(tds[2]&&tds[2].innerText)||'', last:(tds[3]&&tds[3].innerText)||''};
          });
        }
        var csv = 'Í≥ÑÎüâÍ∏∞ID,Ï£ºÏÜå,Ïú†Ìã∏Î¶¨Ìã∞,ÏµúÍ∑ºÏàòÏã†\n' + rows.map(function(r){ return [r.id,r.addr,r.util,(r.lastSeen? new Date(r.lastSeen).toLocaleString() : (r.last||''))].join(','); }).join('\n');
        var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'AMI_export.csv'; a.click();
      }catch(err){
        openModalFallback('CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞', '<div>ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞Î•º Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.</div>');
      }
      return;
    }
  }
  document.addEventListener('click', handleClick, true);
})();
</script>





<!-- ===== MTR-102 (ÏàòÎèôÍ≤ÄÏπ® ÏûÖÎ†•) ‚Äî DROP-IN MODULE ===== -->














<style id="mtr101-round-fix">
/* AMI ÌÉ≠ ÏÉÅÎã®/Î∞îÍπ• Ïª®ÌÖåÏù¥ÎÑà Î™®ÏÑúÎ¶¨ ÎùºÏö¥Îìú Î∞è Î∞∞Í≤Ω Ï†ïÎ†¨ (Îã§Î•∏ ÌÉ≠ ÏòÅÌñ• ÏóÜÏùå) */
.vpage[data-vpage="MTR-101"],
.vpage#MTR-101,
[data-page="MTR-101"],
[data-key="MTR-101"],
.widget#MTR-101{
  background:#fff;
  border:1px solid var(--border, #e5e7eb);
  border-radius:16px;
  overflow:hidden;
}
/* ÎÇ¥Î∂Ä Ìå®ÎÑêÎì§ÎèÑ Î™®ÏÑúÎ¶¨ ÏùºÍ¥Ä */
#MTR-101 .panel,
#MTR-101 .panel .table-wrap{
  border-radius:14px;
  overflow:hidden;
  border:1px solid var(--border, #e5e7eb);
}
</style>

</body></html>


<script id="mtr102-hard-mount-v26">
(function(){
  if (window.__MTR102_HARD__) return; window.__MTR102_HARD__ = true;

  const css = document.createElement('style');
  css.textContent = `
    #MTR-102{padding:16px 16px 24px;display:grid;gap:14px}
    #MTR-102 .m102-header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px}
    #MTR-102 .m102-header h4{margin:0;font-size:16px;letter-spacing:-.2px}
    #MTR-102 .m102-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    #MTR-102 .m102-hbtn{height:30px;padding:0 12px;border-radius:10px;border:1px solid var(--border,#e5e7eb);background:linear-gradient(180deg,#fff,#f6f9ff);font-size:12px;font-weight:600;cursor:pointer;transition:box-shadow .2s ease,transform .2s ease}
    #MTR-102 .m102-hbtn:hover{box-shadow:0 10px 24px rgba(15,23,42,.12);transform:translateY(-1px)}
    #MTR-102 .m102-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:12px;border:1px solid var(--border,#e5e7eb);border-radius:14px;background:linear-gradient(180deg,#fff,#f8fbff)}
    #MTR-102 .m102-input{height:32px;padding:0 12px;border-radius:10px;border:1px solid var(--border,#e5e7eb);background:#fff;font-size:12px;flex:0 1 160px}
    #MTR-102 #m102-q{flex:1 1 260px;min-width:200px}
    #MTR-102 select.m102-input{padding-right:28px;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16'%3E%3Cpath fill='%237b8794' d='M2.3 6.4 3.2 5.5 8 10.3l4.8-4.8.9.9L8 12 2.3 6.4l.9-.9z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center}
    #MTR-102 .m102-card{border:1px solid var(--border,#e5e7eb);border-radius:16px;background:#fff;box-shadow:0 1px 2px rgba(15,23,42,.06);padding:14px}
    #MTR-102 .m102-kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media(max-width:1200px){#MTR-102 .m102-kpi-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:720px){#MTR-102 .m102-kpi-grid{grid-template-columns:1fr}}
    #MTR-102 .m102-kpi{display:flex;gap:12px;align-items:center;padding:12px;border:1px solid var(--border,#e5e7eb);border-radius:14px;background:var(--bg-50,#f8fafc);cursor:pointer;transition:box-shadow .2s ease,transform .2s ease}
    #MTR-102 .m102-kpi:hover{box-shadow:0 12px 30px rgba(15,23,42,.12);transform:translateY(-2px)}
    #MTR-102 .m102-kpi h6{margin:0 0 6px;font-size:12px;color:#475569;font-weight:700}
    #MTR-102 .m102-kpi-main{font-size:20px;font-weight:800;letter-spacing:-.2px;color:#0f172a}
    #MTR-102 .m102-muted{font-size:12px;color:#6b7280}
    #MTR-102 .m102-ring{--p:0;width:56px;height:56px;border-radius:50%;background:conic-gradient(#2563eb calc(var(--p)*1%),#e2e8f0 0);display:grid;place-items:center;flex:none}
    #MTR-102 .m102-ring span{width:42px;height:42px;border-radius:50%;background:#fff;display:grid;place-items:center;font:700 12px/1.2 var(--font,system-ui)}
    #MTR-102 .m102-bar-list{display:grid;gap:8px;width:100%}
    #MTR-102 .m102-bar{height:8px;border-radius:999px;background:#e2e8f0;overflow:hidden}
    #MTR-102 .m102-bar b{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#2563eb);width:0%}
    #MTR-102 .m102-table-wrap{max-height:520px;overflow:auto}
    #MTR-102 table.m102-table{width:100%;border-collapse:separate;border-spacing:0}
    #MTR-102 .m102-table thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border,#e5e7eb);padding:10px;text-align:left;font-size:13px;font-weight:700}
    #MTR-102 .m102-table tbody td{border-bottom:1px solid var(--border,#e5e7eb);padding:10px;font-size:13px;vertical-align:middle}
    #MTR-102 .m102-table tbody tr{cursor:pointer}
    #MTR-102 .m102-table tbody tr:hover{background:#f8fbff}
    #MTR-102 .m102-tag{display:inline-flex;align-items:center;gap:4px;height:20px;padding:0 8px;border-radius:999px;border:1px solid #e2e8f0;font-size:11px;background:#fff}
    #MTR-102 .m102-tag.ok{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    #MTR-102 .m102-tag.warn{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    #MTR-102 .m102-tag.bad{background:#fef2f2;border-color:#fecaca;color:#b91c1c}
    #MTR-102 .m102-qflag{display:inline-flex;align-items:center;gap:6px;font-size:12px}
    #MTR-102 .m102-qflag .dot{width:8px;height:8px;border-radius:50%;background:#2563eb}
    #MTR-102 .m102-qflag.b .dot{background:#f59e0b}
    #MTR-102 .m102-qflag.c .dot{background:#ef4444}
    #MTR-102 .m102-inline-actions{display:inline-flex;gap:6px;margin-left:6px;font-size:12px}
    #MTR-102 .m102-inline-actions a{color:#2563eb;text-decoration:none}
    #MTR-102 .m102-inline-actions a:hover{text-decoration:underline}
    #MTR-102 .m102-empty{padding:36px 0;text-align:center;font-size:13px;color:#6b7280}
    #MTR-102 .m102-logs-card{padding:0}
    #MTR-102 .m102-logs-card header{padding:14px 16px;border-bottom:1px solid var(--border,#e5e7eb);font-size:13px;font-weight:800}
    #MTR-102 .m102-log-columns{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px 16px 16px}
    @media(max-width:1020px){#MTR-102 .m102-log-columns{grid-template-columns:1fr}}
    #MTR-102 .pill-mini{display:inline-flex;align-items:center;gap:6px;height:20px;padding:0 10px;border-radius:999px;border:1px solid var(--border,#e5e7eb);background:#fff;font-size:11px;font-weight:700}
    #MTR-102 .m102-logbox{background:#fbfdff;border:1px solid var(--border,#e5e7eb);border-radius:12px;height:220px;overflow:auto;padding:10px;font-size:12px}
    #MTR-102 .m102-logbox .item{display:flex;gap:10px;align-items:center;padding:4px 0}
    #MTR-102 .m102-logbox .k{display:inline-flex;align-items:center;height:20px;padding:0 8px;border-radius:999px;border:1px solid #bfdbfe;background:#eff6ff;font-size:11px;font-weight:700;letter-spacing:.2px}
    #MTR-102 .m102-logbox .k.ok{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    #MTR-102 .m102-logbox .k.rechk{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}
    #MTR-102 .m102-logbox .time{font-variant-numeric:tabular-nums;color:#64748b}
    .m102-modal-back{position:fixed;inset:0;background:rgba(15,23,42,.45);display:flex;align-items:center;justify-content:center;z-index:99999}
    .m102-modal{width:min(900px,92vw);max-height:86vh;background:#fff;border:1px solid var(--border,#e5e7eb);border-radius:16px;box-shadow:0 20px 60px rgba(15,23,42,.28);display:flex;flex-direction:column}
    .m102-modal-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border,#e5e7eb)}
    .m102-modal-head h5{margin:0;font-size:16px}
    .m102-modal-body{padding:16px;overflow:auto;font-size:13px;line-height:1.6}
    .m102-modal-actions{padding:12px 16px;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid var(--border,#e5e7eb)}
    .m102-btn{height:32px;padding:0 14px;border-radius:10px;border:1px solid #d1d5db;background:#fff;font-size:12px;font-weight:600;cursor:pointer}
    .m102-btn.primary{background:#2563eb;border-color:#1d4ed8;color:#fff}
    .m102-progress{margin-top:12px;height:8px;background:#e2e8f0;border-radius:999px;overflow:hidden}
    .m102-progress b{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#2563eb);width:0%}
    .m102-mini{font-size:12px;color:#64748b}
    .mono{font-variant-numeric:tabular-nums;font-family:"Roboto Mono","D2Coding",monospace}
    .m102-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.m102-grid-2{grid-template-columns:1fr}}
    .m102-kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
    @media(max-width:600px){.m102-kv{grid-template-columns:1fr}}
    .m102-modal-body table{width:100%;border-collapse:separate;border-spacing:0}
    .m102-modal-body thead th{background:#f8fafc;font-weight:700;padding:6px 8px;text-align:left;font-size:12px}
    .m102-modal-body td{border-bottom:1px solid #e5e7eb;padding:6px 8px;font-size:12px}
  `;
  document.head.appendChild(css);

  const COMPLEX = ['ÎûòÎØ∏ÏïàA','Ìë∏Î•¥ÏßÄÏò§B','ÏûêÏù¥C','ÌûêÏä§D','ÏïÑÏù¥ÌååÌÅ¨E'];
  const UTILS = ['Ï†ÑÍ∏∞','ÏàòÎèÑ','Í∞ÄÏä§','Ïó¥Îüâ'];
  const DONG = [101,102,103,104,105,106];
  const HO = [101,102,201,202,301,302,401,402];
  const STAFFS = ['ÍπÄÎã¥Îãπ','Ïù¥Ï£ºÎ¨¥','Î∞ïÍ∏∞ÏÇ¨','ÏµúÍ¥ÄÎ¶¨','Ï†ïÏö¥ÏòÅ'];
  const BATCHES = ['1Ï∞®','2Ï∞®','3Ï∞®'];
  const TEAM_BY_STAFF = {'ÍπÄÎã¥Îãπ':'ÌïúÍ∞ïÌåÄ','Ïù¥Ï£ºÎ¨¥':'Î∂ÅÎ∂ÄÌåÄ','Î∞ïÍ∏∞ÏÇ¨':'ÏÑúÎ∂ÄÌåÄ','ÏµúÍ¥ÄÎ¶¨':'ÎèôÎ∂ÄÌåÄ','Ï†ïÏö¥ÏòÅ':'Î∂ÅÎ∂ÄÌåÄ'};
  const TEAMS = Array.from(new Set(Object.values(TEAM_BY_STAFF)));

  const z = n => (''+n).padStart(2,'0');
  const fmt = d => {
    try{
      if(!(d instanceof Date)) d = new Date(d);
      if(Number.isNaN(d.getTime())) return String(d);
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
    }catch(err){
      return String(d);
    }
  };
  const esc = str => String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

  function gen(n=96){
    const now = Date.now();
    const out=[];
    for(let i=0;i<n;i++){
      const util = UTILS[i%UTILS.length];
      const cx = COMPLEX[i%COMPLEX.length];
      const dong = DONG[i%DONG.length];
      const ho = HO[i%HO.length];
      const staff = STAFFS[i%STAFFS.length];
      out.push({
        id: (util==='Ï†ÑÍ∏∞'?'E':util==='ÏàòÎèÑ'?'W':util==='Í∞ÄÏä§'?'G':'H')+'-'+(100100+i),
        complex: cx,
        dong,
        ho,
        util,
        dt: new Date(now - (i+2)*3600e3),
        val: 1000 + ((i*7)%320) + i,
        photo: (i%10===0?'Ïû¨Ï¥¨ÏòÅ':(i%6===0?'Î≥¥Î•ò':'Í≤ÄÏ¶ù')),
        gps: (i%3)!==0,
        qual: ['A','A','B','A','A','B','A','C','A','B'][i%10],
        memo: (i%13===0?'Í≥ÑÎüâÍ∏∞Ìï® Ïû†ÍπÄ':(i%11===0?'ÏÇ¨ÏßÑ Ïû¨Ï¥¨ÏòÅ ÏöîÏ≤≠':'')),
        staff,
        team: TEAM_BY_STAFF[staff],
        batch: BATCHES[i%BATCHES.length],
        rechk: (i%6===0?'ÏöîÏ≤≠':(i%10===0?'Ìï¥Ï†ú':''))
      });
    }
    return out;
  }

  const STATE = {
    data: gen(96),
    filters: { q:'', util:'', complex:'', dong:'', ho:'', staff:'', batch:'', rechk:'' },
    logs: {
      ops: [
        { tag:'ok', msg:'Ï¥àÍ∏∞ ÎèôÍ∏∞Ìôî ÏôÑÎ£å', time:new Date(Date.now()-7200e3) },
        { tag:'ok', msg:'ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú ÏôÑÎ£å(5Í±¥)', time:new Date(Date.now()-5400e3) }
      ],
      rechk: [
        { tag:'rechk', msg:'E-100118 Ïû¨Í≤ÄÏπ® ÏöîÏ≤≠', time:new Date(Date.now()-3600e3) }
      ]
    }
  };

  let CURRENT_HOST = null;
  let CURRENT_SECTION = null;
  let mounted = false;

  function ensureHost(){
    let host = document.querySelector('.vpage[data-vpage="MTR-102"]');
    if(!host){
      const vc = document.querySelector('.vcontent');
      if(!vc) return null;
      host = document.createElement('div');
      host.className = 'vpage';
      host.setAttribute('data-vpage','MTR-102');
      vc.appendChild(host);
    }
    return host;
  }

  function getRows(){
    const f = STATE.filters;
    const q = (f.q||'').trim().toLowerCase();
    return STATE.data.filter(row=>{
      if(q){
        const key = (row.id+' '+row.complex+' '+row.dong+' '+row.ho+' '+(row.memo||'')).toLowerCase();
        if(!key.includes(q)) return false;
      }
      if(f.util && row.util!==f.util) return false;
      if(f.complex && row.complex!==f.complex) return false;
      if(f.dong && String(row.dong)!==f.dong) return false;
      if(f.ho && String(row.ho)!==f.ho) return false;
      if(f.staff && row.staff!==f.staff) return false;
      if(f.batch && row.batch!==f.batch) return false;
      if(f.rechk && row.rechk!==f.rechk) return false;
      return true;
    });
  }

  function unique(key){
    const set = new Set();
    STATE.data.forEach(row=>{
      const val = key==='dong' || key==='ho' ? String(row[key]) : row[key];
      if(val!==undefined && val!==null && val!=='') set.add(String(val));
    });
    const arr = Array.from(set);
    if(key==='dong' || key==='ho') arr.sort((a,b)=>Number(a)-Number(b)); else arr.sort();
    return arr;
  }

  function buildOptions(values, current, placeholder){
    const opts = [`<option value="">${placeholder}</option>`];
    values.forEach(v=>{
      const val = esc(v);
      const sel = current===v ? ' selected' : '';
      opts.push(`<option value="${val}"${sel}>${val}</option>`);
    });
    return opts.join('');
  }

  function toolbarHTML(){
    const f = STATE.filters;
    const utilOpts = buildOptions(unique('util'), f.util, 'Ïú†Ìã∏Î¶¨Ìã∞ Ï†ÑÏ≤¥');
    const cxOpts = buildOptions(unique('complex'), f.complex, 'Îã®ÏßÄ Ï†ÑÏ≤¥');
    const dongOpts = buildOptions(unique('dong'), f.dong, 'Îèô Ï†ÑÏ≤¥');
    const hoOpts = buildOptions(unique('ho'), f.ho, 'Ìò∏ Ï†ÑÏ≤¥');
    const staffOpts = buildOptions(unique('staff'), f.staff, 'Îã¥ÎãπÏûê Ï†ÑÏ≤¥');
    const batchOpts = buildOptions(unique('batch'), f.batch, 'Î∞∞Ïπò Ï†ÑÏ≤¥');
    const rechkOpts = buildOptions(unique('rechk'), f.rechk, 'Ïû¨Í≤ÄÏπ® Ï†ÑÏ≤¥');
    return `
      <div class="m102-toolbar">
        <input class="m102-input" id="m102-q" placeholder="Í≥ÑÎüâÍ∏∞ID/Ï£ºÏÜå/Î©îÎ™® Í≤ÄÏÉâ" value="${esc(f.q)}" />
        <select class="m102-input" id="m102-util">${utilOpts}</select>
        <select class="m102-input" id="m102-complex">${cxOpts}</select>
        <select class="m102-input" id="m102-dong">${dongOpts}</select>
        <select class="m102-input" id="m102-ho">${hoOpts}</select>
        <select class="m102-input" id="m102-staff">${staffOpts}</select>
        <select class="m102-input" id="m102-batch">${batchOpts}</select>
        <select class="m102-input" id="m102-rechk">${rechkOpts}</select>
      </div>
    `;
  }

  function kpiHTML(rows){
    const total = rows.length;
    const verified = rows.filter(r=>r.photo==='Í≤ÄÏ¶ù').length;
    const pct = total ? Math.round(verified/total*100) : 0;
    const lastRow = rows.slice().sort((a,b)=>b.dt - a.dt)[0];
    const lastText = lastRow ? fmt(lastRow.dt) : '-';
    const rechkCnt = rows.filter(r=>r.rechk==='ÏöîÏ≤≠').length;
    const teamStats = TEAMS.map(team=>{
      const subset = rows.filter(r=>r.team===team);
      const ok = subset.filter(r=>r.photo==='Í≤ÄÏ¶ù').length;
      const p = subset.length ? Math.round(ok/subset.length*100) : 0;
      return { team, ok, total:subset.length, pct:p };
    });
    return `
      <section class="m102-card">
        <div class="m102-kpi-grid">
          <article class="m102-kpi" data-kpi="photo">
            <div class="m102-ring" style="--p:${pct}"><span>${pct}%</span></div>
            <div>
              <h6>ÏÇ¨ÏßÑ Í≤ÄÏ¶ùÎ•†</h6>
              <div class="m102-kpi-main">${pct}%</div>
              <div class="m102-muted">Ï¥ù ${total}Í±¥ Ï§ë Í≤ÄÏ¶ù ${verified}Í±¥</div>
            </div>
          </article>
          <article class="m102-kpi" data-kpi="last">
            <div>
              <h6>ÏµúÍ∑º ÏûÖÎ†•ÏãúÍ∞Å</h6>
              <div class="m102-kpi-main">${esc(lastText)}</div>
              <div class="m102-muted">Í∞ÄÏû• ÏµúÍ∑º ÏûÖÎ†•</div>
            </div>
          </article>
          <article class="m102-kpi" data-kpi="rechk">
            <div>
              <h6>Ïû¨Í≤ÄÏπ® ÏöîÏ≤≠</h6>
              <div class="m102-kpi-main">${rechkCnt}Í±¥</div>
              <div class="m102-muted">ÏµúÍ∑º 24ÏãúÍ∞Ñ Í∏∞Ï§Ä</div>
            </div>
          </article>
          <article class="m102-kpi" data-kpi="teams">
            <div>
              <h6>Îã¥ÎãπÎ∂ÄÏÑú Ï≤òÎ¶¨ÌòÑÌô©</h6>
              <div class="m102-bar-list">
                ${teamStats.map(t=>`<div class="row"><div class="m102-bar"><b style="width:${t.pct}%"></b></div><span class="m102-muted">${t.pct}%</span></div>`).join('')}
              </div>
            </div>
          </article>
        </div>
      </section>
    `;
  }

  function tableHTML(rows){
    const body = rows.length ? rows.map(r=>{
      const photo = r.photo==='Í≤ÄÏ¶ù' ? '<span class="m102-tag ok">Í≤ÄÏ¶ù</span>' : (r.photo==='Î≥¥Î•ò' ? '<span class="m102-tag warn">Î≥¥Î•ò</span>' : '<span class="m102-tag bad">Ïû¨Ï¥¨ÏòÅ</span>');
      const gps = r.gps ? '<span class="m102-tag ok">GPS</span>' : '<span class="m102-tag">ÏóÜÏùå</span>';
      const qcls = r.qual==='A' ? 'm102-qflag a' : r.qual==='B' ? 'm102-qflag b' : 'm102-qflag c';
      const qflag = `<span class="${qcls}"><span class="dot"></span><span>${esc(r.qual)}</span></span>`;
      const memo = r.memo ? esc(r.memo) : '';
      return `
        <tr data-id="${esc(r.id)}">
          <td><b>${esc(r.id)}</b></td>
          <td>${esc(r.complex)} ${esc(r.dong)}/${esc(r.ho)}</td>
          <td>${esc(r.util)}</td>
          <td class="mono">${fmt(r.dt)}</td>
          <td class="mono">${r.val.toLocaleString()}</td>
          <td>${photo}</td>
          <td>${gps}</td>
          <td>${qflag}</td>
          <td>${memo}<span class="m102-inline-actions"><a href="#" data-act="rechk">Ïû¨Í≤ÄÏπ®</a><a href="#" data-act="photook">ÏÇ¨ÏßÑÌôïÏ†ï</a><a href="#" data-act="gpstoggle">GPS</a></span></td>
        </tr>
      `;
    }).join('') : '<tr><td class="m102-empty" colspan="9">Ï°∞Í±¥Ïóê ÎßûÎäî Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
    return `
      <section class="m102-card">
        <div class="m102-table-wrap">
          <table class="m102-table">
            <thead>
              <tr>
                <th>Í≥ÑÎüâÍ∏∞ID</th>
                <th>Îã®ÏßÄ/Îèô/Ìò∏</th>
                <th>Ïú†Ìã∏Î¶¨Ìã∞</th>
                <th>Í≤ÄÏπ®ÏãúÍ∞Å</th>
                <th>ÏûÖÎ†•Í∞í</th>
                <th>ÏÇ¨ÏßÑ</th>
                <th>GPS</th>
                <th>ÌíàÏßà</th>
                <th>Î©îÎ™® / ÏûëÏóÖ</th>
              </tr>
            </thead>
            <tbody id="m102-tbody">${body}</tbody>
          </table>
        </div>
      </section>
    `;
  }

  function logsHTML(){
    return `
      <section class="m102-card m102-logs-card">
        <header>Ïù¥Î≤§Ìä∏/Î°úÍ∑∏</header>
        <div class="m102-log-columns">
          <div>
            <div class="pill-mini">ÏûëÏóÖ Î°úÍ∑∏</div>
            <div id="m102-log-ops" class="m102-logbox"></div>
          </div>
          <div>
            <div class="pill-mini">Ïû¨Í≤ÄÏπ® Î°úÍ∑∏</div>
            <div id="m102-log-rechk" class="m102-logbox"></div>
          </div>
        </div>
      </section>
    `;
  }

  function renderLogs(section){
    if(!section) return;
    const opsBox = section.querySelector('#m102-log-ops');
    const rechkBox = section.querySelector('#m102-log-rechk');
    if(opsBox){
      opsBox.innerHTML = STATE.logs.ops.map(entry=>`<div class="item"><span class="k ok">${entry.tag.toUpperCase()}</span><span class="time mono">${fmt(entry.time)}</span><span>${esc(entry.msg)}</span></div>`).join('');
      opsBox.scrollTop = opsBox.scrollHeight;
    }
    if(rechkBox){
      rechkBox.innerHTML = STATE.logs.rechk.map(entry=>`<div class="item"><span class="k ${entry.tag==='rechk'?'rechk':'ok'}">${entry.tag.toUpperCase()}</span><span class="time mono">${fmt(entry.time)}</span><span>${esc(entry.msg)}</span></div>`).join('');
      rechkBox.scrollTop = rechkBox.scrollHeight;
    }
  }

  function addLog(kind, tag, msg){
    const target = kind==='rechk' ? STATE.logs.rechk : STATE.logs.ops;
    target.push({ tag, msg, time:new Date() });
    if(target.length>120) target.shift();
    if(CURRENT_SECTION){
      setTimeout(()=>renderLogs(CURRENT_SECTION),0);
    }
  }

  function openModal(title, bodyHTML, actions, onClose){
    const back = document.createElement('div');
    back.className = 'm102-modal-back';
    back.innerHTML = `
      <div class="m102-modal" role="dialog" aria-modal="true">
        <header class="m102-modal-head"><h5>${esc(title)}</h5><button type="button" class="m102-btn" id="m102-modal-close">Îã´Í∏∞</button></header>
        <div class="m102-modal-body">${bodyHTML}</div>
        <div class="m102-modal-actions"></div>
      </div>`;
    document.body.appendChild(back);
    const modal = back.querySelector('.m102-modal');
    const closeBtn = modal.querySelector('#m102-modal-close');
    const foot = modal.querySelector('.m102-modal-actions');
    const close = ()=>{
      if(onClose) onClose();
      back.remove();
    };
    closeBtn.addEventListener('click', close);
    back.addEventListener('click', (e)=>{ if(e.target===back) close(); });
    (actions||[]).forEach(action=>{
      const btn = document.createElement('button');
      btn.className = 'm102-btn'+(action.primary?' primary':'');
      btn.textContent = action.text;
      btn.addEventListener('click', ()=> action.onClick?.(close, modal));
      foot.appendChild(btn);
    });
    return { close, modal };
  }

  function bindFilters(section){
    const map = [
      ['#m102-q','q','input'],
      ['#m102-util','util','change'],
      ['#m102-complex','complex','change'],
      ['#m102-dong','dong','change'],
      ['#m102-ho','ho','change'],
      ['#m102-staff','staff','change'],
      ['#m102-batch','batch','change'],
      ['#m102-rechk','rechk','change']
    ];
    map.forEach(([sel,key,evt])=>{
      const el = section.querySelector(sel);
      if(!el) return;
      el.value = STATE.filters[key] || '';
      el.addEventListener(evt, ()=>{
        STATE.filters[key] = el.value || '';
        draw();
      });
    });
  }

  function bindHeaderButtons(section){
    section.querySelector('#m102-upload')?.addEventListener('click',()=>{
      const { close, modal } = openModal('ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú', `
        <div class="m102-mini">Ïó¨Îü¨ Ïû•Ïùò ÏÇ¨ÏßÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî (Î™©ÏóÖ)</div>
        <input id="m102-filepick" type="file" multiple accept="image/*" class="m102-input" style="width:100%;margin-top:8px" />
        <div id="m102-fileinfo" class="m102-mini" style="margin-top:8px">0Í∞úÏùò ÌååÏùº ÏÑ†ÌÉùÎê®</div>
      `,[
        { text:'ÏóÖÎ°úÎìú', primary:true, onClick:(closeFn, mdl)=>{
            const count = mdl.querySelector('#m102-filepick')?.files?.length || 0;
            addLog('ops','ok',`ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú ÏôÑÎ£å(${count}Í±¥)`);
            closeFn();
          }
        }
      ]);
      modal.querySelector('#m102-filepick')?.addEventListener('change',(e)=>{
        const n = e.target.files ? e.target.files.length : 0;
        const info = modal.querySelector('#m102-fileinfo');
        if(info) info.textContent = `${n}Í∞úÏùò ÌååÏùº ÏÑ†ÌÉùÎê®`;
      });
    });

    section.querySelector('#m102-gps')?.addEventListener('click',()=>{
      const lat = (37.45 + Math.random()*0.6).toFixed(6);
      const lon = (126.8 + Math.random()*0.6).toFixed(6);
      const target = getRows();
      openModal('GPS Ï∫°Ï≤ò', `
        <div class="m102-grid-2">
          <div class="m102-kv"><div>ÏúÑÎèÑ</div><div class="mono">${lat}</div></div>
          <div class="m102-kv"><div>Í≤ΩÎèÑ</div><div class="mono">${lon}</div></div>
        </div>
        <div class="m102-mini" style="margin-top:8px">ÌòÑÏû¨ Ï¢åÌëúÎ•º ÌïÑÌÑ∞ Í≤∞Í≥º ${target.length}Í±¥Ïóê Ï†ÅÏö©Ìï©ÎãàÎã§.</div>
      `,[
        { text:'Ï¢åÌëú Ï†ÅÏö©', primary:true, onClick:(closeFn)=>{
            target.forEach(row=> row.gps = true);
            addLog('ops','ok',`GPS Ï¢åÌëú Ï†ÅÏö©(${target.length}Í±¥)`);
            draw();
            closeFn();
          }
        }
      ]);
    });

    section.querySelector('#m102-save')?.addEventListener('click',()=>{
      const target = getRows();
      openModal('ÏùºÍ¥Ñ Ï†ÄÏû•', `<div class="m102-mini">ÌòÑÏû¨ ÌëúÏãúÎêú ${target.length}Í±¥ÏùÑ Ï†ÄÏû•Ìï©ÎãàÎã§.</div>`,[
        { text:'Ï†ÄÏû•', primary:true, onClick:(closeFn)=>{
            addLog('ops','ok',`ÏùºÍ¥Ñ Ï†ÄÏû• ÏôÑÎ£å(${target.length}Í±¥)`);
            closeFn();
          }
        }
      ]);
    });

    section.querySelector('#m102-csv')?.addEventListener('click',()=>{
      const { close, modal } = openModal('CSV Í∞ÄÏ†∏Ïò§Í∏∞', `
        <div class="m102-mini">CSV Î∂ôÏó¨ÎÑ£Í∏∞ (ÌòïÏãù: <b>id,value</b>)</div>
        <textarea id="m102-csv-text" class="m102-input" style="width:100%;height:160px;margin-top:8px"></textarea>
      `,[
        { text:'Ï†ÅÏö©', primary:true, onClick:(closeFn, mdl)=>{
            const txt = mdl.querySelector('#m102-csv-text')?.value || '';
            let cnt = 0;
            txt.trim().split(/
?
/).forEach(line=>{
              const [id,val] = line.split(',').map(s=>s && s.trim());
              const row = STATE.data.find(r=>r.id===id);
              if(row && val && !Number.isNaN(+val)){
                row.val = Number(val);
                cnt++;
              }
            });
            addLog('ops','ok',`CSV Ï†ÅÏö©: ${cnt}Í±¥ ÏóÖÎç∞Ïù¥Ìä∏`);
            draw();
            closeFn();
          }
        }
      ]);
    });

    section.querySelector('#m102-sync')?.addEventListener('click',()=>{
      let timer;
      const { close, modal } = openModal('Ïò§ÌîÑÎùºÏù∏ ÎèôÍ∏∞Ìôî', `
        <div class="m102-mini">Ïò§ÌîÑÎùºÏù∏ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Ï§ë...</div>
        <div class="m102-progress"><b id="m102-sync-bar"></b></div>
      `,[
        { text:'Îã´Í∏∞', onClick:(closeFn)=>{ closeFn(); } }
      ], ()=>{ if(timer) clearInterval(timer); });
      const bar = modal.querySelector('#m102-sync-bar');
      let p = 0;
      timer = setInterval(()=>{
        p = Math.min(100, p+10);
        if(bar) bar.style.width = p+'%';
        if(p===100){
          clearInterval(timer);
          addLog('ops','ok','Ïò§ÌîÑÎùºÏù∏ ÎèôÍ∏∞Ìôî ÏôÑÎ£å');
        }
      },180);
    });
  }

  function bindKpis(section){
    section.querySelectorAll('.m102-kpi').forEach(card=>{
      card.addEventListener('click',()=>{
        const type = card.getAttribute('data-kpi');
        const rows = getRows();
        if(type==='photo'){
          const html = `
            <div class="m102-grid-2">
              ${UTILS.map(util=>{
                const subset = rows.filter(r=>r.util===util);
                const ok = subset.filter(r=>r.photo==='Í≤ÄÏ¶ù').length;
                const pct = subset.length ? Math.round(ok/subset.length*100) : 0;
                return `<div class="m102-kv"><div>${util}</div><div><div class="m102-progress"><b style="width:${pct}%"></b></div><div class="m102-mini" style="margin-top:6px">${pct}% ¬∑ ${ok}/${subset.length}</div></div></div>`;
              }).join('')}
            </div>`;
          openModal('ÏÇ¨ÏßÑ Í≤ÄÏ¶ùÎ•† ÏÉÅÏÑ∏', html,[{ text:'ÌôïÏù∏', primary:true, onClick:close=>close() }]);
        }
        if(type==='last'){
          const items = rows.slice().sort((a,b)=>b.dt-a.dt).slice(0,12);
          const html = `
            <table class="mini">
              <thead><tr><th style="text-align:left;padding:6px">Í≥ÑÎüâÍ∏∞ID</th><th style="text-align:left;padding:6px">ÏúÑÏπò</th><th style="text-align:left;padding:6px">ÏãúÍ∞Ñ</th></tr></thead>
              <tbody>
                ${items.map(r=>`<tr><td class="mono" style="padding:6px">${esc(r.id)}</td><td style="padding:6px">${esc(r.complex)} ${esc(r.dong)}/${esc(r.ho)}</td><td class="mono" style="padding:6px">${fmt(r.dt)}</td></tr>`).join('')}
              </tbody>
            </table>`;
          openModal('ÏµúÍ∑º ÏûÖÎ†• ÏÉÅÏÑ∏', html,[{ text:'ÌôïÏù∏', primary:true, onClick:close=>close() }]);
        }
        if(type==='rechk'){
          const bad = rows.filter(r=>r.rechk==='ÏöîÏ≤≠');
          const html = bad.length ? `<div class="m102-mini">Ïû¨Í≤ÄÏπ® ÏöîÏ≤≠ ${bad.length}Í±¥</div><div style="max-height:320px;overflow:auto;margin-top:8px">${bad.map(r=>`<div class="m102-kv"><div class="mono">${esc(r.id)}</div><div>${esc(r.complex)} ${esc(r.dong)}/${esc(r.ho)} ¬∑ ${fmt(r.dt)}</div></div>`).join('')}</div>` : '<div class="m102-mini">Ïû¨Í≤ÄÏπ® ÏöîÏ≤≠ Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
          openModal('Ïû¨Í≤ÄÏπ® ÏöîÏ≤≠ ÏÉÅÏÑ∏', html, bad.length ? [
            { text:'Î™®Îëê Ìï¥Ï†ú', primary:true, onClick:(closeFn)=>{
                bad.forEach(r=> r.rechk='Ìï¥Ï†ú');
                addLog('rechk','ok',`Ïû¨Í≤ÄÏπ® ÏöîÏ≤≠ ${bad.length}Í±¥ Ìï¥Ï†ú`);
                draw();
                closeFn();
              }
            }
          ] : [{ text:'ÌôïÏù∏', primary:true, onClick:close=>close() }]);
        }
        if(type==='teams'){
          const html = `<div class="m102-grid-2">${TEAMS.map(team=>{
            const subset = rows.filter(r=>r.team===team);
            const ok = subset.filter(r=>r.photo==='Í≤ÄÏ¶ù').length;
            const pct = subset.length ? Math.round(ok/subset.length*100) : 0;
            return `<div class="m102-kv"><div>${team}</div><div><div class="m102-progress"><b style="width:${pct}%"></b></div><div class="m102-mini" style="margin-top:6px">${pct}% ¬∑ ${ok}/${subset.length}</div></div></div>`;
          }).join('')}</div>`;
          openModal('Îã¥ÎãπÎ∂ÄÏÑú Ï≤òÎ¶¨ ÏÉÅÏÑ∏', html,[{ text:'ÌôïÏù∏', primary:true, onClick:close=>close() }]);
        }
      });
    });
  }

  function showRowModal(row){
    const history = Array.from({length:5}, (_,i)=>({ dt:new Date(row.dt - (i+1)*86400e3), val: row.val - (i+1)*((i%2?3:5)) }));
    const html = `
      <div class="m102-grid-2">
        <div>
          <div class="m102-kv"><div>Í≥ÑÎüâÍ∏∞ID</div><div class="mono">${esc(row.id)}</div></div>
          <div class="m102-kv"><div>ÏúÑÏπò</div><div>${esc(row.complex)} ${esc(row.dong)}/${esc(row.ho)}</div></div>
          <div class="m102-kv"><div>Ïú†Ìã∏Î¶¨Ìã∞</div><div>${esc(row.util)}</div></div>
          <div class="m102-kv"><div>Í≤ÄÏπ®ÏãúÍ∞Å</div><div class="mono">${fmt(row.dt)}</div></div>
          <div class="m102-kv"><div>ÏûÖÎ†•Í∞í</div><div class="mono">${row.val.toLocaleString()}</div></div>
          <div class="m102-kv"><div>Îã¥ÎãπÏûê</div><div>${esc(row.staff)} (${esc(row.team)})</div></div>
        </div>
        <div>
          <div class="m102-mini">ÏµúÍ∑º Ï∂îÏÑ∏</div>
          <table class="mini" style="margin-top:6px">
            <thead><tr><th style="text-align:left;padding:6px">ÎÇ†Ïßú</th><th style="text-align:right;padding:6px">Í∞í</th></tr></thead>
            <tbody>${history.map(h=>`<tr><td class="mono" style="padding:6px">${fmt(h.dt)}</td><td class="mono" style="padding:6px;text-align:right">${h.val.toLocaleString()}</td></tr>`).join('')}</tbody>
          </table>
        </div>
      </div>`;
    openModal('ÏÉÅÏÑ∏ Î≥¥Í∏∞', html,[
      { text:'GPS ÌÜ†Í∏Ä', onClick:(closeFn)=>{
          row.gps = !row.gps;
          addLog('ops','ok',`${row.id} GPS ${row.gps?'ÌôúÏÑ±Ìôî':'ÎπÑÌôúÏÑ±Ìôî'}`);
          draw();
        }
      },
      { text:'ÏÇ¨ÏßÑ Í≤ÄÏ¶ù', onClick:()=>{
          row.photo = 'Í≤ÄÏ¶ù';
          addLog('ops','ok',`${row.id} ÏÇ¨ÏßÑ Í≤ÄÏ¶ù ÏôÑÎ£å`);
          draw();
        }
      },
      { text:'Ïû¨Í≤ÄÏπ® ÏöîÏ≤≠', primary:true, onClick:(closeFn)=>{
          row.rechk = 'ÏöîÏ≤≠';
          addLog('rechk','rechk',`${row.id} Ïû¨Í≤ÄÏπ® ÏöîÏ≤≠`);
          draw();
          closeFn();
        }
      }
    ]);
  }

  function bindTable(section){
    const tbody = section.querySelector('#m102-tbody');
    if(!tbody) return;
    tbody.addEventListener('click',(e)=>{
      const link = e.target.closest('a[data-act]');
      const tr = e.target.closest('tr[data-id]');
      if(!tr) return;
      const id = tr.getAttribute('data-id');
      const row = STATE.data.find(r=>r.id===id);
      if(!row) return;
      if(link){
        e.preventDefault();
        const act = link.getAttribute('data-act');
        if(act==='rechk'){
          row.rechk = row.rechk==='ÏöîÏ≤≠' ? 'Ìï¥Ï†ú' : 'ÏöîÏ≤≠';
          addLog('rechk', row.rechk==='ÏöîÏ≤≠'?'rechk':'ok', `${row.id} Ïû¨Í≤ÄÏπ® ${row.rechk==='ÏöîÏ≤≠'?'ÏöîÏ≤≠':'Ìï¥Ï†ú'}`);
          draw();
        } else if(act==='photook'){
          row.photo = 'Í≤ÄÏ¶ù';
          addLog('ops','ok',`${row.id} ÏÇ¨ÏßÑ Í≤ÄÏ¶ù ÏôÑÎ£å`);
          draw();
        } else if(act==='gpstoggle'){
          row.gps = !row.gps;
          addLog('ops','ok',`${row.id} GPS ${row.gps?'ÌôúÏÑ±Ìôî':'ÎπÑÌôúÏÑ±Ìôî'}`);
          draw();
        }
        return;
      }
      showRowModal(row);
    });
  }

  function layoutHTML(rows){
    return `
      <section class="widget" id="MTR-102">
        <header class="m102-header">
          <h4>ÏàòÎèôÍ≤ÄÏπ® ÏûÖÎ†•(ÏÇ¨ÏßÑ¬∑GPS¬∑Ïò§ÌîÑÎùºÏù∏)</h4>
          <div class="m102-actions">
            <button class="m102-hbtn" id="m102-upload">ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú</button>
            <button class="m102-hbtn" id="m102-gps">GPS Ï∫°Ï≤ò</button>
            <button class="m102-hbtn" id="m102-save">ÏùºÍ¥Ñ Ï†ÄÏû•</button>
            <button class="m102-hbtn" id="m102-csv">CSV Í∞ÄÏ†∏Ïò§Í∏∞</button>
            <button class="m102-hbtn" id="m102-sync">Ïò§ÌîÑÎùºÏù∏ ÎèôÍ∏∞Ìôî</button>
          </div>
        </header>
        ${toolbarHTML()}
        ${kpiHTML(rows)}
        ${tableHTML(rows)}
        ${logsHTML()}
      </section>
    `;
  }

  function draw(){
    const host = ensureHost();
    if(!host) return;
    CURRENT_HOST = host;
    const rows = getRows();
    host.innerHTML = layoutHTML(rows);
    const section = host.querySelector('#MTR-102');
    CURRENT_SECTION = section;
    bindFilters(section);
    bindHeaderButtons(section);
    bindKpis(section);
    bindTable(section);
    renderLogs(section);
  }

  function mount(){
    draw();
    mounted = true;
  }

  document.addEventListener('click',(e)=>{
    const mid = e.target.closest && e.target.closest('.mid[data-mid="MTR-102"]');
    if(!mid) return;
    setTimeout(mount,0);
  },true);

  if(location.hash && location.hash.includes('MTR-102')){
    setTimeout(mount,0);
  }

  new MutationObserver(()=>{
    if(!mounted && ensureHost()) mount();
  }).observe(document.body,{childList:true,subtree:true});
})();
</script>

<!-- BEGIN: patch-mtr101-modal-actions-v2 -->
<script id="patch-mtr101-modal-actions-v2">
(function(){
  if (window.__MTR101_ACTIONS_PATCH_V2__) return; window.__MTR101_ACTIONS_PATCH_V2__ = true;

  function addLog(kind, tag, msg){
    try{
      var box = document.querySelector('#'+(kind==='recv'?'ami-log-recv':'ami-log-fault'));
      var div = document.createElement('div');
      div.className = 'item';
      var ts = new Date();
      function z(n){return (n<10?'0':'')+n}
      var tstr = ts.getFullYear()+'-'+z(ts.getMonth()+1)+'-'+z(ts.getDate())+' '+z(ts.getHours())+':'+z(ts.getMinutes())+':'+z(ts.getSeconds());
      div.innerHTML = '<span class="k '+tag+'">'+tag+'</span><span class="t">'+tstr+'</span><span>'+msg+'</span>';
      if (box){ box.appendChild(div); box.scrollTop = box.scrollHeight; }
      console.log('[AMI]', tag, msg);
    }catch(e){ console.warn('log append fail', e); }
  }

  function selectedCount(){
    try{
      if (window.__AMI_STATE__){
        var rows = (__AMI_STATE__.filtered && __AMI_STATE__.filtered.length ? __AMI_STATE__.filtered : (__AMI_STATE__.data || []));
        return (rows && rows.length) || 0;
      }
      var trs = document.querySelectorAll('.ami-table tbody tr');
      return trs ? trs.length : 0;
    }catch(e){ return 0; }
  }

  function showConfirm(title, bodyHTML){
    try{ if (typeof window.openModal === 'function'){ window.openModal(title, bodyHTML); return; } }catch(e){}
    var wrap = document.createElement('div');
    wrap.style.cssText = 'position:fixed;inset:0;display:grid;place-items:center;background:rgba(15,23,42,.35);z-index:99999';
    wrap.innerHTML = '<div style="width:min(520px,92vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.18);border:1px solid #e8edf4">'+
      '<div style="padding:12px 14px;border-bottom:1px solid #e8edf4;font-weight:800">'+title+'</div>'+
      '<div style="padding:14px;max-height:70vh;overflow:auto">'+bodyHTML+'</div>'+
      '<div style="display:flex;justify-content:flex-end;gap:8px;padding:10px 14px;border-top:1px solid #e8edf4">'+
        '<button id="ami-fix-close" class="iconbtn">ÌôïÏù∏</button>'+
      '</div></div>';
    document.body.appendChild(wrap);
    wrap.addEventListener('click', function(e){ if(e.target.id==='ami-fix-close' || e.target===wrap) wrap.remove(); }, true);
  }

  document.addEventListener('click', function(e){
    var retry = e.target && e.target.closest && e.target.closest('#ami-fix-retry-ok');
    var insp  = e.target && e.target.closest && e.target.closest('#ami-fix-insp-ok');
    if(!retry && !insp) return;
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    var n = selectedCount();
    if(retry){
      showConfirm('Ïû¨ÏàòÏã† ÏöîÏ≤≠', 'ÏÑ†ÌÉù/ÌïÑÌÑ∞ Í∏∞Ï§Ä Ï¥ù <b>'+n+'</b>Í±¥Ïóê Ïû¨ÏàòÏã† ÏöîÏ≤≠ÏùÑ Ï†ÑÏÜ°ÌñàÏäµÎãàÎã§.');
      addLog('recv', 'ACTION', 'ÏÑ†ÌÉù/ÌïÑÌÑ∞ Í∏∞Ï§Ä Ï¥ù '+n+'Í±¥Ïóê Ïû¨ÏàòÏã† ÏöîÏ≤≠ÏùÑ Ï†ÑÏÜ°ÌñàÏäµÎãàÎã§.');
    }else if(insp){
      showConfirm('Ïû•Ïπò Ï†êÍ≤ÄÏöîÏ≤≠', 'ÏÑ†ÌÉù/ÌïÑÌÑ∞ Í∏∞Ï§Ä Ï¥ù <b>'+n+'</b>Í±¥Ïóê Ï†êÍ≤Ä ÏöîÏ≤≠ÏùÑ Ï†ÑÏÜ°ÌñàÏäµÎãàÎã§.');
      addLog('recv', 'ACTION', 'ÏÑ†ÌÉù/ÌïÑÌÑ∞ Í∏∞Ï§Ä Ï¥ù '+n+'Í±¥Ïóê Ï†êÍ≤Ä ÏöîÏ≤≠ÏùÑ Ï†ÑÏÜ°ÌñàÏäµÎãàÎã§.');
    }
  }, true);
})();
</script>
<!-- END: patch-mtr101-modal-actions-v2 -->

</body>
</html>
